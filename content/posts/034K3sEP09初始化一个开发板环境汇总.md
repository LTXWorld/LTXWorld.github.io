+++
date = '2025-05-14T09:37:37+08:00'
title = 'K3sEP09â€”â€”åˆå§‹åŒ–å¼€å‘æ¿ç¯å¢ƒæ“ä½œæ±‡æ€»'
categories = ["äº‘è®¡ç®—"]
tags = ["K3s","Linuxæ“ä½œ","RiscV"]
+++

## å‰ç»

æœ¬æ–‡ä¸ºäº†æ€»ç»“åœ¨æ‹¿åˆ°ä¸€ä¸ªæ–°çš„å¼€å‘æ¿åå…·ä½“è¯¥å¦‚ä½•æ“ä½œ,åŒ…æ‹¬çƒ§å½•é•œåƒ,é…ç½® k3s æ‰€éœ€ç¯å¢ƒç­‰æ“ä½œ.

## çƒ§å½•é•œåƒ

å…³äºçƒ§å½•æ“ä½œ,æ— éœ€å¤šè¨€,è¯·å…³æ³¨è¿™ç¯‡[æ–‡ç« ](https://www.bfsmlt.top/posts/003li_riscv01/).æœ¬æ–‡ä¸»è¦è¯´ä¸€ä¸‹é•œåƒé—®é¢˜.

åœ¨é€‰æ‹© OS é•œåƒçš„æ—¶å€™,ç”±äº riscv çš„å®éªŒæ€§,å¾€å¾€åœ¨é˜¿é‡Œäº‘ã€æ¸…åæºç­‰çŸ¥åé•œåƒæºå¹¶æ²¡æœ‰æä¾›,é€šå¸¸æ˜¯ä¸­ç§‘é™¢è‡ªå·±çš„é•œåƒæº,è€Œæœ‰æ—¶æœ‰äº›é•œåƒå¹¶æ²¡æœ‰è¿›è¡Œç¨³å®šçš„ç»´æŠ¤;
ç”šè‡³æœ‰çš„é•œåƒè´¨é‡å¹¶ä¸å¥½,ä¾‹å¦‚ openEuler24 LTS ç«Ÿç„¶ä¸æä¾› wifi æ¨¡å—.ğŸ˜‡

æ‰€ä»¥ç»è¿‡æˆ‘çš„å¤šæ¬¡å°è¯•(é‡æ–°çƒ§å½•é•œåƒé…ç½®ç¯å¢ƒçš„æŠ˜ç£¨)æˆ‘æ‰¾åˆ°äº†ä¸€æ¬¾é€‚åˆå®éªŒç¨³å®š(æš‚æ—¶ç¨³å®š)æ“ä½œçš„ OS é•œåƒ,[RevyOS](https://docs.revyos.dev/)

å…¶é€‚é…äº† LicheePi 4A å’Œ Milk-V Meles æ­£å¥½éƒ½æ˜¯æˆ‘æ‰‹ä¸Šæœ‰çš„è®¾å¤‡;è™½ç„¶åŒæ ·ä½¿ç”¨çš„æ˜¯ä¸­ç§‘é™¢çš„é•œåƒç®¡ç†,ä½†æ˜¯æ®æˆ‘åœ¨å…¶ github é¡µé¢çš„è§‚å¯Ÿ,å…¶ issue çš„æ—¶é—´åœ¨æœ€è¿‘è¾ƒå¤š,å›å¤ä¹Ÿè›®åŠæ—¶;
åŒæ—¶ ChangeLog ä¹Ÿæœ‰ç¨³å®šçš„æ›´æ–°,æ•…ä»¥æ­¤ä¸ºåç»­çš„å®éªŒé•œåƒ.

## ç¯å¢ƒæ­å»º

ä¸æˆ‘ä»¬ä¹‹å‰æƒ³çš„ä¸€æ ·,å°±åƒå®å¡”è¿™æ ·çš„è½¯ä»¶æä¾›äº†ä¸€é”®éƒ¨ç½²,ä¸€é”®é…ç½®è¿™æ ·çš„æ“ä½œ,è¿™å¯¹é‡æ–°æ„å»ºä¸€ä¸ªå¼€å‘æ¿ä¸Šçš„ç³»ç»Ÿæ¥è¯´çœŸçš„æ˜¯å¾ˆæ–¹ä¾¿;æœ‰æœºä¼šæˆ‘ä»¬å¯ä»¥æŠŠä¸‹é¢çš„æ“ä½œå…¨éƒ¨æ”¾åœ¨ä¸€ä¸ªè„šæœ¬ä¸­,ä¹Ÿåšåˆ°ä¸€é”®æ“ä½œ.

åœ¨[ç¬¬äºŒç¯‡æ–‡ç« ](https://www.bfsmlt.top/posts/004risc-v_deployment/)ä¸­æˆ‘ä»¬è¯´è¿‡äº†å¦‚ä½•é…ç½®é€‚åˆå®¹å™¨çš„ OS ç¯å¢ƒ, ä½†æ˜¯åé¢åœ¨å®éªŒä¸­è¿˜æ˜¯é‡åˆ°äº†äº›é—®é¢˜,æ‰€ä»¥è¿™é‡Œé‡æ–°æ±‡æ€»ä¸€ä¸‹.(å¹¶ä¸”åœ¨å®éªŒè¿‡ç¨‹ä¸­æœ¬æ–‡ä¼šä¸€ç›´æ›´æ–°)

### æ›´æ”¹ DNS é…ç½®

å¦‚æœä½ çš„ DNS æœåŠ¡å™¨åœ°å€æ— æ³•æ­£ç¡®è§£æ,è¯·ä¿®æ”¹ DNS è®¾ç½®ä¸º `8.8.8.8,1.1.1.1`ç­‰é™æ€å…¬ç”¨åœ°å€

```bash
# æ¢æˆè‡ªå·±çš„ç½‘ç»œåç§°
sudo nmcli connection modify "niuma"   ipv4.ignore-auto-dns yes   ipv4.dns "8.8.8.8 1.1.1.1"
# é‡å¯è¿æ¥
sudo nmcli connection down "niuma" && nmcli connection up "niuma"
```

### Apt

æˆªæ­¢2025.05.13,ä¸­ç§‘é™¢ä»“åº“å­˜åœ¨ KEY è¿‡æœŸé—®é¢˜,å®˜æ–¹ç»™å‡ºäº†[è§£å†³æ–¹æ¡ˆ](https://github.com/revyos/revyos/issues/125)

æˆ‘é‡‡ç”¨çš„æ˜¯ ChatGPT ç»™å‡ºçš„æ–¹æ¡ˆ,åœ¨æºåœ°å€å‰é¢åŠ ä¸Š`[trusted=yes]`,

`sudo vi /etc/apt/sources.list` æœ€ç»ˆç»“æœå¦‚ä¸‹:

```bash
deb [trusted=yes] https://fast-mirror.isrc.ac.cn/revyos/revyos-gles-21 revyos-gles-21 main
deb [trusted=yes] https://fast-mirror.isrc.ac.cn/revyos/revyos-addons revyos-addons main
deb [trusted=yes] https://fast-mirror.isrc.ac.cn/revyos/revyos-kernels revyos-kernels main
deb [trusted=yes] https://fast-mirror.isrc.ac.cn/revyos/revyos-base sid main
```

ä¹‹åå†è¿›è¡Œ apt æ“ä½œå°±å¯ä»¥äº†.(æ›´æ–°,åç»­è¿˜æ˜¯å»ºè®®ä½¿ç”¨å®˜æ–¹çš„è§£å†³æ–¹æ¡ˆ)

```bash
sudo sh -c 'gpg --keyserver keyserver.ubuntu.com --recv-keys 2FB3A9E77911527E && \
gpg --export 2FB3A9E77911527E > /etc/apt/trusted.gpg.d/revyos-keyring.gpg'
sudo apt update; sudo apt upgrade -y
```

### GCCç­‰æ„å»ºæ‰€éœ€å·¥å…·

æˆ‘ä»¬å†™ä¸€ä¸ªè„šæœ¬æ¥ä¸€é”®æ£€æµ‹å¹¶å®‰è£…å¯èƒ½æ‰€éœ€çš„å·¥å…·.

```bash
#!/bin/bash
set -e

echo "ğŸ” æ£€æµ‹å½“å‰ç³»ç»ŸåŒ…ç®¡ç†å™¨..."
if command -v apt >/dev/null 2>&1; then
    echo "âœ… ä½¿ç”¨ apt å®‰è£…ä¾èµ–..."
    sudo apt update
    sudo apt install -y \
        build-essential \
        make \
        gcc \
        git \
        curl \
        pkg-config \
        libseccomp-dev \
        btrfs-progs \
        iptables \
        libapparmor-dev \
        libgpgme-dev \
        libdevmapper-dev \
        libprotobuf-dev \
        protobuf-compiler \
        libnl-3-dev \
        libnl-route-3-dev \
        libnet-dev \
        libudev-dev \
        libsystemd-dev \
        libtool \
        autoconf \
        automake \
        rsync \
        unzip \
        zstd  \
        socat
elif command -v dnf >/dev/null 2>&1; then
    echo "âœ… ä½¿ç”¨ dnf å®‰è£…ä¾èµ–..."
    sudo dnf install -y \
        gcc \
        gcc-c++ \
        git \
        make \
        curl \
        pkgconf-pkg-config \
        libseccomp-devel \
        btrfs-progs-devel \
        iptables \
        libapparmor-devel \
        gpgme-devel \
        device-mapper-devel \
        protobuf-devel \
        protobuf-compiler \
        libnl3-devel \
        libnet-devel \
        systemd-devel \
        libudev-devel \
        libtool \
        autoconf \
        automake \
        rsync \
        unzip \
        socat
else
    echo "âŒ æ— æ³•è¯†åˆ«çš„åŒ…ç®¡ç†å™¨ï¼Œè¯·æ‰‹åŠ¨å®‰è£…ä¾èµ–ã€‚"
    exit 1
fi

echo "âœ… æ‰€æœ‰ä¾èµ–å®‰è£…å®Œæ¯•ã€‚ä½ ç°åœ¨å¯ä»¥æ„å»º K3sã€‚"
```

æ­¤è„šæœ¬æ¥è‡ªäº ChatGPT.

### Git

apt å®‰è£… Git,å¹¶é…ç½®é•œåƒåœ°å€

```bash
git config --global url."https://gh-proxy.com/github.com/" .insteadOf "https://github.com/"
cat .gitconfig
```

å¾—åˆ°æˆ‘ä»¬æ‰€é…ç½®çš„åœ°å€å³ä¸ºæ­£ç¡®.

### Docker

ç¬¬ä¸€ç§å®‰è£…æ–¹å¼:

```bash
sudo apt install docker.io
sudo usermod -aG docker $USER
```

å¦‚æœè¿™ç§ä¸è¡Œ,è¯·ä½¿ç”¨è¿™ç§:(åé¢çš„åŠ å…¥ root ç»„æ“ä½œæ˜¯ç›¸åŒçš„)

```bash
sudo apt-get install docker docker-compose
sudo groupadd docker
sudo usermod -aG docker $USER
newgrp docker
```

æœ€ç»ˆæ‰§è¡Œ `docker images hello-world` æ£€æµ‹æ˜¯å¦æˆåŠŸ.

é…ç½®ä»£ç†é•œåƒ:()

```bash
# ä¿®æ”¹
vi /etc/docker/daemon.json
# å¦‚æœæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œè‡ªå·±æ‰‹åŠ¨æ–°å»ºï¼ˆæˆ‘å½“æ—¶åªæœ‰ä¸€ä¸ªkey.jsonæ–‡ä»¶ï¼‰
# å°†ä¸‹é¢å†…å®¹å¤åˆ¶è¿›å»
{
      "registry-mirrors": [
        "https://docker.1ms.run",
        "https://docker.linkedbus.com"
    ]
}

# åŠ è½½é…ç½®å¹¶é‡å¯
sudo systemctl daemon-reload
sudo systemctl restart docker
# å°è¯•æ‹‰å–é•œåƒ
docker pull busybox
docker run hello-world
```

æ³¨æ„,è¿™é‡Œçš„ä»£ç†æ˜¯å¯¹ dockerhub çš„ä»£ç†;ä¸ä¼šå½±å“åˆ°æˆ‘ä»¬çš„ç§æœ‰ä»“åº“. ğŸ¥¸ å¯¹äº†,fk GFW !
å¦‚æœå½±å“åˆ°äº†ç§æœ‰ä»“åº“,è¯·æš‚æ—¶æ”¾å¼ƒä»£ç†.

### Golang

è¿™é‡Œæˆ‘ä»¬ç»Ÿä¸€é‡‡ç”¨ go1.22.8 linux/riscv64 è¿™ä¸ªç‰ˆæœ¬.åŸå› è§[è¿™ç¯‡æ–‡ç« ](https://www.bfsmlt.top/posts/035k3sep10%E6%88%90%E5%8A%9F%E8%BF%81%E7%A7%BBk3s%E8%87%B3riscv64%E5%BC%80%E5%8F%91%E6%9D%BF%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/#%e9%81%bf%e5%85%8dgolang%e7%89%88%e6%9c%ac%e6%a3%80%e6%b5%8b),æ ¹æ®å½“å‰ä½ çš„ k8s ç‰ˆæœ¬è¿›è¡Œå¯¹åº”å˜åŒ–.

è¿™é‡Œé»˜è®¤ä½ å·²ç»æœ‰äº†æ­¤ç‰ˆæœ¬çš„ tar æ–‡ä»¶(æˆ‘æ˜¯é€šè¿‡ scp ä¼ è¿‡å»çš„)

```bash
sudo tar -C /usr/local -xzf go1.22.8.linux-riscv64.tar.gz
sudo vi ~/.bashrc
# Go environment
export GOROOT=/usr/local/go
export PATH=$GOROOT/bin:$PATH

export GOPATH=$HOME/go
export PATH=$GOPATH/bin:$PATH

export GOPROXY=https://goproxy.cn,direct
#
source ~/.bashrc
```

ä½¿ç”¨ `go version` æ£€æŸ¥å¾—åˆ° go1.22.8 è¿™ä¸ªæ­£ç¡®ç‰ˆæœ¬.

### yq

ç”¨æ¥è§£æ YAML çš„å·¥å…·,ä¹‹å‰[æ–‡ç« ](https://www.bfsmlt.top/posts/023k3sep06%E4%BB%8Eissues%E4%B8%8A%E5%BE%97%E5%88%B0%E7%9A%84%E5%8F%AF%E8%83%BD%E5%B0%9D%E8%AF%95/#yq%e6%9c%aa%e5%ae%89%e8%a3%85)ä¸­ä¹Ÿæåˆ°è¿‡.

è¿™é‡Œæˆ‘ä»¬ä¸ Golang ä¸€æ ·,ä»æºç æ„å»º,å› ä¸ºåŒ…ç®¡ç†ä¸­çš„ç‰ˆæœ¬å¤ªè€.

```bash
wget https://github.com/mikefarah/yq/releases/download/v4.44.6/yq_linux_riscv64.tar.gz
tar -zvxf yq_linux_riscv64.tar.gz
mv yq_linux_riscv64.tar.gz yq
chmod +x yq
mv yq /usr/local/bin
yq --version
```

å¦‚æœä½ ä¹‹å‰ç”¨ apt å®‰è£…äº† yq,å¯èƒ½ä¼šå­˜åœ¨é”™è¯¯çš„ç¼“å­˜,å¯ä»¥ç”¨`hash -r`æ¸…ç†ç¼“å­˜.

### æƒé™é—®é¢˜

ä¸ºäº†æ–¹ä¾¿å’Œé¿å…å¯èƒ½å‡ºç°çš„æƒé™é—®é¢˜,æˆ‘ä»¬ä¸ºæºç ç›®å½•èµ‹äºˆ root æƒé™

```bash
sudo chown -R $(whoami):$(whoami) .
```

### è®¿é—®ä»“åº“ç½‘ç»œé—®é¢˜

å¦‚æœæˆ‘ä»¬è®¿é—®è‡ªå·±çš„ç§æœ‰ä»“åº“æ—¶é‡åˆ°ç½‘ç»œé—®é¢˜,ç‰¹åˆ«æ˜¯ DNS è§£æé—®é¢˜,é€šå¸¸æ˜¯å› ä¸º Network Management è‡ªåŠ¨ä¸ºæˆ‘ä»¬è®¾ç½®å¥½äº† DNS æœåŠ¡å™¨åœ°å€.

è€Œè¿™ç¯‡[æ–‡ç« ](https://www.bfsmlt.top/posts/027%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C01dns/)ä¸­æˆ‘ä»¬è°ˆåˆ°äº†è¿™äº› DNS æœåŠ¡å™¨å¾ˆéš¾ä¸å‡ºé—®é¢˜,ç‰¹åˆ«æ˜¯åœ¨è§£æå›½å¤–çš„æœåŠ¡å™¨æ—¶.

æ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨ä¸€ä¸ªæœ€ç®€å•çš„æ–¹æ³•,ä¿®æ”¹ `/etc/hosts` æ–‡ä»¶,å°†æœåŠ¡å™¨çš„ IP åŠ å…¥å…¶ä¸­.

```bash
# è¯·æ¢æˆè‡ªå·±çš„ ip ä¸ åŸŸå
IP Domain
```

## å®‰è£…ä¸å¸è½½è„šæœ¬

å®éªŒè¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°é—®é¢˜å¯¼è‡´ k3s ä¸èƒ½è¿è¡Œ,åœ¨æ­¤æƒ…å†µä¸‹å¦‚æœæˆ‘ä»¬éœ€è¦åˆ é™¤ k3s æˆ–è€…é‡æ–°å®‰è£… k3s,è¿™é‡Œç»™å‡ºä¸¤ç§æ“ä½œçš„è„šæœ¬.

### å¸è½½è„šæœ¬

å°†å…¶ä» systemd ç®¡ç†ä¸­ç§»é™¤.

```sh
#!/bin/bash
set -e

echo "ğŸ”§ åœæ­¢ k3s æœåŠ¡ï¼ˆå¦‚åœ¨è¿è¡Œï¼‰..."
sudo systemctl stop k3s || true

echo "ğŸš« ç¦ç”¨ k3s æœåŠ¡å¼€æœºè‡ªå¯..."
sudo systemctl disable k3s || true

echo "ğŸ§¹ åˆ é™¤ k3s systemd æœåŠ¡æ–‡ä»¶..."
sudo rm -f /etc/systemd/system/k3s.service
sudo rm -f /etc/systemd/system/k3s.service.env

echo "ğŸ”„ é‡æ–°åŠ è½½ systemd å®ˆæŠ¤è¿›ç¨‹..."
sudo systemctl daemon-reload

echo "âœ… éªŒè¯ k3s æœåŠ¡æ˜¯å¦å·²æ¸…é™¤..."
sudo systemctl status k3s || echo "âœ… k3s.service å·²è¢«æˆåŠŸç§»é™¤ã€‚"

echo "ğŸ‰ æ¸…ç†å®Œæˆã€‚"
```

### å®‰è£…è„šæœ¬

å°†å…¶é‡æ–°åŠ å…¥ systemd ç®¡ç†,å‰ææ˜¯è„šæœ¬æ‰€åœ¨è·¯å¾„ä¸ k3s äºŒè¿›åˆ¶æ–‡ä»¶è·¯å¾„ä¸€è‡´,ä¸ä¸€è‡´è¯·ä¿®æ”¹è„šæœ¬.

```sh
#!/bin/bash
set -e

echo "ğŸ“¦ æ‹·è´æœ¬åœ° k3s åˆ° /usr/local/bin ..."
sudo cp /home/debian/k3s /usr/local/bin/k3s
sudo chmod +x /usr/local/bin/k3s

echo "ğŸ”§ é…ç½®ç§æœ‰é•œåƒä»“åº“ registries.yaml ..."
sudo mkdir -p /etc/rancher/k3s
cat <<EOF | sudo tee /etc/rancher/k3s/registries.yaml
mirrors:
  docker.io:
    endpoint:
      - "https://jimlt.bfsmlt.top"
EOF

echo "ğŸ“¥ è·å– k3s å®‰è£…è„šæœ¬ ..."
curl -sfL https://get.k3s.io -o k3s-install.sh

echo "ğŸš€ æ‰§è¡Œå®‰è£…è„šæœ¬ï¼Œä½¿ç”¨æœ¬åœ°å¯æ‰§è¡Œæ–‡ä»¶ ..."
INSTALL_K3S_SKIP_DOWNLOAD="true" bash -x k3s-install.sh
```

## åç»­æ›´æ–°

åç»­æ›´æ–°ä¼šæ ¹æ®æ„å»º k3s çš„è¿›å±•ä»¥åŠå¯èƒ½çš„å…¶ä»–åº”ç”¨ä¾‹å¦‚ Mobilenet è¿›è¡Œè¡¥å…….

**è¿™é‡Œæ˜¯LTXï¼Œæ„Ÿè°¢æ‚¨é˜…è¯»è¿™ç¯‡åšå®¢ï¼Œäººç”Ÿæµ·æµ·ï¼Œå’Œè‡ªå·±å¯¹è¯ï¼Œåƒåªè´è¶çºµæ¨ªå››æµ·ã€‚**