+++
date = '2025-04-19T19:13:50+08:00'
draft = true
title = '023K3sEP05目前工作总结'
+++

## 引子

在[K3sEP04](https://www.bfsmlt.top/posts/020k3sep04%E5%BC%80%E5%8F%91%E6%9D%BF%E4%B8%8Ak3s%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%9802/)中最后的总结中我们提到，反思了一下我们的移植过程，开始从k3s的结构看起，再到k8s的书籍，再到重新看二者的架构设计不同点，再到对应的命令，再追踪到k3s的源码，最后再开发板上适配的时候解决出现的一系列问题，我们处理移植问题的思路首先是有问题的。

还是引用一句话，大致的意思是，“你所遇到的问题100%都在别人的身上发生过，这意味着只要google，就一定可以找到答案。”但是我在这其中难道没有google过吗？我也不清楚为什么我没有发现对应的issue，直到最近，我才在github中找到了k3s关于支持riscv的相关issue，这证明自己处理此类问题的方法很有问题。

虽然我也可以甩锅到带我的老师没有指引我，但实际上这是一种解决问题的能力欠缺的表现，就像我今天读到的一篇文章，“编程思维不是说你能写出多么漂亮的代码，而是考验你如何快速高效解决问题”，是的，从这件事情上我意识到其实自己这方面的能力十分欠缺。

说回来，在[这个issue](https://github.com/k3s-io/k3s/issues/7151)中我发现了一个最有意思的问题，在2024-08-30，一位开发者说他只通过三条命令就在riscv64的机器上安装好了k3s并能够顺利运行。

![01](/img/riscv/issue01.png)

可以看到这位开发者和我的思路一致，都是自行构建解决了pause镜像的问题，所以我们根据他们的说法来试试吧，从k3s的源码构建，而不是简单的`dnf install k3s`

## 从源码构建可运行的k3s二进制文件

```bash
cd k3s
./script/download
./script/build
./script/package-cli
```

一共就是这三条命令，就可以构建出可执行的k3s文件，注意执行顺序不可更改。

接下来我来排一下可能会遇到的坑。

### yq未安装

yq是一个处理YAML文件的命令行工具,K3s构建脚本中使用它来解析yaml文件，所以需要提前安装yq。如果`dnf install yq`显示包管理器中没有yq的话，我们就需要从源码进行构建。

```bash
# 需要安装 go 编译环境
git clone https://github.com/mikefarah/yq.git
cd yq/v4
go build -o yq .
sudo mv yq /usr/local/bin/
```

或者直接去[官方的release](https://github.com/mikefarah/yq/releases)中查看有没有编译好的，发现其实是有的，可以直接进行下载使用

```bash
wget https://github.com/mikefarah/yq/releases/download/v4.44.6/yq_linux_riscv64.tar.gz
tar -zvxf yq_linux_riscv64.tar.gz
mv yq_linux_riscv64.tar.gz yq
chmod +x yq
mv yq /usr/local/bin
yq --version
```

### 有可能出现的源码错误

关于这个错误我也很疑惑，我并没有在开发板上修改过源码的内容，但是显示

```bash
-w -s ' -o bin/k3s ./cmd/server
# github.com/k3s-io/k3s/pkg/agent
pkg/agent/run.go:110:53: syntax error: unexpected name fmeEndpoint, expected {
```

证明源码中有地方出错了，我对比之下发现确实多了个空格，如果有遇到相同问题的朋友欢迎交流。

### libseccomp未安装

与yq不一样的是，这是linux系统级别的底层库，如果未安装的话其大概率是在包管理器中的，我们可以先检查一下是否存在。

```bash
dnf list libseccomp\*
Last metadata expiration check: 1:23:59 ago on 2025年04月19日 星期六 18时37分42秒.
Installed Packages
libseccomp.riscv64                                           2.5.4-1.oe2309                               @OS
libseccomp-devel.riscv64                                     2.5.4-1.oe2309                               @OS
Available Packages
libseccomp-debuginfo.riscv64                                 2.5.4-1.oe2309                               OS
libseccomp-debugsource.riscv64                               2.5.4-1.oe2309                               OS
libseccomp-help.noarch                                       2.5.4-1.oe2309                               OS
libseccomp-help.noarch                                       2.5.4-1.oe2309                               EPOL
```

这里显示我已经安装好了，如果你没有安装的话，使用`dnf install libseccomp-devel.riscv64`进行安装。

其他缺失的类似库也一样，我们都可以先list检查其是否存在然后再选择安装还是自行编译。（毕竟这是一个比较新的系统）

### 结果

最终执行完毕之后结果如下:

```bash
+ go build -tags urfave_cli_no_docs -buildvcs=false -ldflags '
    -X github.com/k3s-io/k3s/pkg/version.Version=v1.32.3+k3s-76c5c770
    -X github.com/k3s-io/k3s/pkg/version.GitCommit=76c5c770
    -w -s
 -extldflags '\''-static'\''' -o dist/artifacts/k3s-riscv64 ./cmd/k3s
+ stat dist/artifacts/k3s-riscv64
  文件：dist/artifacts/k3s-riscv64
  大小：80478360        块：157192     IO 块大小：4096   普通文件
设备：179,3     Inode: 661710      硬链接：1
权限：(0755/-rwxr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)
访问时间：2025-04-19 19:04:50.007082376 +0800
修改时间：2025-04-19 19:04:50.375090740 +0800
变更时间：2025-04-19 19:04:50.375090740 +0800
创建时间：2025-04-19 19:04:50.007082376 +0800
+ ./scripts/build-upload dist/artifacts/k3s-riscv64 76c5c770b21e101f00a32445d3e6fdc325d563b5
AWS_SECRET_ACCESS_KEY is not set
```

最终的二进制文件是`./dist/artifacts/k3s-riscv64`，我们可以在后面加上server和agent来分别执行这个二进制文件。

## 执行过程中存在的问题

如果我们真正执行起来会发现出现Golang的版本不兼容问题

```bash
./dist/artifacts/k3s-riscv64 server
INFO[0000] Acquiring lock file /var/lib/rancher/k3s/data/.lock
INFO[0000] Preparing data dir /var/lib/rancher/k3s/data/ce5fac18afd90ce4ba321d56c827d30b3b3de0cbe5c654dbb397bf62a178878e
FATA[0000] Failed to validate golang version: incorrect golang build version - kubernetes v1.32.3 should be built with go, runtime version is go1.23.3
```

意味着当前k8s需要的Golang版本不是我们目前的go1.23.3

但是本着原则我们不应该去降低版本，是不是应该在一个实验机器上使用1.23构建好最新的k3s，然后使用1.21or1.22在真正的使用机器上？