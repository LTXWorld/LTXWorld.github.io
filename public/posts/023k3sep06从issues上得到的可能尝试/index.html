<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>K3sEP06——从issues上得到的可能尝试 | LTX's Blog</title>
<meta name=keywords content><meta name=description content="引子
在K3sEP04中最后的总结中我们提到，反思了一下我们的移植过程，开始从k3s的结构看起，再到k8s的书籍，再到重新看二者的架构设计不同点，再到对应的命令，再追踪到k3s的源码，最后再开发板上适配的时候解决出现的一系列问题，我们处理移植问题的思路首先是有问题的。
还是引用一句话，大致的意思是，“你所遇到的问题100%都在别人的身上发生过，这意味着只要google，就一定可以找到答案。”但是我在这其中难道没有google过吗？我也不清楚为什么我没有发现对应的issue，直到最近，我才在github中找到了k3s关于支持riscv的相关issue，这证明自己处理此类问题的方法很有问题。"><meta name=author content="LTX"><link rel=canonical href=https://LTXWorld.github.io/posts/023k3sep06%E4%BB%8Eissues%E4%B8%8A%E5%BE%97%E5%88%B0%E7%9A%84%E5%8F%AF%E8%83%BD%E5%B0%9D%E8%AF%95/><link crossorigin=anonymous href=/assets/css/stylesheet.725ec5b3e73dcbb0ff6543a8256cd49aa2c4c02c9e0586f006beb2e1f1dec7f2.css integrity="sha256-cl7Fs+c9y7D/ZUOoJWzUmqLEwCyeBYbwBr6y4fHex/I=" rel="preload stylesheet" as=style><link rel=icon href=https://LTXWorld.github.io/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://LTXWorld.github.io/favicon.png><link rel=icon type=image/png sizes=32x32 href=https://LTXWorld.github.io/favicon.png><link rel=apple-touch-icon href=https://LTXWorld.github.io/favicon.png><link rel=mask-icon href=https://LTXWorld.github.io/favicon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://LTXWorld.github.io/posts/023k3sep06%E4%BB%8Eissues%E4%B8%8A%E5%BE%97%E5%88%B0%E7%9A%84%E5%8F%AF%E8%83%BD%E5%B0%9D%E8%AF%95/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><meta property="og:url" content="https://LTXWorld.github.io/posts/023k3sep06%E4%BB%8Eissues%E4%B8%8A%E5%BE%97%E5%88%B0%E7%9A%84%E5%8F%AF%E8%83%BD%E5%B0%9D%E8%AF%95/"><meta property="og:site_name" content="LTX's Blog"><meta property="og:title" content="K3sEP06——从issues上得到的可能尝试"><meta property="og:description" content="引子 在K3sEP04中最后的总结中我们提到，反思了一下我们的移植过程，开始从k3s的结构看起，再到k8s的书籍，再到重新看二者的架构设计不同点，再到对应的命令，再追踪到k3s的源码，最后再开发板上适配的时候解决出现的一系列问题，我们处理移植问题的思路首先是有问题的。
还是引用一句话，大致的意思是，“你所遇到的问题100%都在别人的身上发生过，这意味着只要google，就一定可以找到答案。”但是我在这其中难道没有google过吗？我也不清楚为什么我没有发现对应的issue，直到最近，我才在github中找到了k3s关于支持riscv的相关issue，这证明自己处理此类问题的方法很有问题。"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-19T19:13:50+08:00"><meta property="article:modified_time" content="2025-04-19T19:13:50+08:00"><meta property="og:image" content="https://LTXWorld.github.io/images/papermod-cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://LTXWorld.github.io/images/papermod-cover.png"><meta name=twitter:title content="K3sEP06——从issues上得到的可能尝试"><meta name=twitter:description content="引子
在K3sEP04中最后的总结中我们提到，反思了一下我们的移植过程，开始从k3s的结构看起，再到k8s的书籍，再到重新看二者的架构设计不同点，再到对应的命令，再追踪到k3s的源码，最后再开发板上适配的时候解决出现的一系列问题，我们处理移植问题的思路首先是有问题的。
还是引用一句话，大致的意思是，“你所遇到的问题100%都在别人的身上发生过，这意味着只要google，就一定可以找到答案。”但是我在这其中难道没有google过吗？我也不清楚为什么我没有发现对应的issue，直到最近，我才在github中找到了k3s关于支持riscv的相关issue，这证明自己处理此类问题的方法很有问题。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://LTXWorld.github.io/posts/"},{"@type":"ListItem","position":2,"name":"K3sEP06——从issues上得到的可能尝试","item":"https://LTXWorld.github.io/posts/023k3sep06%E4%BB%8Eissues%E4%B8%8A%E5%BE%97%E5%88%B0%E7%9A%84%E5%8F%AF%E8%83%BD%E5%B0%9D%E8%AF%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"K3sEP06——从issues上得到的可能尝试","name":"K3sEP06——从issues上得到的可能尝试","description":"引子 在K3sEP04中最后的总结中我们提到，反思了一下我们的移植过程，开始从k3s的结构看起，再到k8s的书籍，再到重新看二者的架构设计不同点，再到对应的命令，再追踪到k3s的源码，最后再开发板上适配的时候解决出现的一系列问题，我们处理移植问题的思路首先是有问题的。\n还是引用一句话，大致的意思是，“你所遇到的问题100%都在别人的身上发生过，这意味着只要google，就一定可以找到答案。”但是我在这其中难道没有google过吗？我也不清楚为什么我没有发现对应的issue，直到最近，我才在github中找到了k3s关于支持riscv的相关issue，这证明自己处理此类问题的方法很有问题。\n","keywords":[],"articleBody":"引子 在K3sEP04中最后的总结中我们提到，反思了一下我们的移植过程，开始从k3s的结构看起，再到k8s的书籍，再到重新看二者的架构设计不同点，再到对应的命令，再追踪到k3s的源码，最后再开发板上适配的时候解决出现的一系列问题，我们处理移植问题的思路首先是有问题的。\n还是引用一句话，大致的意思是，“你所遇到的问题100%都在别人的身上发生过，这意味着只要google，就一定可以找到答案。”但是我在这其中难道没有google过吗？我也不清楚为什么我没有发现对应的issue，直到最近，我才在github中找到了k3s关于支持riscv的相关issue，这证明自己处理此类问题的方法很有问题。\n虽然我也可以甩锅到带我的老师没有指引我，但实际上这是一种解决问题的能力欠缺的表现，就像我今天读到的一篇文章，“编程思维不是说你能写出多么漂亮的代码，而是考验你如何快速高效解决问题”，是的，从这件事情上我意识到其实自己这方面的能力十分欠缺。\n说回来，在这个issue中我发现了一个最有意思的问题，在2024-08-30，一位开发者说他只通过三条命令就在riscv64的机器上安装好了k3s并能够顺利运行。\n可以看到这位开发者和我的思路一致，都是自行构建解决了pause镜像的问题，所以我们根据他们的说法来试试吧，从k3s的源码构建，而不是简单的dnf install k3s\n从源码构建可运行的k3s二进制文件 cd k3s ./script/download ./script/build ./script/package-cli 一共就是这三条命令，就可以构建出可执行的k3s文件，注意执行顺序不可更改。\n接下来我来排一下可能会遇到的坑。\nyq未安装 yq是一个处理YAML文件的命令行工具,K3s构建脚本中使用它来解析yaml文件，所以需要提前安装yq。如果dnf install yq显示包管理器中没有yq的话，我们就需要从源码进行构建。\n# 需要安装 go 编译环境 git clone https://github.com/mikefarah/yq.git cd yq/v4 go build -o yq . sudo mv yq /usr/local/bin/ 或者直接去官方的release中查看有没有编译好的，发现其实是有的，可以直接进行下载使用\nwget https://github.com/mikefarah/yq/releases/download/v4.44.6/yq_linux_riscv64.tar.gz tar -zvxf yq_linux_riscv64.tar.gz mv yq_linux_riscv64.tar.gz yq chmod +x yq mv yq /usr/local/bin yq --version 有可能出现的源码错误 关于这个错误我也很疑惑，我并没有在开发板上修改过源码的内容，但是显示\n-w -s ' -o bin/k3s ./cmd/server # github.com/k3s-io/k3s/pkg/agent pkg/agent/run.go:110:53: syntax error: unexpected name fmeEndpoint, expected { 证明源码中有地方出错了，我对比之下发现确实多了个空格，如果有遇到相同问题的朋友欢迎交流。\nlibseccomp未安装 与yq不一样的是，这是linux系统级别的底层库，如果未安装的话其大概率是在包管理器中的，我们可以先检查一下是否存在。\ndnf list libseccomp\\* Last metadata expiration check: 1:23:59 ago on 2025年04月19日 星期六 18时37分42秒. Installed Packages libseccomp.riscv64 2.5.4-1.oe2309 @OS libseccomp-devel.riscv64 2.5.4-1.oe2309 @OS Available Packages libseccomp-debuginfo.riscv64 2.5.4-1.oe2309 OS libseccomp-debugsource.riscv64 2.5.4-1.oe2309 OS libseccomp-help.noarch 2.5.4-1.oe2309 OS libseccomp-help.noarch 2.5.4-1.oe2309 EPOL 这里显示我已经安装好了，如果你没有安装的话，使用dnf install libseccomp-devel.riscv64进行安装。\n其他缺失的类似库也一样，我们都可以先list检查其是否存在然后再选择安装还是自行编译。（毕竟这是一个比较新的系统）\n结果 最终执行完毕之后结果如下:\n+ go build -tags urfave_cli_no_docs -buildvcs=false -ldflags ' -X github.com/k3s-io/k3s/pkg/version.Version=v1.32.3+k3s-76c5c770 -X github.com/k3s-io/k3s/pkg/version.GitCommit=76c5c770 -w -s -extldflags '\\''-static'\\''' -o dist/artifacts/k3s-riscv64 ./cmd/k3s + stat dist/artifacts/k3s-riscv64 文件：dist/artifacts/k3s-riscv64 大小：80478360 块：157192 IO 块大小：4096 普通文件 设备：179,3 Inode: 661710 硬链接：1 权限：(0755/-rwxr-xr-x) Uid: ( 0/ root) Gid: ( 0/ root) 访问时间：2025-04-19 19:04:50.007082376 +0800 修改时间：2025-04-19 19:04:50.375090740 +0800 变更时间：2025-04-19 19:04:50.375090740 +0800 创建时间：2025-04-19 19:04:50.007082376 +0800 + ./scripts/build-upload dist/artifacts/k3s-riscv64 76c5c770b21e101f00a32445d3e6fdc325d563b5 AWS_SECRET_ACCESS_KEY is not set 最终的二进制文件是./dist/artifacts/k3s-riscv64，我们可以在后面加上server和agent来分别执行这个二进制文件。\n执行过程中存在的问题 当然执行并不是一蹴而就的，会存在一系列的问题（谁能想到我第一次执行成功之后的就一直在失败）\nGolang的版本不匹配问题 如果我们真正执行起来会发现出现 Golang 的版本不匹配问题\n./dist/artifacts/k3s-riscv64 server INFO[0000] Acquiring lock file /var/lib/rancher/k3s/data/.lock INFO[0000] Preparing data dir /var/lib/rancher/k3s/data/ce5fac18afd90ce4ba321d56c827d30b3b3de0cbe5c654dbb397bf62a178878e FATA[0000] Failed to validate golang version: incorrect golang build version - kubernetes v1.32.3 should be built with go, runtime version is go1.23.3 意味着当前 k8s 需要的 Golang 版本不是我们目前的 go1.23.3，所以在哪里查找其需要的特定 go 版本呢？\n我 google 并没有得到准确的答案，gpt 告诉我在这个 commit中，其修改了 v1.32.3版本的 k8s 所需版本为 go1.23.6\n其实还可以从构建脚本中发现其所需要的版本，在build脚本中的这两句\nDEPENDENCIES_URL=\"https://raw.githubusercontent.com/kubernetes/kubernetes/${VERSION_K8S}/build/dependencies.yaml\" VERSION_GOLANG=\"go\"$(curl -sL \"${DEPENDENCIES_URL}\" | yq e '.dependencies[] | select(.name == \"golang: upstream version\").version' -) 就是在这个 dependencies.yaml 文件中寻找 Golang 的版本，我们打开这个文件发现 v1.32.3的 K8s 所需的 Golang 版本为 1.23.6，与上面 commit 中的版本相同，验证了我们的想法。\n# Golang - name: \"golang: upstream version\" version: 1.23.6 所以我们构建就要使用 go1.23.6，想想也挺奇怪的，明明 k3s 源码的 go.mod 中指明了 go1.23.3,但是其依赖的 k8s 中的内容却要 go1.23.6???\n奇怪的downloading 一旦进入源码目录执行一切 go 开头的命令就会出现 go: downloading go1.23.3 (linux/riscv64)，我的 go 本地本来就有啊，为什么他还是会去 download 呢？并且去非 k3s 源码的其他目录执行 go version类似命令，正常输出。\n原因如下：在 Go 里面，如果当前目录下有 go.mod 文件，不管你执行什么 go 命令，它都会默认开启 module模式。\n检查 go.mod 和 go.sum 有需要时自动联网去拉缺失的模块 解决可能出现的问题 尝试切换版本 我们推倒重来，默认使用Golang版本为1.23.6,即构建版本为1.23.6；使用时切换到1.22or1.21。 安装时提前下载好对应版本的Golang安装包。\nrm -rf /usr/local/go tar -C /usr/local -xzf go1.23.6.linux-riscv64.tar.gz vi ~/.bashrc # Go environment export GOROOT=/usr/local/go export PATH=$GOROOT/bin:$PATH export GOPATH=$HOME/go export PATH=$GOPATH/bin:$PATH export GOPROXY=https://goproxy.cn,direct # source ~/.bashrc go version # 将另一个版本放到另一个目录下 mkdir -p /opt tar -C /opt -xzf go1.22.9.linux-riscv64.tar.gz mv /opt/go /opt/go1.22.9 vi ~/.bashrc # 在最后添加转换脚本 usego() { if [ \"$1\" = \"1.23.6\" ]; then export GOROOT=/usr/local/go elif [ \"$1\" = \"1.22\" ]; then export GOROOT=/opt/go1.22.9 else echo \"Usage: usego [1.23.6|1.22]\" return 1 fi export PATH=$GOROOT/bin:$PATH echo \"Switched to Go version: $(go version)\" } # source ~/.bashrc 之后我们可以执行usego 1.23.6和usego 1.22来回切换开发板上的Golang版本了。\n执行构建./script/download\nDownload遇到网络问题 如果开发板上遇到网络问题（即使我添加了代理也无法解决），我从 gpt 上得到的建议是可以在主机上进行 download 操作，因为这一步只是下载所需的各种依赖，并不是编译过程，所以不太涉及到架构问题。\n只需要在 download 前引入 riscv64 的临时环境变量，让其安装的依赖适合 riscv64。\nexport GOARCH=riscv64 export ARCH=riscv64 export OS=linux ./scripts/download # 然后拷贝build目录到开发板的k3s源码上 scp build/ root@ip:/root/k3s 这样就可以免于在开发板上进行直接 download，从而避免长时间的等待。\n探究为什么可以成功 download 这里我们列出其脚本内容，不算太多可以分析一下。分析我都写在每行命令的后面方便查看。\n#!/bin/bash # 指定以bash启动脚本 set -ex # 设置如果任何命令返回非零退出状态，立即退出；打印执行的每个命令及其参数，便于调试 cd $(dirname $0)/.. # 切换到脚本所在目录的父目录 . ./scripts/version.sh # 执行version.sh脚本，里面定义了版本信息 CHARTS_URL=https://k3s.io/k3s-charts/assets # 定义各种URL和目录路径变量 CHARTS_DIR=build/static/charts RUNC_DIR=build/src/github.com/opencontainers/runc CONTAINERD_DIR=build/src/github.com/containerd/containerd HCSSHIM_DIR=build/src/github.com/microsoft/hcsshim DATA_DIR=build/data export TZ=UTC umask 022 # 设置新创建文件的默认权限（755目录/644文件） rm -rf ${CHARTS_DIR} # 删除之前的目录并创建空的新目录 rm -rf ${RUNC_DIR} rm -rf ${CONTAINERD_DIR} rm -rf ${HCSSHIM_DIR} mkdir -p ${CHARTS_DIR} mkdir -p ${DATA_DIR} case ${OS} in # 如果系统是linux就会下载指定版本，指定架构的runc(底层容器运行时，负责运行 Pod 中的容器)以及k3s-root并解压 linux) git clone --single-branch --branch=${VERSION_RUNC} --depth=1 https://github.com/k3s-io/runc ${RUNC_DIR} curl --compressed -sfL https://github.com/k3s-io/k3s-root/releases/download/${VERSION_ROOT}/k3s-root-${ARCH}.tar | tar xf - ;; windows) # 如果是windows git clone --single-branch --branch=${VERSION_HCSSHIM} --depth=1 https://github.com/microsoft/hcsshim ${HCSSHIM_DIR} ;; *) # 如果是其他系统就会直接输出错误信息并退出 echo \"[ERROR] unrecognized operating system: ${OS}\" exit 1 ;; esac # 注意这里case in的用法 git clone --single-branch --branch=${VERSION_CONTAINERD} --depth=1 https://${PKG_CONTAINERD_K3S} ${CONTAINERD_DIR} # 克隆指定版本的containerd（容器运行时）仓库，使用depth=1的浅克隆只获取最新提交 # 从K3s charts仓库下载每个chart文件到构建目录 for CHART_FILE in $(grep -rlF HelmChart manifests/ | xargs yq eval --no-doc .spec.chart | xargs -n1 basename); do CHART_NAME=$(echo $CHART_FILE | grep -oE '^(-*[a-z])+') curl -sfL ${CHARTS_URL}/${CHART_NAME}/${CHART_FILE} -o ${CHARTS_DIR}/${CHART_FILE} done 从这个 build 脚本可以看出其下载了以下东西:\nrunc+k3s-root(linux) / hcsshim(windows) containerd(底层是runc) HelmChart(k8s中类似于dnf的包管理器) 并最终将这些内容放在 build 目录下，其中会产生 src, static, data目录。\n可以发现，这里的 k3s-root-riscv64是关键，我在 k3s 相关的 issue 中找到了有一位开发者提供了对其的 commit 并得到了 k3s-root 的接受。\nbuild 接下来我们分层次介绍一下build脚本。\n#!/bin/bash set -e -x cd $(dirname $0)/.. . ./scripts/version.sh GO=${GO-go} # 默认使用 `go` 命令，但允许通过环境变量覆盖 PKG=\"github.com/k3s-io/k3s\" PKG_CONTAINERD=\"github.com/containerd/containerd\" PKG_CRICTL=\"github.com/kubernetes-sigs/cri-tools/pkg\" PKG_K8S_BASE=\"k8s.io/component-base\" PKG_K8S_CLIENT=\"k8s.io/client-go/pkg\" PKG_CNI_PLUGINS=\"github.com/containernetworking/plugins\" PKG_KUBE_ROUTER=\"github.com/cloudnativelabs/kube-router/v2\" PKG_CRI_DOCKERD=\"github.com/Mirantis/cri-dockerd\" PKG_ETCD=\"go.etcd.io/etcd\" buildDate=$(date -u '+%Y-%m-%dT%H:%M:%SZ') 前面相同，后面定义了各个依赖组件的 Go 模块路径，用于后续的版本信息注入。\nVERSIONFLAGS=\" -X ${PKG}/pkg/version.Version=${VERSION} -X ${PKG}/pkg/version.GitCommit=${COMMIT:0:8} -X ${PKG}/pkg/version.UpstreamGolang=${VERSION_GOLANG} -X ${PKG_K8S_CLIENT}/version.gitVersion=${VERSION} -X ${PKG_K8S_CLIENT}/version.gitCommit=${COMMIT} -X ${PKG_K8S_CLIENT}/version.gitTreeState=${TREE_STATE} -X ${PKG_K8S_CLIENT}/version.buildDate=${buildDate} -X ${PKG_K8S_BASE}/version.gitVersion=${VERSION} -X ${PKG_K8S_BASE}/version.gitCommit=${COMMIT} -X ${PKG_K8S_BASE}/version.gitTreeState=${TREE_STATE} -X ${PKG_K8S_BASE}/version.buildDate=${buildDate} -X ${PKG_CRICTL}/version.Version=${VERSION_CRICTL} -X ${PKG_CONTAINERD}/version.Version=${VERSION_CONTAINERD} -X ${PKG_CONTAINERD}/version.Package=${PKG_CONTAINERD_K3S} -X ${PKG_CNI_PLUGINS}/pkg/utils/buildversion.BuildVersion=${VERSION_CNIPLUGINS} -X ${PKG_CNI_PLUGINS}/plugins/meta/flannel.Program=flannel -X ${PKG_CNI_PLUGINS}/plugins/meta/flannel.Version=${VERSION_FLANNEL_PLUGIN}+${VERSION_FLANNEL} -X ${PKG_CNI_PLUGINS}/plugins/meta/flannel.Commit=HEAD -X ${PKG_CNI_PLUGINS}/plugins/meta/flannel.buildDate=${buildDate} -X ${PKG_KUBE_ROUTER}/pkg/version.Version=${VERSION_KUBE_ROUTER} -X ${PKG_KUBE_ROUTER}/pkg/version.BuildDate=${buildDate} -X ${PKG_CRI_DOCKERD}/cmd/version.Version=${VERSION_CRI_DOCKERD} -X ${PKG_CRI_DOCKERD}/cmd/version.GitCommit=HEAD -X ${PKG_CRI_DOCKERD}/cmd/version.BuildTime=${buildDate} -X ${PKG_ETCD}/api/v3/version.GitSHA=HEAD \" 版本信息注入——使用 -X 标志向 Go 二进制文件注入版本信息，包括k3s版本，Git提交哈希，组件版本等。\nif [ -n \"${DEBUG}\" ]; then GCFLAGS=\"-N -l\" else LDFLAGS=\"-w -s\" fi 在调试模式下禁用优化，便于调试\ncase ${OS} in linux) TAGS=\"$TAGS apparmor seccomp\" RUNC_TAGS=\"$RUNC_TAGS apparmor seccomp\" if [ \"$STATIC_BUILD\" == \"true\" ]; then STATIC=$'\\n-extldflags \\'-static -lm -ldl -lz -lpthread\\'\\n' TAGS=\"static_build libsqlite3 $TAGS\" RUNC_STATIC=\"static\" fi if [ \"$SELINUX\" = \"true\" ]; then TAGS=\"$TAGS selinux\" RUNC_TAGS=\"$RUNC_TAGS selinux\" fi ;; windows) TAGS=\"$TAGS no_cri_dockerd\" if [ \"$STATIC_BUILD\" == \"true\" ]; then STATIC=$'\\n-extldflags \\'-static -lpthread\\'\\n' TAGS=\"static_build $TAGS\" fi export CXX=\"x86_64-w64-mingw32-g++\" export CC=\"x86_64-w64-mingw32-gcc\" ;; *) echo \"[ERROR] unrecognized opertaing system: ${OS}\" exit 1 ;; esac 关于静态构建选项？\nif [ ${ARCH} = armv7l ] || [ ${ARCH} = arm ]; then export GOARCH=\"arm\" export GOARM=\"7\" fi if [ ${ARCH} = s390x ]; then export GOARCH=\"s390x\" fi 根据架构设置交叉编译的 GOARCH 变量\nk3s_binaries=( \"bin/k3s-agent\" \"bin/k3s-server\" \"bin/k3s-token\" ... ) containerd_binaries=( \"bin/containerd-shim\" \"bin/containerd-shim-runc-v2\" ... ) for i in \"${k3s_binaries[@]}\"; do if [ -f \"$i${BINARY_POSTFIX}\" ]; then rm -f \"$i${BINARY_POSTFIX}\" fi done 清理旧的 k3s 和 containerd 的二进制文件\nif [ ! -x ${INSTALLBIN}/cni${BINARY_POSTFIX} ]; then ( TMPDIR=$(mktemp -d) git clone --single-branch --depth=1 --branch=$VERSION_CNIPLUGINS https://github.com/rancher/plugins.git $WORKDIR cd $WORKDIR rm -rf plugins/meta/flannel git clone --single-branch --depth=1 --branch=$VERSION_FLANNEL_PLUGIN https://github.com/flannel-io/cni-plugin.git plugins/meta/flannel GO111MODULE=off GOPATH=$TMPDIR CGO_ENABLED=0 \"${GO}\" build -tags \"$TAGS\" -gcflags=\"all=${GCFLAGS}\" -ldflags \"$VERSIONFLAGS $LDFLAGS $STATIC\" -o $INSTALLBIN/cni${BINARY_POSTFIX} ) fi 克隆并构建 CNI 网络插件（有关于 flannel，后续会写文介绍）\necho Building k3s CGO_ENABLED=1 \"${GO}\" build $BLDFLAGS -tags \"$TAGS\" -buildvcs=false -gcflags=\"all=${GCFLAGS}\" -ldflags \"$VERSIONFLAGS $LDFLAGS $STATIC\" -o bin/k3s${BINARY_POSTFIX} ./cmd/server for i in \"${k3s_binaries[@]}\"; do ln -s \"k3s${BINARY_POSTFIX}\" \"$i${BINARY_POSTFIX}\" done 构建k3s主程序，Go 编译器 (go build) 编译 ./cmd/server(主入口程序) 目录下的代码，生成 bin/k3s 二进制文件。\n最后构建 containerd 和 runc;\n整个流程确保了 K3s 及其所有依赖组件能正确编译并打包成可执行文件。\npackage-cli 此脚本用来构建有关于k3s的相关命令。\n汇总 最终我们将得到的 k3s-riscv64 二进制文件放入 /usr/local/bin中并使用 systemd 来控制其状态。具体步骤如下:\nmv k3s-riscv64 k3s mv /path/to/k3s /usr/local/bin chmod +x /usr/local/bin/k3s # 编写k3s.service vi /etc/systemd/system/k3s.service # 内容如下，来自于k3s源码中的同样内容 [Unit] Description=Lightweight Kubernetes Documentation=https://k3s.io After=network-online.target Wants=network-online.target [Service] Type=notify EnvironmentFile=-/etc/default/%N EnvironmentFile=-/etc/sysconfig/%N EnvironmentFile=-/etc/systemd/system/k3s.service.env ExecStartPre=/bin/sh -xc '! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.service 2\u003e/dev/null' ExecStart=/usr/local/bin/k3s server KillMode=process Delegate=yes # Having non-zero Limit*s causes performance problems due to accounting overhead # in the kernel. We recommend using cgroups to do container-local accounting. LimitNOFILE=1048576 LimitNPROC=infinity LimitCORE=infinity TasksMax=infinity TimeoutStartSec=0 Restart=always RestartSec=5s [Install] WantedBy=multi-user.target 之后重新加载配置并使用 systemctl 管理 k3s\nsystemctl daemon-reload systemctl enable k3s systemctl start k3s systemctl status k3s 启动成功，状态如下：\nk3s.service - Lightweight Kubernetes Loaded: loaded (/etc/systemd/system/k3s.service; disabled; preset: disabled) Drop-In: /etc/systemd/system/k3s.service.d └─override.conf Active: active (running) since Mon 2025-04-28 14:21:55 CST; 50s ago Docs: https://k3s.io 执行相关命令\nk3s kubectl get node NAME STATUS ROLES AGE VERSION openeuler-riscv64 Ready control-plane,master 40m v1.32.3+k3s-76c5c770-dirty 设置软链接，可以省去前面的 k3s 标识。\nln -sf /usr/local/bin/k3s /usr/local/bin/kubectl 最终将上述操作汇总为k3s-init.sh,与 k3s-riscv64 和 golang 的tar文件在同一目录下,执行\nchmod +x k3s-init.sh sudo ./k3s-init.sh ","wordCount":"4091","inLanguage":"zh","image":"https://LTXWorld.github.io/images/papermod-cover.png","datePublished":"2025-04-19T19:13:50+08:00","dateModified":"2025-04-19T19:13:50+08:00","author":{"@type":"Person","name":"LTX"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://LTXWorld.github.io/posts/023k3sep06%E4%BB%8Eissues%E4%B8%8A%E5%BE%97%E5%88%B0%E7%9A%84%E5%8F%AF%E8%83%BD%E5%B0%9D%E8%AF%95/"},"publisher":{"@type":"Organization","name":"LTX's Blog","logo":{"@type":"ImageObject","url":"https://LTXWorld.github.io/favicon.png"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://LTXWorld.github.io/ accesskey=h title="LTX's Blog (Alt + H)">LTX's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://LTXWorld.github.io/ title="LTX's Blog"><span>首页</span></a></li><li><a href=https://LTXWorld.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://LTXWorld.github.io/categories/ title=Categories><span>分类</span></a></li><li><a href=https://LTXWorld.github.io/tags/ title=Tags><span>标签</span></a></li><li><a href=https://LTXWorld.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://LTXWorld.github.io/about/ title=后花园><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">K3sEP06——从issues上得到的可能尝试</h1><div class=post-meta><span title='2025-04-19 19:13:50 +0800 CST'>四月 19, 2025</span>&nbsp;·&nbsp;9 分钟&nbsp;·&nbsp;LTX</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e5%ad%90 aria-label=引子>引子</a></li><li><a href=#%e4%bb%8e%e6%ba%90%e7%a0%81%e6%9e%84%e5%bb%ba%e5%8f%af%e8%bf%90%e8%a1%8c%e7%9a%84k3s%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%96%87%e4%bb%b6 aria-label=从源码构建可运行的k3s二进制文件>从源码构建可运行的k3s二进制文件</a><ul><li><a href=#yq%e6%9c%aa%e5%ae%89%e8%a3%85 aria-label=yq未安装>yq未安装</a></li><li><a href=#%e6%9c%89%e5%8f%af%e8%83%bd%e5%87%ba%e7%8e%b0%e7%9a%84%e6%ba%90%e7%a0%81%e9%94%99%e8%af%af aria-label=有可能出现的源码错误>有可能出现的源码错误</a></li><li><a href=#libseccomp%e6%9c%aa%e5%ae%89%e8%a3%85 aria-label=libseccomp未安装>libseccomp未安装</a></li><li><a href=#%e7%bb%93%e6%9e%9c aria-label=结果>结果</a></li></ul></li><li><a href=#%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b%e4%b8%ad%e5%ad%98%e5%9c%a8%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=执行过程中存在的问题>执行过程中存在的问题</a><ul><li><a href=#golang%e7%9a%84%e7%89%88%e6%9c%ac%e4%b8%8d%e5%8c%b9%e9%85%8d%e9%97%ae%e9%a2%98 aria-label=Golang的版本不匹配问题>Golang的版本不匹配问题</a></li><li><a href=#%e5%a5%87%e6%80%aa%e7%9a%84downloading aria-label=奇怪的downloading>奇怪的downloading</a></li></ul></li><li><a href=#%e8%a7%a3%e5%86%b3%e5%8f%af%e8%83%bd%e5%87%ba%e7%8e%b0%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=解决可能出现的问题>解决可能出现的问题</a><ul><li><a href=#%e5%b0%9d%e8%af%95%e5%88%87%e6%8d%a2%e7%89%88%e6%9c%ac aria-label=尝试切换版本>尝试切换版本</a></li><li><a href=#download%e9%81%87%e5%88%b0%e7%bd%91%e7%bb%9c%e9%97%ae%e9%a2%98 aria-label=Download遇到网络问题>Download遇到网络问题</a></li></ul></li><li><a href=#%e6%8e%a2%e7%a9%b6%e4%b8%ba%e4%bb%80%e4%b9%88%e5%8f%af%e4%bb%a5%e6%88%90%e5%8a%9f aria-label=探究为什么可以成功>探究为什么可以成功</a><ul><li><a href=#download aria-label=download>download</a></li><li><a href=#build aria-label=build>build</a></li><li><a href=#package-cli aria-label=package-cli>package-cli</a></li></ul></li><li><a href=#%e6%b1%87%e6%80%bb aria-label=汇总>汇总</a></li></ul></div></details></div><div class=post-content><h2 id=引子>引子<a hidden class=anchor aria-hidden=true href=#引子>#</a></h2><p>在<a href=https://www.bfsmlt.top/posts/020k3sep04%E5%BC%80%E5%8F%91%E6%9D%BF%E4%B8%8Ak3s%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%9802/>K3sEP04</a>中最后的总结中我们提到，反思了一下我们的移植过程，开始从k3s的结构看起，再到k8s的书籍，再到重新看二者的架构设计不同点，再到对应的命令，再追踪到k3s的源码，最后再开发板上适配的时候解决出现的一系列问题，我们处理移植问题的思路首先是有问题的。</p><p>还是引用一句话，大致的意思是，“你所遇到的问题100%都在别人的身上发生过，这意味着只要google，就一定可以找到答案。”但是我在这其中难道没有google过吗？我也不清楚为什么我没有发现对应的issue，直到最近，我才在github中找到了k3s关于支持riscv的相关issue，这证明自己处理此类问题的方法很有问题。</p><p>虽然我也可以甩锅到带我的老师没有指引我，但实际上这是一种解决问题的能力欠缺的表现，就像我今天读到的一篇文章，“编程思维不是说你能写出多么漂亮的代码，而是考验你如何快速高效解决问题”，是的，从这件事情上我意识到其实自己这方面的能力十分欠缺。</p><p>说回来，在<a href=https://github.com/k3s-io/k3s/issues/7151>这个issue</a>中我发现了一个最有意思的问题，在2024-08-30，一位开发者说他只通过三条命令就在riscv64的机器上安装好了k3s并能够顺利运行。</p><p><img alt=01 loading=lazy src=/img/riscv/issue01.png></p><p>可以看到这位开发者和我的思路一致，都是自行构建解决了pause镜像的问题，所以我们根据他们的说法来试试吧，从k3s的源码构建，而不是简单的<code>dnf install k3s</code></p><h2 id=从源码构建可运行的k3s二进制文件>从源码构建可运行的k3s二进制文件<a hidden class=anchor aria-hidden=true href=#从源码构建可运行的k3s二进制文件>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> k3s
</span></span><span class=line><span class=cl>./script/download
</span></span><span class=line><span class=cl>./script/build
</span></span><span class=line><span class=cl>./script/package-cli
</span></span></code></pre></div><p>一共就是这三条命令，就可以构建出可执行的k3s文件，注意执行顺序不可更改。</p><p>接下来我来排一下可能会遇到的坑。</p><h3 id=yq未安装>yq未安装<a hidden class=anchor aria-hidden=true href=#yq未安装>#</a></h3><p>yq是一个处理YAML文件的命令行工具,K3s构建脚本中使用它来解析yaml文件，所以需要提前安装yq。如果<code>dnf install yq</code>显示包管理器中没有yq的话，我们就需要从源码进行构建。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 需要安装 go 编译环境</span>
</span></span><span class=line><span class=cl>git clone https://github.com/mikefarah/yq.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> yq/v4
</span></span><span class=line><span class=cl>go build -o yq .
</span></span><span class=line><span class=cl>sudo mv yq /usr/local/bin/
</span></span></code></pre></div><p>或者直接去<a href=https://github.com/mikefarah/yq/releases>官方的release</a>中查看有没有编译好的，发现其实是有的，可以直接进行下载使用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://github.com/mikefarah/yq/releases/download/v4.44.6/yq_linux_riscv64.tar.gz
</span></span><span class=line><span class=cl>tar -zvxf yq_linux_riscv64.tar.gz
</span></span><span class=line><span class=cl>mv yq_linux_riscv64.tar.gz yq
</span></span><span class=line><span class=cl>chmod +x yq
</span></span><span class=line><span class=cl>mv yq /usr/local/bin
</span></span><span class=line><span class=cl>yq --version
</span></span></code></pre></div><h3 id=有可能出现的源码错误>有可能出现的源码错误<a hidden class=anchor aria-hidden=true href=#有可能出现的源码错误>#</a></h3><p>关于这个错误我也很疑惑，我并没有在开发板上修改过源码的内容，但是显示</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>-w -s <span class=err>&#39;</span> -o bin/k3s ./cmd/server
</span></span><span class=line><span class=cl><span class=c1># github.com/k3s-io/k3s/pkg/agent</span>
</span></span><span class=line><span class=cl>pkg/agent/run.go:110:53: syntax error: unexpected name fmeEndpoint, expected <span class=o>{</span>
</span></span></code></pre></div><p>证明源码中有地方出错了，我对比之下发现确实多了个空格，如果有遇到相同问题的朋友欢迎交流。</p><h3 id=libseccomp未安装>libseccomp未安装<a hidden class=anchor aria-hidden=true href=#libseccomp未安装>#</a></h3><p>与yq不一样的是，这是linux系统级别的底层库，如果未安装的话其大概率是在包管理器中的，我们可以先检查一下是否存在。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dnf list libseccomp<span class=se>\*</span>
</span></span><span class=line><span class=cl>Last metadata expiration check: 1:23:59 ago on 2025年04月19日 星期六 18时37分42秒.
</span></span><span class=line><span class=cl>Installed Packages
</span></span><span class=line><span class=cl>libseccomp.riscv64                                           2.5.4-1.oe2309                               @OS
</span></span><span class=line><span class=cl>libseccomp-devel.riscv64                                     2.5.4-1.oe2309                               @OS
</span></span><span class=line><span class=cl>Available Packages
</span></span><span class=line><span class=cl>libseccomp-debuginfo.riscv64                                 2.5.4-1.oe2309                               OS
</span></span><span class=line><span class=cl>libseccomp-debugsource.riscv64                               2.5.4-1.oe2309                               OS
</span></span><span class=line><span class=cl>libseccomp-help.noarch                                       2.5.4-1.oe2309                               OS
</span></span><span class=line><span class=cl>libseccomp-help.noarch                                       2.5.4-1.oe2309                               EPOL
</span></span></code></pre></div><p>这里显示我已经安装好了，如果你没有安装的话，使用<code>dnf install libseccomp-devel.riscv64</code>进行安装。</p><p>其他缺失的类似库也一样，我们都可以先list检查其是否存在然后再选择安装还是自行编译。（毕竟这是一个比较新的系统）</p><h3 id=结果>结果<a hidden class=anchor aria-hidden=true href=#结果>#</a></h3><p>最终执行完毕之后结果如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>+ go build -tags urfave_cli_no_docs -buildvcs<span class=o>=</span><span class=nb>false</span> -ldflags <span class=s1>&#39;
</span></span></span><span class=line><span class=cl><span class=s1>    -X github.com/k3s-io/k3s/pkg/version.Version=v1.32.3+k3s-76c5c770
</span></span></span><span class=line><span class=cl><span class=s1>    -X github.com/k3s-io/k3s/pkg/version.GitCommit=76c5c770
</span></span></span><span class=line><span class=cl><span class=s1>    -w -s
</span></span></span><span class=line><span class=cl><span class=s1> -extldflags &#39;</span><span class=se>\&#39;</span><span class=s1>&#39;-static&#39;</span><span class=se>\&#39;</span><span class=s1>&#39;&#39;</span> -o dist/artifacts/k3s-riscv64 ./cmd/k3s
</span></span><span class=line><span class=cl>+ stat dist/artifacts/k3s-riscv64
</span></span><span class=line><span class=cl>  文件：dist/artifacts/k3s-riscv64
</span></span><span class=line><span class=cl>  大小：80478360        块：157192     IO 块大小：4096   普通文件
</span></span><span class=line><span class=cl>设备：179,3     Inode: <span class=m>661710</span>      硬链接：1
</span></span><span class=line><span class=cl>权限：<span class=o>(</span>0755/-rwxr-xr-x<span class=o>)</span>  Uid: <span class=o>(</span>    0/    root<span class=o>)</span>   Gid: <span class=o>(</span>    0/    root<span class=o>)</span>
</span></span><span class=line><span class=cl>访问时间：2025-04-19 19:04:50.007082376 +0800
</span></span><span class=line><span class=cl>修改时间：2025-04-19 19:04:50.375090740 +0800
</span></span><span class=line><span class=cl>变更时间：2025-04-19 19:04:50.375090740 +0800
</span></span><span class=line><span class=cl>创建时间：2025-04-19 19:04:50.007082376 +0800
</span></span><span class=line><span class=cl>+ ./scripts/build-upload dist/artifacts/k3s-riscv64 76c5c770b21e101f00a32445d3e6fdc325d563b5
</span></span><span class=line><span class=cl>AWS_SECRET_ACCESS_KEY is not <span class=nb>set</span>
</span></span></code></pre></div><p>最终的二进制文件是<code>./dist/artifacts/k3s-riscv64</code>，我们可以在后面加上server和agent来分别执行这个二进制文件。</p><h2 id=执行过程中存在的问题>执行过程中存在的问题<a hidden class=anchor aria-hidden=true href=#执行过程中存在的问题>#</a></h2><p>当然执行并不是一蹴而就的，会存在一系列的问题（谁能想到我第一次执行成功之后的就一直在失败）</p><h3 id=golang的版本不匹配问题>Golang的版本不匹配问题<a hidden class=anchor aria-hidden=true href=#golang的版本不匹配问题>#</a></h3><p>如果我们真正执行起来会发现出现 Golang 的版本不匹配问题</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./dist/artifacts/k3s-riscv64 server
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0000<span class=o>]</span> Acquiring lock file /var/lib/rancher/k3s/data/.lock
</span></span><span class=line><span class=cl>INFO<span class=o>[</span>0000<span class=o>]</span> Preparing data dir /var/lib/rancher/k3s/data/ce5fac18afd90ce4ba321d56c827d30b3b3de0cbe5c654dbb397bf62a178878e
</span></span><span class=line><span class=cl>FATA<span class=o>[</span>0000<span class=o>]</span> Failed to validate golang version: incorrect golang build version - kubernetes v1.32.3 should be built with go, runtime version is go1.23.3
</span></span></code></pre></div><p>意味着当前 k8s 需要的 Golang 版本不是我们目前的 go1.23.3，所以在哪里查找其需要的特定 go 版本呢？</p><p>我 google 并没有得到准确的答案，gpt 告诉我在这个 <a href=https://github.com/kubernetes/kubernetes/commit/ae0ec29cbf463ad5fffb67907546c98f1d667855>commit</a>中，其修改了 v1.32.3版本的 k8s 所需版本为 go1.23.6</p><p>其实还可以从构建脚本中发现其所需要的版本，在<code>build</code>脚本中的这两句</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>DEPENDENCIES_URL</span><span class=o>=</span><span class=s2>&#34;https://raw.githubusercontent.com/kubernetes/kubernetes/</span><span class=si>${</span><span class=nv>VERSION_K8S</span><span class=si>}</span><span class=s2>/build/dependencies.yaml&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>VERSION_GOLANG</span><span class=o>=</span><span class=s2>&#34;go&#34;</span><span class=k>$(</span>curl -sL <span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEPENDENCIES_URL</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span> yq e <span class=s1>&#39;.dependencies[] | select(.name == &#34;golang: upstream version&#34;).version&#39;</span> -<span class=k>)</span>
</span></span></code></pre></div><p>就是在这个 <code>dependencies.yaml</code> 文件中寻找 Golang 的版本，我们打开这个文件发现 v1.32.3的 K8s 所需的 Golang 版本为 1.23.6，与上面 commit 中的版本相同，验证了我们的想法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Golang</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;golang: upstream version&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1.23.6</span><span class=w>
</span></span></span></code></pre></div><p>所以我们构建就要使用 go1.23.6，想想也挺奇怪的，明明 k3s 源码的 go.mod 中指明了 go1.23.3,但是其依赖的 k8s 中的内容却要 go1.23.6???</p><h3 id=奇怪的downloading>奇怪的downloading<a hidden class=anchor aria-hidden=true href=#奇怪的downloading>#</a></h3><p>一旦进入源码目录执行一切 go 开头的命令就会出现 <code>go: downloading go1.23.3 (linux/riscv64)</code>，我的 go 本地本来就有啊，为什么他还是会去 download 呢？并且去非 k3s 源码的其他目录执行 <code>go version</code>类似命令，正常输出。</p><p>原因如下：在 Go 里面，如果当前目录下有 go.mod 文件，不管你执行什么 go 命令，它都会默认开启 module模式。</p><ul><li>检查 go.mod 和 go.sum</li><li>有需要时自动联网去拉缺失的模块</li></ul><h2 id=解决可能出现的问题>解决可能出现的问题<a hidden class=anchor aria-hidden=true href=#解决可能出现的问题>#</a></h2><h3 id=尝试切换版本>尝试切换版本<a hidden class=anchor aria-hidden=true href=#尝试切换版本>#</a></h3><p>我们推倒重来，默认使用Golang版本为1.23.6,即构建版本为1.23.6；使用时切换到1.22or1.21。
安装时提前下载好对应版本的Golang安装包。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>rm -rf /usr/local/go
</span></span><span class=line><span class=cl>tar -C /usr/local -xzf go1.23.6.linux-riscv64.tar.gz
</span></span><span class=line><span class=cl>vi ~/.bashrc
</span></span><span class=line><span class=cl><span class=c1># Go environment</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOROOT</span><span class=o>=</span>/usr/local/go
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$GOROOT</span>/bin:<span class=nv>$PATH</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOPATH</span><span class=o>=</span><span class=nv>$HOME</span>/go
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$GOPATH</span>/bin:<span class=nv>$PATH</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOPROXY</span><span class=o>=</span>https://goproxy.cn,direct
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> ~/.bashrc
</span></span><span class=line><span class=cl>go version
</span></span><span class=line><span class=cl><span class=c1># 将另一个版本放到另一个目录下</span>
</span></span><span class=line><span class=cl>mkdir -p /opt
</span></span><span class=line><span class=cl>tar -C /opt -xzf go1.22.9.linux-riscv64.tar.gz
</span></span><span class=line><span class=cl>mv /opt/go /opt/go1.22.9
</span></span><span class=line><span class=cl>vi ~/.bashrc
</span></span><span class=line><span class=cl><span class=c1># 在最后添加转换脚本</span>
</span></span><span class=line><span class=cl>usego<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;1.23.6&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>export</span> <span class=nv>GOROOT</span><span class=o>=</span>/usr/local/go
</span></span><span class=line><span class=cl>  <span class=k>elif</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;1.22&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>export</span> <span class=nv>GOROOT</span><span class=o>=</span>/opt/go1.22.9
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Usage: usego [1.23.6|1.22]&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  <span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$GOROOT</span>/bin:<span class=nv>$PATH</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Switched to Go version: </span><span class=k>$(</span>go version<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> ~/.bashrc
</span></span></code></pre></div><p>之后我们可以执行<code>usego 1.23.6</code>和<code>usego 1.22</code>来回切换开发板上的Golang版本了。</p><p>执行构建<code>./script/download</code></p><h3 id=download遇到网络问题>Download遇到网络问题<a hidden class=anchor aria-hidden=true href=#download遇到网络问题>#</a></h3><p>如果开发板上遇到网络问题（即使我添加了代理也无法解决），我从 gpt 上得到的建议是可以在主机上进行 download 操作，因为这一步只是下载所需的各种依赖，并不是编译过程，所以不太涉及到架构问题。</p><p>只需要在 download 前引入 riscv64 的临时环境变量，让其安装的依赖适合 riscv64。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOARCH</span><span class=o>=</span>riscv64
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>ARCH</span><span class=o>=</span>riscv64
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>OS</span><span class=o>=</span>linux
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>./scripts/download
</span></span><span class=line><span class=cl><span class=c1># 然后拷贝build目录到开发板的k3s源码上</span>
</span></span><span class=line><span class=cl>scp build/ root@ip:/root/k3s
</span></span></code></pre></div><p>这样就可以免于在开发板上进行直接 download，从而避免长时间的等待。</p><h2 id=探究为什么可以成功>探究为什么可以成功<a hidden class=anchor aria-hidden=true href=#探究为什么可以成功>#</a></h2><h3 id=download>download<a hidden class=anchor aria-hidden=true href=#download>#</a></h3><p>这里我们列出其脚本内容，不算太多可以分析一下。分析我都写在每行命令的后面方便查看。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash # 指定以bash启动脚本
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -ex <span class=c1># 设置如果任何命令返回非零退出状态，立即退出；打印执行的每个命令及其参数，便于调试</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=k>$(</span>dirname <span class=nv>$0</span><span class=k>)</span>/.. <span class=c1># 切换到脚本所在目录的父目录</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>. ./scripts/version.sh <span class=c1># 执行version.sh脚本，里面定义了版本信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>CHARTS_URL</span><span class=o>=</span>https://k3s.io/k3s-charts/assets <span class=c1># 定义各种URL和目录路径变量</span>
</span></span><span class=line><span class=cl><span class=nv>CHARTS_DIR</span><span class=o>=</span>build/static/charts
</span></span><span class=line><span class=cl><span class=nv>RUNC_DIR</span><span class=o>=</span>build/src/github.com/opencontainers/runc
</span></span><span class=line><span class=cl><span class=nv>CONTAINERD_DIR</span><span class=o>=</span>build/src/github.com/containerd/containerd
</span></span><span class=line><span class=cl><span class=nv>HCSSHIM_DIR</span><span class=o>=</span>build/src/github.com/microsoft/hcsshim
</span></span><span class=line><span class=cl><span class=nv>DATA_DIR</span><span class=o>=</span>build/data
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>TZ</span><span class=o>=</span>UTC
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>umask</span> <span class=m>022</span> <span class=c1># 设置新创建文件的默认权限（755目录/644文件）</span>
</span></span><span class=line><span class=cl>rm -rf <span class=si>${</span><span class=nv>CHARTS_DIR</span><span class=si>}</span> <span class=c1># 删除之前的目录并创建空的新目录</span>
</span></span><span class=line><span class=cl>rm -rf <span class=si>${</span><span class=nv>RUNC_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl>rm -rf <span class=si>${</span><span class=nv>CONTAINERD_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl>rm -rf <span class=si>${</span><span class=nv>HCSSHIM_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=si>${</span><span class=nv>CHARTS_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=si>${</span><span class=nv>DATA_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=si>${</span><span class=nv>OS</span><span class=si>}</span> in <span class=c1># 如果系统是linux就会下载指定版本，指定架构的runc(底层容器运行时，负责运行 Pod 中的容器)以及k3s-root并解压</span>
</span></span><span class=line><span class=cl>  linux<span class=o>)</span>
</span></span><span class=line><span class=cl>    git clone --single-branch --branch<span class=o>=</span><span class=si>${</span><span class=nv>VERSION_RUNC</span><span class=si>}</span> --depth<span class=o>=</span><span class=m>1</span> https://github.com/k3s-io/runc <span class=si>${</span><span class=nv>RUNC_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    curl --compressed -sfL https://github.com/k3s-io/k3s-root/releases/download/<span class=si>${</span><span class=nv>VERSION_ROOT</span><span class=si>}</span>/k3s-root-<span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span>.tar <span class=p>|</span> tar xf -
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>  windows<span class=o>)</span> <span class=c1># 如果是windows</span>
</span></span><span class=line><span class=cl>    git clone --single-branch --branch<span class=o>=</span><span class=si>${</span><span class=nv>VERSION_HCSSHIM</span><span class=si>}</span> --depth<span class=o>=</span><span class=m>1</span> https://github.com/microsoft/hcsshim <span class=si>${</span><span class=nv>HCSSHIM_DIR</span><span class=si>}</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>  *<span class=o>)</span> <span class=c1># 如果是其他系统就会直接输出错误信息并退出</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;[ERROR] unrecognized operating system: </span><span class=si>${</span><span class=nv>OS</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span> <span class=c1># 注意这里case in的用法</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>git clone --single-branch --branch<span class=o>=</span><span class=si>${</span><span class=nv>VERSION_CONTAINERD</span><span class=si>}</span> --depth<span class=o>=</span><span class=m>1</span> https://<span class=si>${</span><span class=nv>PKG_CONTAINERD_K3S</span><span class=si>}</span> <span class=si>${</span><span class=nv>CONTAINERD_DIR</span><span class=si>}</span> <span class=c1># 克隆指定版本的containerd（容器运行时）仓库，使用depth=1的浅克隆只获取最新提交</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从K3s charts仓库下载每个chart文件到构建目录</span>
</span></span><span class=line><span class=cl><span class=k>for</span> CHART_FILE in <span class=k>$(</span>grep -rlF HelmChart manifests/ <span class=p>|</span> xargs yq <span class=nb>eval</span> --no-doc .spec.chart <span class=p>|</span> xargs -n1 basename<span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nv>CHART_NAME</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$CHART_FILE</span> <span class=p>|</span> grep -oE <span class=s1>&#39;^(-*[a-z])+&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  curl -sfL <span class=si>${</span><span class=nv>CHARTS_URL</span><span class=si>}</span>/<span class=si>${</span><span class=nv>CHART_NAME</span><span class=si>}</span>/<span class=si>${</span><span class=nv>CHART_FILE</span><span class=si>}</span> -o <span class=si>${</span><span class=nv>CHARTS_DIR</span><span class=si>}</span>/<span class=si>${</span><span class=nv>CHART_FILE</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><p>从这个 build 脚本可以看出其下载了以下东西:</p><ul><li>runc+k3s-root(linux) / hcsshim(windows)</li><li>containerd(底层是runc)</li><li>HelmChart(k8s中类似于dnf的包管理器)</li></ul><p>并最终将这些内容放在 build 目录下，其中会产生 src, static, data目录。</p><p>可以发现，这里的 k3s-root-riscv64是关键，我在 k3s 相关的 <a href=https://github.com/k3s-io/k3s/pull/7778>issue</a> 中找到了有一位开发者提供了对其的 commit 并得到了 k3s-root 的接受。</p><h3 id=build>build<a hidden class=anchor aria-hidden=true href=#build>#</a></h3><p>接下来我们分层次介绍一下build脚本。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>set</span> -e -x
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=k>$(</span>dirname <span class=nv>$0</span><span class=k>)</span>/..
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>. ./scripts/version.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>GO</span><span class=o>=</span><span class=si>${</span><span class=nv>GO</span><span class=p>-go</span><span class=si>}</span> <span class=c1># 默认使用 `go` 命令，但允许通过环境变量覆盖</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>PKG</span><span class=o>=</span><span class=s2>&#34;github.com/k3s-io/k3s&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PKG_CONTAINERD</span><span class=o>=</span><span class=s2>&#34;github.com/containerd/containerd&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PKG_CRICTL</span><span class=o>=</span><span class=s2>&#34;github.com/kubernetes-sigs/cri-tools/pkg&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PKG_K8S_BASE</span><span class=o>=</span><span class=s2>&#34;k8s.io/component-base&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PKG_K8S_CLIENT</span><span class=o>=</span><span class=s2>&#34;k8s.io/client-go/pkg&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PKG_CNI_PLUGINS</span><span class=o>=</span><span class=s2>&#34;github.com/containernetworking/plugins&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PKG_KUBE_ROUTER</span><span class=o>=</span><span class=s2>&#34;github.com/cloudnativelabs/kube-router/v2&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PKG_CRI_DOCKERD</span><span class=o>=</span><span class=s2>&#34;github.com/Mirantis/cri-dockerd&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PKG_ETCD</span><span class=o>=</span><span class=s2>&#34;go.etcd.io/etcd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>buildDate</span><span class=o>=</span><span class=k>$(</span>date -u <span class=s1>&#39;+%Y-%m-%dT%H:%M:%SZ&#39;</span><span class=k>)</span>
</span></span></code></pre></div><p>前面相同，后面定义了各个依赖组件的 Go 模块路径，用于后续的版本信息注入。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>VERSIONFLAGS</span><span class=o>=</span><span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG</span><span class=si>}</span><span class=s2>/pkg/version.Version=</span><span class=si>${</span><span class=nv>VERSION</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG</span><span class=si>}</span><span class=s2>/pkg/version.GitCommit=</span><span class=si>${</span><span class=nv>COMMIT</span><span class=p>:</span><span class=nv>0</span><span class=p>:</span><span class=nv>8</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG</span><span class=si>}</span><span class=s2>/pkg/version.UpstreamGolang=</span><span class=si>${</span><span class=nv>VERSION_GOLANG</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_K8S_CLIENT</span><span class=si>}</span><span class=s2>/version.gitVersion=</span><span class=si>${</span><span class=nv>VERSION</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_K8S_CLIENT</span><span class=si>}</span><span class=s2>/version.gitCommit=</span><span class=si>${</span><span class=nv>COMMIT</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_K8S_CLIENT</span><span class=si>}</span><span class=s2>/version.gitTreeState=</span><span class=si>${</span><span class=nv>TREE_STATE</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_K8S_CLIENT</span><span class=si>}</span><span class=s2>/version.buildDate=</span><span class=si>${</span><span class=nv>buildDate</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_K8S_BASE</span><span class=si>}</span><span class=s2>/version.gitVersion=</span><span class=si>${</span><span class=nv>VERSION</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_K8S_BASE</span><span class=si>}</span><span class=s2>/version.gitCommit=</span><span class=si>${</span><span class=nv>COMMIT</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_K8S_BASE</span><span class=si>}</span><span class=s2>/version.gitTreeState=</span><span class=si>${</span><span class=nv>TREE_STATE</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_K8S_BASE</span><span class=si>}</span><span class=s2>/version.buildDate=</span><span class=si>${</span><span class=nv>buildDate</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CRICTL</span><span class=si>}</span><span class=s2>/version.Version=</span><span class=si>${</span><span class=nv>VERSION_CRICTL</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CONTAINERD</span><span class=si>}</span><span class=s2>/version.Version=</span><span class=si>${</span><span class=nv>VERSION_CONTAINERD</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CONTAINERD</span><span class=si>}</span><span class=s2>/version.Package=</span><span class=si>${</span><span class=nv>PKG_CONTAINERD_K3S</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CNI_PLUGINS</span><span class=si>}</span><span class=s2>/pkg/utils/buildversion.BuildVersion=</span><span class=si>${</span><span class=nv>VERSION_CNIPLUGINS</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CNI_PLUGINS</span><span class=si>}</span><span class=s2>/plugins/meta/flannel.Program=flannel
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CNI_PLUGINS</span><span class=si>}</span><span class=s2>/plugins/meta/flannel.Version=</span><span class=si>${</span><span class=nv>VERSION_FLANNEL_PLUGIN</span><span class=si>}</span><span class=s2>+</span><span class=si>${</span><span class=nv>VERSION_FLANNEL</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CNI_PLUGINS</span><span class=si>}</span><span class=s2>/plugins/meta/flannel.Commit=HEAD
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CNI_PLUGINS</span><span class=si>}</span><span class=s2>/plugins/meta/flannel.buildDate=</span><span class=si>${</span><span class=nv>buildDate</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_KUBE_ROUTER</span><span class=si>}</span><span class=s2>/pkg/version.Version=</span><span class=si>${</span><span class=nv>VERSION_KUBE_ROUTER</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_KUBE_ROUTER</span><span class=si>}</span><span class=s2>/pkg/version.BuildDate=</span><span class=si>${</span><span class=nv>buildDate</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CRI_DOCKERD</span><span class=si>}</span><span class=s2>/cmd/version.Version=</span><span class=si>${</span><span class=nv>VERSION_CRI_DOCKERD</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CRI_DOCKERD</span><span class=si>}</span><span class=s2>/cmd/version.GitCommit=HEAD
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_CRI_DOCKERD</span><span class=si>}</span><span class=s2>/cmd/version.BuildTime=</span><span class=si>${</span><span class=nv>buildDate</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    -X </span><span class=si>${</span><span class=nv>PKG_ETCD</span><span class=si>}</span><span class=s2>/api/v3/version.GitSHA=HEAD
</span></span></span><span class=line><span class=cl><span class=s2>&#34;</span>
</span></span></code></pre></div><p>版本信息注入——使用 -X 标志向 Go 二进制文件注入版本信息，包括k3s版本，Git提交哈希，组件版本等。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=si>${</span><span class=nv>DEBUG</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nv>GCFLAGS</span><span class=o>=</span><span class=s2>&#34;-N -l&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=nv>LDFLAGS</span><span class=o>=</span><span class=s2>&#34;-w -s&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><p>在调试模式下禁用优化，便于调试</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>case</span> <span class=si>${</span><span class=nv>OS</span><span class=si>}</span> in
</span></span><span class=line><span class=cl>  linux<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>TAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$TAGS</span><span class=s2> apparmor seccomp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>RUNC_TAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$RUNC_TAGS</span><span class=s2> apparmor seccomp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$STATIC_BUILD</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>      <span class=nv>STATIC</span><span class=o>=</span><span class=s1>$&#39;\n-extldflags \&#39;-static -lm -ldl -lz -lpthread\&#39;\n&#39;</span>
</span></span><span class=line><span class=cl>      <span class=nv>TAGS</span><span class=o>=</span><span class=s2>&#34;static_build libsqlite3 </span><span class=nv>$TAGS</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>RUNC_STATIC</span><span class=o>=</span><span class=s2>&#34;static&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$SELINUX</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>      <span class=nv>TAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$TAGS</span><span class=s2> selinux&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nv>RUNC_TAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$RUNC_TAGS</span><span class=s2> selinux&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>  windows<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>TAGS</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$TAGS</span><span class=s2> no_cri_dockerd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$STATIC_BUILD</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;true&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>      <span class=nv>STATIC</span><span class=o>=</span><span class=s1>$&#39;\n-extldflags \&#39;-static -lpthread\&#39;\n&#39;</span>
</span></span><span class=line><span class=cl>      <span class=nv>TAGS</span><span class=o>=</span><span class=s2>&#34;static_build </span><span class=nv>$TAGS</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>export</span> <span class=nv>CXX</span><span class=o>=</span><span class=s2>&#34;x86_64-w64-mingw32-g++&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>export</span> <span class=nv>CC</span><span class=o>=</span><span class=s2>&#34;x86_64-w64-mingw32-gcc&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl>  *<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;[ERROR] unrecognized opertaing system: </span><span class=si>${</span><span class=nv>OS</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span></code></pre></div><p>关于静态构建选项？</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span> <span class=o>=</span> armv7l <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span> <span class=o>=</span> arm <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>export</span> <span class=nv>GOARCH</span><span class=o>=</span><span class=s2>&#34;arm&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>export</span> <span class=nv>GOARM</span><span class=o>=</span><span class=s2>&#34;7&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=si>${</span><span class=nv>ARCH</span><span class=si>}</span> <span class=o>=</span> s390x <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>export</span> <span class=nv>GOARCH</span><span class=o>=</span><span class=s2>&#34;s390x&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><p>根据架构设置交叉编译的 GOARCH 变量</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>k3s_binaries</span><span class=o>=(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bin/k3s-agent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bin/k3s-server&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bin/k3s-token&#34;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>containerd_binaries</span><span class=o>=(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bin/containerd-shim&#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;bin/containerd-shim-runc-v2&#34;</span>
</span></span><span class=line><span class=cl>    ...
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>k3s_binaries</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$i</span><span class=si>${</span><span class=nv>BINARY_POSTFIX</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        rm -f <span class=s2>&#34;</span><span class=nv>$i</span><span class=si>${</span><span class=nv>BINARY_POSTFIX</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><p>清理旧的 k3s 和 containerd 的二进制文件</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -x <span class=si>${</span><span class=nv>INSTALLBIN</span><span class=si>}</span>/cni<span class=si>${</span><span class=nv>BINARY_POSTFIX</span><span class=si>}</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl><span class=o>(</span>
</span></span><span class=line><span class=cl>    <span class=nv>TMPDIR</span><span class=o>=</span><span class=k>$(</span>mktemp -d<span class=k>)</span>
</span></span><span class=line><span class=cl>    git clone --single-branch --depth<span class=o>=</span><span class=m>1</span> --branch<span class=o>=</span><span class=nv>$VERSION_CNIPLUGINS</span> https://github.com/rancher/plugins.git <span class=nv>$WORKDIR</span>
</span></span><span class=line><span class=cl>    <span class=nb>cd</span> <span class=nv>$WORKDIR</span>
</span></span><span class=line><span class=cl>    rm -rf plugins/meta/flannel
</span></span><span class=line><span class=cl>    git clone --single-branch --depth<span class=o>=</span><span class=m>1</span> --branch<span class=o>=</span><span class=nv>$VERSION_FLANNEL_PLUGIN</span> https://github.com/flannel-io/cni-plugin.git plugins/meta/flannel
</span></span><span class=line><span class=cl>    <span class=nv>GO111MODULE</span><span class=o>=</span>off <span class=nv>GOPATH</span><span class=o>=</span><span class=nv>$TMPDIR</span> <span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=m>0</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>GO</span><span class=si>}</span><span class=s2>&#34;</span> build -tags <span class=s2>&#34;</span><span class=nv>$TAGS</span><span class=s2>&#34;</span> -gcflags<span class=o>=</span><span class=s2>&#34;all=</span><span class=si>${</span><span class=nv>GCFLAGS</span><span class=si>}</span><span class=s2>&#34;</span> -ldflags <span class=s2>&#34;</span><span class=nv>$VERSIONFLAGS</span><span class=s2> </span><span class=nv>$LDFLAGS</span><span class=s2> </span><span class=nv>$STATIC</span><span class=s2>&#34;</span> -o <span class=nv>$INSTALLBIN</span>/cni<span class=si>${</span><span class=nv>BINARY_POSTFIX</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></div><p>克隆并构建 CNI 网络插件（有关于 flannel，后续会写文介绍）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> Building k3s
</span></span><span class=line><span class=cl><span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=m>1</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>GO</span><span class=si>}</span><span class=s2>&#34;</span> build <span class=nv>$BLDFLAGS</span> -tags <span class=s2>&#34;</span><span class=nv>$TAGS</span><span class=s2>&#34;</span> -buildvcs<span class=o>=</span><span class=nb>false</span> -gcflags<span class=o>=</span><span class=s2>&#34;all=</span><span class=si>${</span><span class=nv>GCFLAGS</span><span class=si>}</span><span class=s2>&#34;</span> -ldflags <span class=s2>&#34;</span><span class=nv>$VERSIONFLAGS</span><span class=s2> </span><span class=nv>$LDFLAGS</span><span class=s2> </span><span class=nv>$STATIC</span><span class=s2>&#34;</span> -o bin/k3s<span class=si>${</span><span class=nv>BINARY_POSTFIX</span><span class=si>}</span> ./cmd/server
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>k3s_binaries</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    ln -s <span class=s2>&#34;k3s</span><span class=si>${</span><span class=nv>BINARY_POSTFIX</span><span class=si>}</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$i</span><span class=si>${</span><span class=nv>BINARY_POSTFIX</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><p>构建k3s主程序，Go 编译器 (go build) 编译 <code>./cmd/server</code>(主入口程序) 目录下的代码，生成 bin/k3s 二进制文件。</p><p>最后构建 containerd 和 runc;</p><p>整个流程确保了 K3s 及其所有依赖组件能正确编译并打包成可执行文件。</p><h3 id=package-cli>package-cli<a hidden class=anchor aria-hidden=true href=#package-cli>#</a></h3><p>此脚本用来构建有关于k3s的相关命令。</p><h2 id=汇总>汇总<a hidden class=anchor aria-hidden=true href=#汇总>#</a></h2><p>最终我们将得到的 k3s-riscv64 二进制文件放入 <code>/usr/local/bin</code>中并使用 systemd 来控制其状态。具体步骤如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mv k3s-riscv64 k3s
</span></span><span class=line><span class=cl>mv /path/to/k3s /usr/local/bin
</span></span><span class=line><span class=cl>chmod +x /usr/local/bin/k3s
</span></span><span class=line><span class=cl><span class=c1># 编写k3s.service</span>
</span></span><span class=line><span class=cl>vi /etc/systemd/system/k3s.service
</span></span><span class=line><span class=cl><span class=c1># 内容如下，来自于k3s源码中的同样内容</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Lightweight Kubernetes
</span></span><span class=line><span class=cl><span class=nv>Documentation</span><span class=o>=</span>https://k3s.io
</span></span><span class=line><span class=cl><span class=nv>After</span><span class=o>=</span>network-online.target
</span></span><span class=line><span class=cl><span class=nv>Wants</span><span class=o>=</span>network-online.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Type</span><span class=o>=</span>notify
</span></span><span class=line><span class=cl><span class=nv>EnvironmentFile</span><span class=o>=</span>-/etc/default/%N
</span></span><span class=line><span class=cl><span class=nv>EnvironmentFile</span><span class=o>=</span>-/etc/sysconfig/%N
</span></span><span class=line><span class=cl><span class=nv>EnvironmentFile</span><span class=o>=</span>-/etc/systemd/system/k3s.service.env
</span></span><span class=line><span class=cl><span class=nv>ExecStartPre</span><span class=o>=</span>/bin/sh -xc <span class=s1>&#39;! /usr/bin/systemctl is-enabled --quiet nm-cloud-setup.service 2&gt;/dev/null&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/local/bin/k3s server
</span></span><span class=line><span class=cl><span class=nv>KillMode</span><span class=o>=</span>process
</span></span><span class=line><span class=cl><span class=nv>Delegate</span><span class=o>=</span>yes
</span></span><span class=line><span class=cl><span class=c1># Having non-zero Limit*s causes performance problems due to accounting overhead</span>
</span></span><span class=line><span class=cl><span class=c1># in the kernel. We recommend using cgroups to do container-local accounting.</span>
</span></span><span class=line><span class=cl><span class=nv>LimitNOFILE</span><span class=o>=</span><span class=m>1048576</span>
</span></span><span class=line><span class=cl><span class=nv>LimitNPROC</span><span class=o>=</span>infinity
</span></span><span class=line><span class=cl><span class=nv>LimitCORE</span><span class=o>=</span>infinity
</span></span><span class=line><span class=cl><span class=nv>TasksMax</span><span class=o>=</span>infinity
</span></span><span class=line><span class=cl><span class=nv>TimeoutStartSec</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nv>Restart</span><span class=o>=</span>always
</span></span><span class=line><span class=cl><span class=nv>RestartSec</span><span class=o>=</span>5s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></div><p>之后重新加载配置并使用 systemctl 管理 k3s</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> k3s
</span></span><span class=line><span class=cl>systemctl start k3s
</span></span><span class=line><span class=cl>systemctl status k3s
</span></span></code></pre></div><p>启动成功，状态如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k3s.service - Lightweight Kubernetes
</span></span><span class=line><span class=cl>     Loaded: loaded <span class=o>(</span>/etc/systemd/system/k3s.service<span class=p>;</span> disabled<span class=p>;</span> preset: disabled<span class=o>)</span>
</span></span><span class=line><span class=cl>    Drop-In: /etc/systemd/system/k3s.service.d
</span></span><span class=line><span class=cl>             └─override.conf
</span></span><span class=line><span class=cl>     Active: active <span class=o>(</span>running<span class=o>)</span> since Mon 2025-04-28 14:21:55 CST<span class=p>;</span> 50s ago
</span></span><span class=line><span class=cl>       Docs: https://k3s.io
</span></span></code></pre></div><p>执行相关命令</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k3s kubectl get node
</span></span><span class=line><span class=cl>NAME                STATUS   ROLES                  AGE   VERSION
</span></span><span class=line><span class=cl>openeuler-riscv64   Ready    control-plane,master   40m   v1.32.3+k3s-76c5c770-dirty
</span></span></code></pre></div><p>设置软链接，可以省去前面的 k3s 标识。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ln -sf /usr/local/bin/k3s /usr/local/bin/kubectl
</span></span></code></pre></div><p>最终将上述操作汇总为<code>k3s-init.sh</code>,与 k3s-riscv64 和 golang 的tar文件在同一目录下,执行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod +x k3s-init.sh
</span></span><span class=line><span class=cl>sudo ./k3s-init.sh
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://LTXWorld.github.io/posts/025golangep04_string%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E5%8F%8A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9/><span class=title>« 上一页</span><br><span>GolangEP04_string底层原理及注意事项</span>
</a><a class=next href=https://LTXWorld.github.io/posts/021%E5%A5%87%E6%80%9D%E4%B9%B1%E6%83%B3ep02%E6%B6%88%E8%B4%B9%E8%A7%82%E4%B8%8E%E9%98%85%E8%AF%BB/><span class=title>下一页 »</span><br><span>LT的奇思乱想EP02精气神——消费观与阅读</span></a></nav></footer><div id=tw-comment></div><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="light"?"light":"dark",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"LTXWorld/LTXWorld.github.io","data-repo-id":"R_kgDONODUuA","data-category":"Announcements","data-category-id":"DIC_kwDONODUuM4CkMUw","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-CN","data-loading":"lazy",crossorigin:"anonymous"},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#tw-comment").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span><a href=https://LTXWorld.github.io/>©2025 LTX&rsquo;s Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><div class=ltx-music-player id=ltx-music-player role=group aria-label=背景音乐播放器><audio id=ltx-music-audio preload=metadata></audio><div class=ltx-drag-handle data-role=drag-handle title=上下拖动调整位置></div><div class=ltx-music-header><div class=ltx-music-visual><div class=ltx-disc data-role=disc aria-hidden=true><img data-role=cover alt loading=lazy decoding=async><div class=ltx-disc-center></div></div></div><div class=ltx-music-meta><span class=ltx-music-title data-role=title></span>
<span class=ltx-music-artist data-role=artist></span></div><button type=button class=ltx-music-hide data-action=collapse aria-label=隐藏播放器>&#215;</button></div><div class=ltx-music-progress data-role=progress aria-label=进度条 role=slider><div class=ltx-music-progress-fill data-role=progress-fill></div></div><div class=ltx-music-time><span data-role=current>0:00</span>
<span data-role=total>--:--</span></div><div class=ltx-music-controls><button type=button data-action=prev aria-label=上一首>⏮</button>
<button type=button data-action=toggle aria-label=播放或暂停>
<span data-icon=play>▶</span>
<span data-icon=pause>⏸</span>
</button>
<button type=button data-action=next aria-label=下一首>⏭</button>
<button type=button data-action=mute aria-label=静音或取消静音>
<span data-icon=unmuted>🔊</span>
<span data-icon=muted>🔇</span></button></div><div class=ltx-autoplay-tip data-role=tip aria-live=polite></div></div><button type=button class=ltx-music-fab id=ltx-music-fab aria-label=显示音乐播放器>&#9835;</button>
<script>window.LTX_MUSIC_CONFIG={autoplay:!0,defaultCover:"",loopPlaylist:!0,startVolume:.6,tracks:[{artist:"王力宏",file:"/audio/02 - 依然爱你.mp3",title:"依然爱你"},{artist:"王力宏",file:"/audio/05 - 改变自己.mp3",title:"改变自己"},{artist:"王力宏",file:"/audio/11 - 爱错.mp3",title:"爱错"}]},function(){const a=window.LTX_MUSIC_CONFIG||{};if(!a.tracks||!a.tracks.length)return;const e=document.getElementById("ltx-music-player"),t=e.querySelector("audio"),x=e.querySelector('[data-role="title"]'),O=e.querySelector('[data-role="artist"]'),b=e.querySelector('[data-role="progress"]'),A=e.querySelector('[data-role="progress-fill"]'),F=e.querySelector('[data-role="current"]'),M=e.querySelector('[data-role="total"]'),c=e.querySelector('[data-role="tip"]'),r=e.querySelector('[data-role="cover"]'),S=e.querySelector('[data-action="toggle"]'),y=e.querySelector('[data-action="prev"]'),k=e.querySelector('[data-action="next"]'),E=e.querySelector('[data-action="mute"]'),g=e.querySelector('[data-action="collapse"]'),i=e.querySelector('[data-role="drag-handle"]'),o=document.getElementById("ltx-music-fab"),f=(e,t,n)=>Math.min(Math.max(e,t),n),j=e=>{if(!Number.isFinite(e))return"--:--";const t=Math.floor(e/60),n=Math.floor(e%60);return`${String(t).padStart(1,"0")}:${String(n).padStart(2,"0")}`},C=-120,_=220,w=180,s={active:!1,startY:0,startOffset:0,pointerId:null},n={index:0,tracks:a.tracks,autoplay:a.autoplay!==!1,loopPlaylist:a.loopPlaylist!==!1,offset:0,collapsed:!1},h=t=>{n.offset=f(t,C,_),e.style.setProperty("--ltx-offset",`${n.offset}px`)},l=t=>{const s=Boolean(t);n.collapsed=s,e.classList.toggle("ltx-collapsed",s),s?(e.classList.remove("ltx-dragging"),n.offset=0,e.style.removeProperty("--ltx-offset"),o&&(o.classList.add("ltx-visible"),o.setAttribute("aria-hidden","false"),o.tabIndex=0)):(h(0),o&&(o.classList.remove("ltx-visible"),o.setAttribute("aria-hidden","true"),o.tabIndex=-1))},m=()=>{const n=t.muted||t.volume===0;e.classList.toggle("ltx-muted",n)};t.volume=f(a.startVolume??.6,0,1),m(),l(!1);const d=()=>{const e=t.duration||0,n=t.currentTime||0,s=e?n/e*100:0;A.style.width=`${s}%`,F.textContent=j(n),M.textContent=j(e)},u=(s,o={})=>{const l=n.tracks.length;n.index=(s%l+l)%l;const i=n.tracks[n.index];if(!i||!i.file){console.warn("LTX music player: 音频文件缺失",i),c.textContent="音频文件缺失，请检查配置";return}const u=i.cover||a.defaultCover||"";r&&(u?(r.src=u,r.alt=i.title?`${i.title} 封面`:"音乐封面",e.classList.add("ltx-has-cover")):(r.removeAttribute("src"),r.alt="",e.classList.remove("ltx-has-cover"))),x.textContent=i.title||`Track ${n.index+1}`,O.textContent=i.artist||"",t.src=i.file,e.dataset.trackIndex=n.index,c.textContent="",e.classList.remove("ltx-autoplay-blocked"),d(),o.play&&p()},p=()=>{t.play().then(()=>{e.classList.remove("ltx-autoplay-blocked"),c.textContent=""}).catch(()=>{e.classList.add("ltx-autoplay-blocked"),c.textContent="浏览器阻止了自动播放，请点击播放按钮"})},v=(e=!1)=>{const o=!t.paused||e,s=n.index+1;if(s>=n.tracks.length&&!n.loopPlaylist){t.currentTime=t.duration||0,t.pause();return}u(s,{play:o})},T=()=>{const e=!t.paused;u(n.index-1,{play:e})};if(g&&g.addEventListener("click",()=>l(!0)),o&&(o.addEventListener("click",()=>l(!1)),o.setAttribute("aria-hidden","true"),o.tabIndex=-1),i){i.style.touchAction="none",i.addEventListener("pointerdown",t=>{if(n.collapsed)return;if(s.active=!0,s.pointerId=t.pointerId,s.startY=t.clientY,s.startOffset=n.offset,i.setPointerCapture)try{i.setPointerCapture(t.pointerId)}catch{}e.classList.add("ltx-dragging")}),i.addEventListener("pointermove",e=>{if(!s.active)return;const t=e.clientY-s.startY;h(s.startOffset+t)});const t=()=>{if(!s.active)return;if(s.pointerId!==null&&i.releasePointerCapture)try{i.releasePointerCapture(s.pointerId)}catch{}s.active=!1,s.pointerId=null,e.classList.remove("ltx-dragging"),n.offset>w?l(!0):h(n.offset)};["pointerup","pointercancel"].forEach(e=>{i.addEventListener(e,t)}),i.addEventListener("pointerleave",()=>{if(!s.active)return;t()})}S.addEventListener("click",()=>{t.paused?p():t.pause()}),y.addEventListener("click",T),k.addEventListener("click",()=>v(!1)),E.addEventListener("click",()=>{t.muted=!t.muted,m()}),b.addEventListener("click",e=>{const n=b.getBoundingClientRect(),s=f((e.clientX-n.left)/n.width,0,1);Number.isFinite(t.duration)&&(t.currentTime=s*t.duration)}),t.addEventListener("timeupdate",d),t.addEventListener("loadedmetadata",d),t.addEventListener("play",()=>{e.classList.add("ltx-playing"),e.classList.remove("ltx-autoplay-blocked"),c.textContent=""}),t.addEventListener("pause",()=>{e.classList.remove("ltx-playing")}),t.addEventListener("ended",()=>{v(!0)}),t.addEventListener("volumechange",m),u(0,{play:n.autoplay})}()</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>