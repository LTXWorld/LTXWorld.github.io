<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>兴趣八股之计算机网络EP01——DNS | LTX&#39;s Blog</title>
<meta name="keywords" content="DNS, 八股">
<meta name="description" content="引子
当我们不挂梯子的时候访问 www.google.com 会发生什么？ 没错，大概率是访问不到的,我的火狐浏览器会一直显示在连接但是连接不到，那么这是为什么呢？
这是因为我们的 DNS 受到了污染，也有可能遭到了劫持，至于这两者是什么意思，就请慢慢往下看吧。">
<meta name="author" content="LTX">
<link rel="canonical" href="http://localhost:1313/posts/027%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C01dns/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.87ea10c5eb6cdf9fcc27aa5665a12ed25ef08a46de7d411927d891915eb7ca57.css" integrity="sha256-h&#43;oQxets35/MJ6pWZaEu0l7wikbefUEZJ9iRkV63ylc=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.png">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/favicon.png">
<link rel="mask-icon" href="http://localhost:1313/favicon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/posts/027%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C01dns/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
<script type="text/javascript"

        async

        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">

MathJax.Hub.Config({

  tex2jax: {

    inlineMath: [['$','$'], ['\\(','\\)']],

    displayMath: [['$$','$$'], ['\[\[','\]\]']],

    processEscapes: true,

    processEnvironments: true,

    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],

    TeX: { equationNumbers: { autoNumber: "AMS" },

         extensions: ["AMSmath.js", "AMSsymbols.js"] }

  }

});


MathJax.Hub.Queue(function() {

    

    

    

    var all = MathJax.Hub.getAllJax(), i;

    for(i = 0; i < all.length; i += 1) {

        all[i].SourceElement().parentNode.className += ' has-jax';

    }

});

</script>


<style>

code.has-jax {

    font: inherit;

    font-size: 100%;

    background: inherit;

    border: inherit;

    color: #515151;

}

</style><meta property="og:url" content="http://localhost:1313/posts/027%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C01dns/">
  <meta property="og:site_name" content="LTX&#39;s Blog">
  <meta property="og:title" content="兴趣八股之计算机网络EP01——DNS">
  <meta property="og:description" content="引子 当我们不挂梯子的时候访问 www.google.com 会发生什么？ 没错，大概率是访问不到的,我的火狐浏览器会一直显示在连接但是连接不到，那么这是为什么呢？
这是因为我们的 DNS 受到了污染，也有可能遭到了劫持，至于这两者是什么意思，就请慢慢往下看吧。">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-29T14:19:24+08:00">
    <meta property="article:modified_time" content="2025-04-29T14:19:24+08:00">
    <meta property="article:tag" content="DNS">
    <meta property="article:tag" content="八股">
      <meta property="og:image" content="http://localhost:1313/images/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://localhost:1313/images/papermod-cover.png">
<meta name="twitter:title" content="兴趣八股之计算机网络EP01——DNS">
<meta name="twitter:description" content="引子
当我们不挂梯子的时候访问 www.google.com 会发生什么？ 没错，大概率是访问不到的,我的火狐浏览器会一直显示在连接但是连接不到，那么这是为什么呢？
这是因为我们的 DNS 受到了污染，也有可能遭到了劫持，至于这两者是什么意思，就请慢慢往下看吧。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "兴趣八股之计算机网络EP01——DNS",
      "item": "http://localhost:1313/posts/027%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C01dns/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "兴趣八股之计算机网络EP01——DNS",
  "name": "兴趣八股之计算机网络EP01——DNS",
  "description": "引子 当我们不挂梯子的时候访问 www.google.com 会发生什么？ 没错，大概率是访问不到的,我的火狐浏览器会一直显示在连接但是连接不到，那么这是为什么呢？\n这是因为我们的 DNS 受到了污染，也有可能遭到了劫持，至于这两者是什么意思，就请慢慢往下看吧。\n",
  "keywords": [
    "DNS", "八股"
  ],
  "articleBody": "引子 当我们不挂梯子的时候访问 www.google.com 会发生什么？ 没错，大概率是访问不到的,我的火狐浏览器会一直显示在连接但是连接不到，那么这是为什么呢？\n这是因为我们的 DNS 受到了污染，也有可能遭到了劫持，至于这两者是什么意思，就请慢慢往下看吧。\nDNS是什么 全称 domain name system\n还是拿 www.google.com 举例，这是一个 url，当我们在浏览器中输入它的时候，我们电脑中的软件会根据它将其翻译为一个具体的 IP 地址，然后访问这个 IP 从而访问到真实的网站。 这整个过程就是域名解析，没错，DNS 就是一个翻译器角色。至于它怎么翻译的，我们稍后会说。\n那我们顺便来解释一下这个 url 吧，很明显它通过 dot 分为了几个部分，因为互联网上的域名是树形结构组成的，从 .com开始是顶级域名，往左边依次递减；平时常见的 .cn .org等都是顶级域名。\n好的，知道了这些，我们就来解释一下从我们的电脑视角出发，域名解析的过程是怎么样的。\n从客户端的视角出发 发起对 url 的访问请求后\n浏览器会先检查自己有没有缓存过这个域名的 IP 地址（这叫浏览器缓存），如果没有进入下面步骤： 找本地 DNS 缓存（其他程序访问过留下的）； 找 Host 文件/etc/hosts，查看这个 url 是否有写好的对应 IP 地址； 如果有，那直接获取这个地址；如果没有，会去查我们是否有配置（在hosts中）指定的 DNS 服务器地址（比如我们常见的 8.8.8.8,或者路由器自动配置的） 如果有，电脑会向这个服务器发送 DNS 查询请求，等待其返回我们想要的 IP 地址 最终拿到 IP 地址并访问。 从服务器的角度出发 刚刚我们的电脑把解析任务都交给指定的 DNS 服务器了，那么它具体做了什么呢？\n我们平时配置的服务器都是递归（本地）服务（解析）器，而这个 DNS 服务器可能也有缓存，如果有就直接回复 如果没有，递归就会去找根域名服务器帮忙，询问：“请问 .com 顶级域名的服务器在哪里？” 根服务器会返回 .com 顶级域名服务器的地址，然后到了顶级域名服务器再问 “ google.com 的权威服务器在哪里？” 到了权威服务器后，“www.google.com 这个域名的 IP 地址是 xxxx” 最后，递归服务器问了一圈拿到了这个 IP 地址后给到电脑，电脑再给到浏览器，浏览器再拿去访问，同时缓存。 这里需要注意的是，缓存是个很重要的东东，因为这一串访问是十分耗费时间的；\n同时如果某个域名对应的 IP 地址变了或者这个域名不再使用了该怎么办？在我们的递归服务器上会对这些记录有周期记录，其生命周期一过就会重新去找各位大哥服务器寻找最新的 IP 。\n可能发生的问题 看了上面的两类流程后，你觉得可能会发生什么问题吗？我所说的问题不是解析不到 IP 的问题，有没有可能我们拿到假的 IP 地址？\n拿一个案例来说，很早以前，据坊间流言，有的网络中访问 www.google.com最终会呈现出百度的首页，这是为什么呢？\n这就引出了我们接下来要说的两个问题：DNS 污染 与 DNS 劫持。\nDNS劫持 回答我们上面案例中的问题，这是因为我们的 DNS 被污染了——在某些运营商的网络下，它会给我们自动设置 DNS 递归服务器地址.\nAnd by default, the OS will just use whatever resolver the network told it to. When the computer connects to the network and gets its IP address, the network recommends a resolver to use.\n在我们进行 DNS 解析的过程中，它会将递归服务器中有关 www.google.com的对应 IP 地址悄悄地“更改”为百度的 IP 地址（至于其为什么这么做，肯定是与百度有合作的啦）\n这就造成我们每次访问谷歌的时候在递归服务器的缓存中都是百度的 IP 地址，自然就跳转到了百度的首页。\n这整个过程就是 DNS 劫持。\n如何做到劫持 劫持通常都是 ISP（运营商）干的好事，如果我们用它自动设置的递归服务器地址，那么就得按照这个服务器上的规则来，它一旦修改了某个域名对应的 IP 地址，我们自然就被劫持了。\nThat’s because the resolver itself — the one that the network gives to you — could be untrustworthy.\n如何应对劫持 最简单的的方法就是修改我们 hosts 文件中的 DNS递归服务器的地址，不再是运营商为我们自动分配的，比如改成8.8.8.8,8.8.4.4这些常见的地址。\n这些是谷歌提供的地址，谷歌不至于劫持我们的 DNS 请求吧，这就可以避免 ISP 根据其递归服务器地址来劫持我们的请求。 Firefox的应对方法是使用 Cloudflare 作为他们的递归服务器，因为 Cloudflare 承诺保证用户的隐私性。\n但是这并不能解决所有问题，因为 DNS 查询的明文性，还是会有可能直接拦截 UDP/53 端口并进行重定向。\n那怎么办？诶，还有对策，但是这里的对策涉及到了其他知识点，我们先放放，待会儿再说。\nDNS污染 除了劫持这种直接的手段以外，还存在更高明的手段，就算我们修改了递归服务器的地址，DNS 污染也能让我们访问不到正确的网站。\n这是因为在 DNS 应答的过程中存在时间差，我们得等 DNS 递归服务器去外面兜一圈，但是等到它回来发现家都被偷了！\n其实 DNS 污染还有一个更加可怕的名字，DNS 投毒。至于为什么，请看下面的内容。\n如何做到污染 This means that every server that you ask to help with domain name resolution sees what site you’re looking for. But more than that, it also means that anyone on the path to those servers sees your requests, too.\n上面说过，DNS 查询的过程是明文的（UDP/53）。 所以这条查询路上的中间人可以监听你的 DNS 请求包，并快速伪造一个虚假的 DNS 响应包抢在真正的回应前返回，这样我们就会拿到错误的 IP 地址。\n那为什么又叫做投毒呢？假如我们不用国外的递归服务器，还是用国内 ISP 的，ISP 并没有发生劫持。 但是我们要访问一些国外的网站，那这些请求就一定要出海，在这个过程中有人对我们进行 DNS 污染，这会导致什么后果呢？还记得我们前面说到的重要的缓存吗？这就会让国内的服务器上记录这些域名与其错误的 IP 地址，那久而久之，广而广之，所有的国内服务器是不是已经全部被污染了！\n最终，我们从任何一个国内服务器访问这些网站都会定向到假的 IP 地址，这就达到了恐怖的投毒效果，火烧连营啊！\n如何应对污染 从原理看我们已经发现了DNS 过程的脆弱性了，DNS 查询过程是明文的，我们对其加密不就好了吗？\n这样，就引出了 DNSSEC, DoT, DoH 这三种更为高级的 DNS 技术。来看看怎么回事。\n高级的DNS DNSSEC 这是出现较早的一种方法，它的目的是保证数据的完整性，确保 DNS 的响应不被篡改。怎么做到的呢？\n增加了数字签名机制，会在每一级使用数字签名来证明下一级的可信性。 回到我们服务器的角度，DNS 递归解析器内置了根域的公钥，根服务器会返回 .com的DNSKEY,NS记录，用根的公钥验证.com的DNSKEY，用这个DNSKEY 验证 NS 记录，依次类推。\n整个过程就是：上一级用数字签名告诉你：“下一级公钥是真的”，从根开始，逐级验证，一环都不能断。 所以完整性由上级域保证，其他人就无法篡改我们的内容了，就算你返回一个假的响应包过来，没有签名验证，我们客户端的递归服务器是不要的。\n但是，诶，是不是还有些问题？我们只保证了数据的完整性，但是数据的加密没有得到保证\n别人依然能看到我们这个 DNS 请求是往哪里去的，隐私在别人面前暴露无疑。 劫持仍有可能发生，因为我们本机与递归服务器之间还有一段传输过程，这一段传输过程没人管啊。 因为上述缺点，引出下面两个更加强大的方式。\nDoT 全称 DNS over TLS,通过TLS协议加密DNS查询和响应，防止窃听和篡改.（关于TLS如何做到这一点，见这篇文章） 专用端口853运行DNS over TLS，与传统明文DNS（UDP 53端口）隔离；TLS握手：客户端与递归服务器建立加密连接。\n协议栈如下：\n-------- DoT -------- TLS -------- TCP -------- IP -------- 缺点在于853端口可能被 ISP 禁用，客户端也就是我们的电脑或者浏览器需要支持 DoT,目前很多的浏览器更多地在用 DoH，至于为什么请往下看。\nDoH 全称 DNS over HTTPS,诶，相比于 DoT多了什么？多了HTTP！（HTTPS=HTTP+TLS）\n协议栈如下：\n-------- DoH -------- HTTP -------- TLS -------- TCP -------- IP -------- 同时还可以做到将 DNS 查询伪装成普通 HTTPS 流量，绕过审查和干扰（DNS查询通过HTTP/2或HTTP/3传输，端口443，与网页流量混合）\n由于集成了 HTTP 的缘故，像 Firefox, Chrome 等浏览器都集成这个功能，但是比 DoT来说更大了。\n并且有的浏览器和服务商也根据 DoH 对 DNS 的过程进行了优化，例如循环访问的过程只携带部分信息。QNAME minization（我们上面举例的过程其实就做到了QNAME minization）\n潜在问题 在 HTTPS的过程中，有这样一个问题：你访问网站时最开始的 SNI 还是明文，可能被 ISP 知道你访问了什么站；但一旦 TLS 建立成功，你访问服务器上其他站点的过程是加密的，也更私密了。\n这一点我们在后续有关HTTPS的文章中详细讨论。\n总结 DNS 作为域名与 IP 地址之间的翻译器，会通过一系列的 recursive resolve 来进行翻译。 在这个过程中可能会遇到 DNS 劫持和污染，为了防止这些问题，其采用了 DNSSEC, DoT, DoH 等策略来对传输的数据进行加密和防止篡改。\n最后关于文章一开始说的挂梯子的操作，其为什么可以让我们访问到原本被污染或者劫持的网站，简单来讲是因为 VPN 会加密所有流量（包括 DNS），这样攻击者就无法识别我们这些流量的作用，自然就不能轻易地攻击我们。（关于 VPN 如何加密后面考虑出一篇文章）\n这里是LTX，感谢您阅读这篇博客，人生海海，和自己对话，像只蝴蝶纵横四海。\n引用 https://hacks.mozilla.org/2018/05/a-cartoon-intro-to-dns-over-https/ ChatGPT \u0026 DeepSeek ",
  "wordCount" : "3564",
  "inLanguage": "zh",
  "image": "http://localhost:1313/images/papermod-cover.png","datePublished": "2025-04-29T14:19:24+08:00",
  "dateModified": "2025-04-29T14:19:24+08:00",
  "author":{
    "@type": "Person",
    "name": "LTX"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/027%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C01dns/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LTX's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="LTX&#39;s Blog (Alt + H)">LTX&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="LTX&#39;s Blog">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives/" title="归档">
                    <span>归档</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="Categories">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="后花园">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      兴趣八股之计算机网络EP01——DNS
    </h1>
    <div class="post-meta"><span title='2025-04-29 14:19:24 +0800 CST'>四月 29, 2025</span>&nbsp;·&nbsp;8 分钟&nbsp;·&nbsp;LTX

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%bc%95%e5%ad%90" aria-label="引子">引子</a></li>
                <li>
                    <a href="#dns%e6%98%af%e4%bb%80%e4%b9%88" aria-label="DNS是什么">DNS是什么</a><ul>
                        
                <li>
                    <a href="#%e4%bb%8e%e5%ae%a2%e6%88%b7%e7%ab%af%e7%9a%84%e8%a7%86%e8%a7%92%e5%87%ba%e5%8f%91" aria-label="从客户端的视角出发">从客户端的视角出发</a></li>
                <li>
                    <a href="#%e4%bb%8e%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e8%a7%92%e5%ba%a6%e5%87%ba%e5%8f%91" aria-label="从服务器的角度出发">从服务器的角度出发</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%8f%af%e8%83%bd%e5%8f%91%e7%94%9f%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="可能发生的问题">可能发生的问题</a><ul>
                        
                <li>
                    <a href="#dns%e5%8a%ab%e6%8c%81" aria-label="DNS劫持">DNS劫持</a><ul>
                        
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%81%9a%e5%88%b0%e5%8a%ab%e6%8c%81" aria-label="如何做到劫持">如何做到劫持</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%ba%94%e5%af%b9%e5%8a%ab%e6%8c%81" aria-label="如何应对劫持">如何应对劫持</a></li></ul>
                </li>
                <li>
                    <a href="#dns%e6%b1%a1%e6%9f%93" aria-label="DNS污染">DNS污染</a><ul>
                        
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%81%9a%e5%88%b0%e6%b1%a1%e6%9f%93" aria-label="如何做到污染">如何做到污染</a></li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e5%ba%94%e5%af%b9%e6%b1%a1%e6%9f%93" aria-label="如何应对污染">如何应对污染</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e9%ab%98%e7%ba%a7%e7%9a%84dns" aria-label="高级的DNS">高级的DNS</a><ul>
                        
                <li>
                    <a href="#dnssec" aria-label="DNSSEC">DNSSEC</a></li>
                <li>
                    <a href="#dot" aria-label="DoT">DoT</a></li>
                <li>
                    <a href="#doh" aria-label="DoH">DoH</a><ul>
                        
                <li>
                    <a href="#%e6%bd%9c%e5%9c%a8%e9%97%ae%e9%a2%98" aria-label="潜在问题">潜在问题</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li>
                <li>
                    <a href="#%e5%bc%95%e7%94%a8" aria-label="引用">引用</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="引子">引子<a hidden class="anchor" aria-hidden="true" href="#引子">#</a></h2>
<p>当我们不挂梯子的时候访问 <code>www.google.com</code> 会发生什么？ 没错，大概率是访问不到的,我的火狐浏览器会一直显示在连接但是连接不到，那么这是为什么呢？</p>
<p>这是因为我们的 DNS 受到了污染，也有可能遭到了劫持，至于这两者是什么意思，就请慢慢往下看吧。</p>
<p><img alt="shu" loading="lazy" src="/img/shu/%E8%BA%BA%E5%B9%B3.webp"></p>
<h2 id="dns是什么">DNS是什么<a hidden class="anchor" aria-hidden="true" href="#dns是什么">#</a></h2>
<p>全称 <strong>domain name system</strong></p>
<p>还是拿 <code>www.google.com</code> 举例，这是一个 url，当我们在浏览器中输入它的时候，我们电脑中的软件会根据它将其翻译为一个具体的 IP 地址，然后访问这个 IP 从而访问到真实的网站。
这整个过程就是域名解析，没错，DNS 就是一个翻译器角色。至于它怎么翻译的，我们稍后会说。</p>
<p>那我们顺便来解释一下这个 url 吧，很明显它通过 dot 分为了几个部分，因为互联网上的域名是树形结构组成的，从 <code>.com</code>开始是顶级域名，往左边依次递减；平时常见的 <code>.cn .org</code>等都是顶级域名。</p>
<p>好的，知道了这些，我们就来解释一下从我们的电脑视角出发，域名解析的过程是怎么样的。</p>
<h3 id="从客户端的视角出发">从客户端的视角出发<a hidden class="anchor" aria-hidden="true" href="#从客户端的视角出发">#</a></h3>
<p>发起对 url 的访问请求后</p>
<ul>
<li>浏览器会先检查自己有没有缓存过这个域名的 IP 地址（这叫浏览器缓存），如果没有进入下面步骤：</li>
<li>找本地 DNS 缓存（其他程序访问过留下的）；</li>
<li>找 Host 文件<code>/etc/hosts</code>，查看这个 url 是否有写好的对应 IP 地址；</li>
<li>如果有，那直接获取这个地址；如果没有，会去查我们是否有配置（在hosts中）指定的 DNS 服务器地址（比如我们常见的 8.8.8.8,或者路由器自动配置的）</li>
<li>如果有，电脑会向这个服务器发送 DNS 查询请求，等待其返回我们想要的 IP 地址</li>
<li>最终拿到 IP 地址并访问。</li>
</ul>
<h3 id="从服务器的角度出发">从服务器的角度出发<a hidden class="anchor" aria-hidden="true" href="#从服务器的角度出发">#</a></h3>
<p>刚刚我们的电脑把解析任务都交给指定的 DNS 服务器了，那么它具体做了什么呢？</p>
<ul>
<li>我们平时配置的服务器都是<strong>递归（本地）服务（解析）器</strong>，而这个 DNS 服务器可能也有缓存，如果有就直接回复</li>
<li>如果没有，递归就会去找<strong>根域名服务器</strong>帮忙，询问：“请问 .com 顶级域名的服务器在哪里？”</li>
<li>根服务器会返回 .com 顶级域名服务器的地址，然后到了<strong>顶级域名服务器</strong>再问 “ google.com 的权威服务器在哪里？”</li>
<li>到了权威服务器后，&ldquo;<a href="https://www.google.com">www.google.com</a> 这个域名的 IP 地址是 xxxx&rdquo;</li>
<li>最后，递归服务器问了一圈拿到了这个 IP 地址后给到电脑，电脑再给到浏览器，浏览器再拿去访问，同时缓存。</li>
</ul>
<p>这里需要注意的是，缓存是个很重要的东东，因为这一串访问是十分耗费时间的；</p>
<p>同时如果某个域名对应的 IP 地址变了或者这个域名不再使用了该怎么办？在我们的递归服务器上会对这些记录有<strong>周期记录</strong>，其生命周期一过就会重新去找各位大哥服务器寻找最新的 IP 。</p>
<h2 id="可能发生的问题">可能发生的问题<a hidden class="anchor" aria-hidden="true" href="#可能发生的问题">#</a></h2>
<p>看了上面的两类流程后，你觉得可能会发生什么问题吗？我所说的问题不是解析不到 IP 的问题，有没有可能我们拿到假的 IP 地址？</p>
<p>拿一个案例来说，很早以前，据坊间流言，有的网络中访问 <code>www.google.com</code>最终会呈现出百度的首页，这是为什么呢？</p>
<p>这就引出了我们接下来要说的两个问题：DNS 污染 与 DNS 劫持。</p>
<h3 id="dns劫持">DNS劫持<a hidden class="anchor" aria-hidden="true" href="#dns劫持">#</a></h3>
<p>回答我们上面案例中的问题，这是因为我们的 DNS 被污染了——在某些运营商的网络下，它会给我们自动设置 DNS 递归服务器地址.</p>
<blockquote>
<p>And by default, the OS will just use whatever resolver the network told it to. When the computer connects to the network and gets its IP address, the network recommends a resolver to use.</p></blockquote>
<p>在我们进行 DNS 解析的过程中，它会将递归服务器中有关 <code>www.google.com</code>的对应 IP 地址悄悄地“更改”为百度的 IP 地址（至于其为什么这么做，肯定是与百度有合作的啦）</p>
<p>这就造成我们每次访问谷歌的时候在递归服务器的缓存中都是百度的 IP 地址，自然就跳转到了百度的首页。</p>
<p>这整个过程就是 DNS 劫持。</p>
<h4 id="如何做到劫持">如何做到劫持<a hidden class="anchor" aria-hidden="true" href="#如何做到劫持">#</a></h4>
<p>劫持通常都是 ISP（运营商）干的好事，如果我们用它自动设置的递归服务器地址，那么就得按照这个服务器上的规则来，它一旦修改了某个域名对应的 IP 地址，我们自然就被劫持了。</p>
<blockquote>
<p>That’s because the resolver itself — the one that the network gives to you — could be untrustworthy.</p></blockquote>
<h4 id="如何应对劫持">如何应对劫持<a hidden class="anchor" aria-hidden="true" href="#如何应对劫持">#</a></h4>
<p>最简单的的方法就是修改我们 hosts 文件中的 DNS递归服务器的地址，不再是运营商为我们自动分配的，比如改成<code>8.8.8.8,8.8.4.4</code>这些常见的地址。</p>
<p>这些是谷歌提供的地址，谷歌不至于劫持我们的 DNS 请求吧，这就可以避免 ISP 根据其递归服务器地址来劫持我们的请求。
Firefox的应对方法是使用 Cloudflare 作为他们的递归服务器，因为 Cloudflare 承诺保证用户的隐私性。</p>
<p>但是这并不能解决所有问题，因为 DNS 查询的明文性，还是会有可能直接拦截 UDP/53 端口并进行重定向。</p>
<p><img alt="heishou" loading="lazy" src="/img/G/%E9%BB%91%E6%89%8B.jpg"></p>
<p>那怎么办？诶，还有对策，但是这里的对策涉及到了其他知识点，我们先放放，待会儿再说。</p>
<h3 id="dns污染">DNS污染<a hidden class="anchor" aria-hidden="true" href="#dns污染">#</a></h3>
<p>除了劫持这种直接的手段以外，还存在更高明的手段，就算我们修改了递归服务器的地址，DNS 污染也能让我们访问不到正确的网站。</p>
<p>这是因为在 DNS 应答的过程中存在时间差，我们得等 DNS 递归服务器去外面兜一圈，但是等到它回来发现家都被偷了！</p>
<p><img alt="chui" loading="lazy" src="/img/jb/%E9%94%A4.webp"></p>
<p>其实 DNS 污染还有一个更加可怕的名字，DNS 投毒。至于为什么，请看下面的内容。</p>
<h4 id="如何做到污染">如何做到污染<a hidden class="anchor" aria-hidden="true" href="#如何做到污染">#</a></h4>
<blockquote>
<p>This means that every server that you ask to help with domain name resolution sees what site you’re looking for. But more than that, it also means that anyone on the path to those servers sees your requests, too.</p></blockquote>
<p>上面说过，DNS 查询的过程是明文的（UDP/53）。
所以这条查询路上的中间人可以监听你的 DNS 请求包，并快速伪造一个虚假的 DNS 响应包抢在真正的回应前返回，这样我们就会拿到错误的 IP 地址。</p>
<p>那为什么又叫做投毒呢？假如我们不用国外的递归服务器，还是用国内 ISP 的，ISP 并没有发生劫持。
但是我们要访问一些国外的网站，那这些请求就一定要出海，在这个过程中有人对我们进行 DNS 污染，这会导致什么后果呢？还记得我们前面说到的重要的缓存吗？这就会让国内的服务器上记录这些域名与其错误的 IP 地址，那久而久之，广而广之，所有的国内服务器是不是已经全部被污染了！</p>
<p>最终，我们从任何一个国内服务器访问这些网站都会定向到假的 IP 地址，这就达到了恐怖的投毒效果，火烧连营啊！</p>
<p><img alt="huoshao" loading="lazy" src="/img/G/hsly.webp"></p>
<h4 id="如何应对污染">如何应对污染<a hidden class="anchor" aria-hidden="true" href="#如何应对污染">#</a></h4>
<p>从原理看我们已经发现了DNS 过程的脆弱性了，DNS 查询过程是明文的，我们对其加密不就好了吗？</p>
<p>这样，就引出了 DNSSEC, DoT, DoH 这三种更为高级的 DNS 技术。来看看怎么回事。</p>
<h2 id="高级的dns">高级的DNS<a hidden class="anchor" aria-hidden="true" href="#高级的dns">#</a></h2>
<h3 id="dnssec">DNSSEC<a hidden class="anchor" aria-hidden="true" href="#dnssec">#</a></h3>
<p>这是出现较早的一种方法，它的目的是保证<strong>数据的完整性</strong>，确保 DNS 的响应不被篡改。怎么做到的呢？</p>
<p>增加了数字签名机制，会在每一级使用数字签名来证明下一级的可信性。
回到我们服务器的角度，DNS 递归解析器内置了根域的<strong>公钥</strong>，根服务器会返回 <code>.com</code>的DNSKEY,NS记录，用根的公钥验证<code>.com</code>的DNSKEY，用这个DNSKEY 验证 NS 记录，依次类推。</p>
<p>整个过程就是：上一级用数字签名告诉你：“下一级公钥是真的”，从根开始，逐级验证，一环都不能断。
所以完整性由上级域保证，其他人就无法篡改我们的内容了，就算你返回一个假的响应包过来，没有签名验证，我们客户端的递归服务器是不要的。</p>
<p>但是，诶，是不是还有些问题？我们只保证了数据的完整性，但是数据的加密没有得到保证</p>
<ul>
<li>别人依然能看到我们这个 DNS 请求是往哪里去的，隐私在别人面前暴露无疑。</li>
<li>劫持仍有可能发生，因为我们本机与递归服务器之间还有一段传输过程，这一段传输过程没人管啊。</li>
</ul>
<p>因为上述缺点，引出下面两个更加强大的方式。</p>
<p><img alt="wxkj" loading="lazy" src="/img/G/wxkj.webp"></p>
<h3 id="dot">DoT<a hidden class="anchor" aria-hidden="true" href="#dot">#</a></h3>
<p>全称 DNS over TLS,通过TLS协议加密DNS查询和响应，防止窃听和篡改.（关于TLS如何做到这一点，见这篇文章）
专用端口853运行DNS over TLS，与传统明文DNS（UDP 53端口）隔离；TLS握手：客户端与递归服务器建立加密连接。</p>
<p>协议栈如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">--------
</span></span><span class="line"><span class="cl">  DoT
</span></span><span class="line"><span class="cl">--------
</span></span><span class="line"><span class="cl">  TLS
</span></span><span class="line"><span class="cl">--------
</span></span><span class="line"><span class="cl">  TCP
</span></span><span class="line"><span class="cl">--------
</span></span><span class="line"><span class="cl">  IP
</span></span><span class="line"><span class="cl">--------
</span></span></code></pre></div><p>缺点在于853端口可能被 ISP 禁用，客户端也就是我们的电脑或者浏览器需要支持 DoT,目前很多的浏览器更多地在用 DoH，至于为什么请往下看。</p>
<h3 id="doh">DoH<a hidden class="anchor" aria-hidden="true" href="#doh">#</a></h3>
<p>全称 DNS over HTTPS,诶，相比于 DoT多了什么？多了HTTP！（HTTPS=HTTP+TLS）</p>
<p>协议栈如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">--------
</span></span><span class="line"><span class="cl">  DoH
</span></span><span class="line"><span class="cl">--------
</span></span><span class="line"><span class="cl">  HTTP
</span></span><span class="line"><span class="cl">--------
</span></span><span class="line"><span class="cl">  TLS
</span></span><span class="line"><span class="cl">--------
</span></span><span class="line"><span class="cl">  TCP
</span></span><span class="line"><span class="cl">--------
</span></span><span class="line"><span class="cl">  IP
</span></span><span class="line"><span class="cl">--------
</span></span></code></pre></div><p>同时还可以做到将 DNS 查询伪装成普通 HTTPS 流量，绕过审查和干扰（DNS查询通过HTTP/2或HTTP/3传输，端口443，与网页流量混合）</p>
<p>由于集成了 HTTP 的缘故，像 Firefox, Chrome 等浏览器都集成这个功能，但是比 DoT来说更大了。</p>
<p>并且有的浏览器和服务商也根据 DoH 对 DNS 的过程进行了优化，例如循环访问的过程只携带部分信息。<a href="https://datatracker.ietf.org/doc/rfc7816/?include_text=1">QNAME minization</a>（我们上面举例的过程其实就做到了QNAME minization）</p>
<h4 id="潜在问题">潜在问题<a hidden class="anchor" aria-hidden="true" href="#潜在问题">#</a></h4>
<p>在 HTTPS的过程中，有这样一个问题：你访问网站时最开始的 SNI 还是明文，可能被 ISP 知道你访问了什么站；但一旦 TLS 建立成功，你访问服务器上其他站点的过程是加密的，也更私密了。</p>
<p>这一点我们在后续有关HTTPS的文章中详细讨论。</p>
<h2 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h2>
<p>DNS 作为域名与 IP 地址之间的翻译器，会通过一系列的 recursive resolve 来进行翻译。
在这个过程中可能会遇到 DNS 劫持和污染，为了防止这些问题，其采用了 DNSSEC, DoT, DoH 等策略来对传输的数据进行加密和防止篡改。</p>
<p>最后关于文章一开始说的挂梯子的操作，其为什么可以让我们访问到原本被污染或者劫持的网站，简单来讲是因为 VPN 会加密所有流量（包括 DNS），这样攻击者就无法识别我们这些流量的作用，自然就不能轻易地攻击我们。（关于 VPN 如何加密后面考虑出一篇文章）</p>
<p><strong>这里是LTX，感谢您阅读这篇博客，人生海海，和自己对话，像只蝴蝶纵横四海。</strong></p>
<h2 id="引用">引用<a hidden class="anchor" aria-hidden="true" href="#引用">#</a></h2>
<ul>
<li><a href="https://hacks.mozilla.org/2018/05/a-cartoon-intro-to-dns-over-https/">https://hacks.mozilla.org/2018/05/a-cartoon-intro-to-dns-over-https/</a></li>
<li>ChatGPT &amp; DeepSeek</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/dns/">DNS</a></li>
      <li><a href="http://localhost:1313/tags/%E5%85%AB%E8%82%A1/">八股</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/028%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C02https/">
    <span class="title">« 上一页</span>
    <br>
    <span>兴趣八股之计算机网络EP02——HTTPS</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/026%E5%A5%87%E6%80%9D%E4%B9%B1%E6%83%B3ep03%E8%AE%A9%E4%BA%BA%E4%B8%8A%E7%98%BE%E7%9A%84app/">
    <span class="title">下一页 »</span>
    <br>
    <span>LT的奇思乱想EP03——让人上瘾的APP们</span>
  </a>
</nav>

  </footer><div id="tw-comment"></div>

<script>

    

    const getStoredTheme = () => localStorage.getItem("pref-theme") === "light" ? "light" : "dark";

    const setGiscusTheme = () => {

        const sendMessage = (message) => {

            const iframe = document.querySelector('iframe.giscus-frame');

            if (iframe) {

                iframe.contentWindow.postMessage({giscus: message}, 'https://giscus.app');

            }

        }

        sendMessage({setConfig: {theme: getStoredTheme()}})

    }


    document.addEventListener("DOMContentLoaded", () => {

        const giscusAttributes = {

            "src": "https://giscus.app/client.js",

            "data-repo": "LTXWorld\/LTXWorld.github.io",

            "data-repo-id": "R_kgDONODUuA",

            "data-category": "Announcements",

            "data-category-id": "DIC_kwDONODUuM4CkMUw",

            "data-mapping": "pathname",

            "data-strict": "0",

            "data-reactions-enabled": "1",

            "data-emit-metadata": "0",

            "data-input-position": "bottom",

            "data-theme": getStoredTheme(),

            "data-lang": "zh-CN",

            "data-loading": "lazy",

            "crossorigin": "anonymous",

        };


        

        const giscusScript = document.createElement("script");

        Object.entries(giscusAttributes).forEach(

                ([key, value]) => giscusScript.setAttribute(key, value));

        document.querySelector("#tw-comment").appendChild(giscusScript);


        

        const themeSwitcher = document.querySelector("#theme-toggle");

        if (themeSwitcher) {

            themeSwitcher.addEventListener("click", setGiscusTheme);

        }

        const themeFloatSwitcher = document.querySelector("#theme-toggle-float");

        if (themeFloatSwitcher) {

            themeFloatSwitcher.addEventListener("click", setGiscusTheme);

        }

    });

</script>
</article>
    </main>
    
<footer class="footer">
        <span><a href="https://LTXWorld.github.io/">©2025 LTX&rsquo;s Blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><div class="ltx-music-player" id="ltx-music-player" role="group" aria-label="背景音乐播放器">
  <audio id="ltx-music-audio" preload="metadata"></audio>
  <div class="ltx-music-meta">
    <span class="ltx-music-title" data-role="title"></span>
    <span class="ltx-music-artist" data-role="artist"></span>
  </div>
  <div class="ltx-music-progress" data-role="progress" aria-label="进度条" role="slider">
    <div class="ltx-music-progress-fill" data-role="progress-fill"></div>
  </div>
  <div class="ltx-music-time">
    <span data-role="current">0:00</span>
    <span data-role="total">--:--</span>
  </div>
  <div class="ltx-music-controls">
    <button type="button" data-action="prev" aria-label="上一首">⏮</button>
    <button type="button" data-action="toggle" aria-label="播放或暂停">
      <span data-icon="play">▶</span>
      <span data-icon="pause">⏸</span>
    </button>
    <button type="button" data-action="next" aria-label="下一首">⏭</button>
    <button type="button" data-action="mute" aria-label="静音或取消静音">
      <span data-icon="unmuted">🔊</span>
      <span data-icon="muted">🔇</span>
    </button>
  </div>
  <div class="ltx-autoplay-tip" data-role="tip" aria-live="polite"></div>
</div>
<script>
  window.LTX_MUSIC_CONFIG = {"autoplay":true,"loopPlaylist":true,"startVolume":0.6,"tracks":[{"artist":"王力宏","file":"/audio/02 - 依然爱你.mp3","title":"依然爱你"},{"artist":"王力宏","file":"/audio/05 - 改变自己.mp3","title":"改变自己"},{"artist":"王力宏","file":"/audio/11 - 爱错.mp3","title":"爱错"}]};
  (function () {
    const config = window.LTX_MUSIC_CONFIG || {};
    if (!config.tracks || !config.tracks.length) {
      return;
    }

    const player = document.getElementById('ltx-music-player');
    const audio = player.querySelector('audio');
    const titleEl = player.querySelector('[data-role="title"]');
    const artistEl = player.querySelector('[data-role="artist"]');
    const progressEl = player.querySelector('[data-role="progress"]');
    const progressFillEl = player.querySelector('[data-role="progress-fill"]');
    const currentTimeEl = player.querySelector('[data-role="current"]');
    const totalTimeEl = player.querySelector('[data-role="total"]');
    const tipEl = player.querySelector('[data-role="tip"]');

    const toggleBtn = player.querySelector('[data-action="toggle"]');
    const prevBtn = player.querySelector('[data-action="prev"]');
    const nextBtn = player.querySelector('[data-action="next"]');
    const muteBtn = player.querySelector('[data-action="mute"]');

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
    const formatTime = (seconds) => {
      if (!Number.isFinite(seconds)) {
        return '--:--';
      }
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${String(mins).padStart(1, '0')}:${String(secs).padStart(2, '0')}`;
    };

    const state = {
      index: 0,
      tracks: config.tracks,
      autoplay: config.autoplay !== false,
      loopPlaylist: config.loopPlaylist !== false,
    };

    const updateMuteClass = () => {
      const muted = audio.muted || audio.volume === 0;
      player.classList.toggle('ltx-muted', muted);
    };

    audio.volume = clamp(config.startVolume ?? 0.6, 0, 1);
    updateMuteClass();

    const updateProgress = () => {
      const duration = audio.duration || 0;
      const current = audio.currentTime || 0;
      const percentage = duration ? (current / duration) * 100 : 0;
      progressFillEl.style.width = `${percentage}%`;
      currentTimeEl.textContent = formatTime(current);
      totalTimeEl.textContent = formatTime(duration);
    };

    const setTrack = (nextIndex, options = {}) => {
      const total = state.tracks.length;
      state.index = ((nextIndex % total) + total) % total;
      const track = state.tracks[state.index];
      if (!track || !track.file) {
        console.warn('LTX music player: 音频文件缺失', track);
        tipEl.textContent = '音频文件缺失，请检查配置';
        return;
      }
      titleEl.textContent = track.title || `Track ${state.index + 1}`;
      artistEl.textContent = track.artist || '';
      audio.src = track.file;
      player.dataset.trackIndex = state.index;
      tipEl.textContent = '';
      player.classList.remove('ltx-autoplay-blocked');
      updateProgress();
      if (options.play) {
        attemptPlay();
      }
    };

    const attemptPlay = () => {
      audio.play().then(() => {
        player.classList.remove('ltx-autoplay-blocked');
        tipEl.textContent = '';
      }).catch(() => {
        player.classList.add('ltx-autoplay-blocked');
        tipEl.textContent = '浏览器阻止了自动播放，请点击播放按钮';
      });
    };

    const playNext = (autoTriggered = false) => {
      const shouldPlay = !audio.paused || autoTriggered;
      const nextIndex = state.index + 1;
      if (nextIndex >= state.tracks.length && !state.loopPlaylist) {
        audio.currentTime = audio.duration || 0;
        audio.pause();
        return;
      }
      setTrack(nextIndex, { play: shouldPlay });
    };

    const playPrev = () => {
      const shouldPlay = !audio.paused;
      setTrack(state.index - 1, { play: shouldPlay });
    };

    toggleBtn.addEventListener('click', () => {
      if (audio.paused) {
        attemptPlay();
      } else {
        audio.pause();
      }
    });

    prevBtn.addEventListener('click', playPrev);
    nextBtn.addEventListener('click', () => playNext(false));

    muteBtn.addEventListener('click', () => {
      audio.muted = !audio.muted;
      updateMuteClass();
    });

    progressEl.addEventListener('click', (event) => {
      const rect = progressEl.getBoundingClientRect();
      const ratio = clamp((event.clientX - rect.left) / rect.width, 0, 1);
      if (Number.isFinite(audio.duration)) {
        audio.currentTime = ratio * audio.duration;
      }
    });

    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', updateProgress);

    audio.addEventListener('play', () => {
      player.classList.add('ltx-playing');
      player.classList.remove('ltx-autoplay-blocked');
      tipEl.textContent = '';
    });

    audio.addEventListener('pause', () => {
      player.classList.remove('ltx-playing');
    });

    audio.addEventListener('ended', () => {
      playNext(true);
    });

    audio.addEventListener('volumechange', updateMuteClass);

    setTrack(0, { play: state.autoplay });
  })();
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
