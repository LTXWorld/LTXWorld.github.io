<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>K3sEP12â€”â€”ç›‘æ§é›†ç¾¤çš„ä¸¤ç§æ–¹å¼ | LTX's Blog</title>
<meta name=keywords content="K3s,RiscV,ç›‘æ§"><meta name=description content="å¼•å­
ä¸ºäº†æ›´å¥½åœ°ç®¡ç†é›†ç¾¤,æˆ‘ä»¬æ‰“ç®—ä½¿ç”¨å·¥å…·ç›‘æ§é›†ç¾¤, k8s é¦–æ¨çš„æ˜¯ metric-server;
åœ¨å…¶ä»–ä¹¦ç±ä¸­æˆ‘çœ‹åˆ°çš„ä½¿ç”¨ prometheus(æ™®ç½—ç±³ä¿®æ–¯),æ‰€ä»¥æˆ‘ä»¬å¯¹äºŒè€…éƒ½è¿›è¡Œä¸€ä¸ªæµ‹è¯•."><meta name=author content="LTX"><link rel=canonical href=https://LTXWorld.github.io/posts/038k3sep12%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4/><link crossorigin=anonymous href=/assets/css/stylesheet.c8ce79b6b2fa93a6f3465e7adf11510ca336c9c5f1e952a18dc605f3b152b55e.css integrity="sha256-yM55trL6k6bzRl563xFRDKM2ycXx6VKhjcYF87FStV4=" rel="preload stylesheet" as=style><link rel=icon href=https://LTXWorld.github.io/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://LTXWorld.github.io/favicon.png><link rel=icon type=image/png sizes=32x32 href=https://LTXWorld.github.io/favicon.png><link rel=apple-touch-icon href=https://LTXWorld.github.io/favicon.png><link rel=mask-icon href=https://LTXWorld.github.io/favicon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://LTXWorld.github.io/posts/038k3sep12%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><meta property="og:url" content="https://LTXWorld.github.io/posts/038k3sep12%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4/"><meta property="og:site_name" content="LTX's Blog"><meta property="og:title" content="K3sEP12â€”â€”ç›‘æ§é›†ç¾¤çš„ä¸¤ç§æ–¹å¼"><meta property="og:description" content="å¼•å­ ä¸ºäº†æ›´å¥½åœ°ç®¡ç†é›†ç¾¤,æˆ‘ä»¬æ‰“ç®—ä½¿ç”¨å·¥å…·ç›‘æ§é›†ç¾¤, k8s é¦–æ¨çš„æ˜¯ metric-server; åœ¨å…¶ä»–ä¹¦ç±ä¸­æˆ‘çœ‹åˆ°çš„ä½¿ç”¨ prometheus(æ™®ç½—ç±³ä¿®æ–¯),æ‰€ä»¥æˆ‘ä»¬å¯¹äºŒè€…éƒ½è¿›è¡Œä¸€ä¸ªæµ‹è¯•."><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-18T18:29:58+08:00"><meta property="article:modified_time" content="2025-05-18T18:29:58+08:00"><meta property="article:tag" content="K3s"><meta property="article:tag" content="RiscV"><meta property="article:tag" content="ç›‘æ§"><meta property="og:image" content="https://LTXWorld.github.io/images/papermod-cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://LTXWorld.github.io/images/papermod-cover.png"><meta name=twitter:title content="K3sEP12â€”â€”ç›‘æ§é›†ç¾¤çš„ä¸¤ç§æ–¹å¼"><meta name=twitter:description content="å¼•å­
ä¸ºäº†æ›´å¥½åœ°ç®¡ç†é›†ç¾¤,æˆ‘ä»¬æ‰“ç®—ä½¿ç”¨å·¥å…·ç›‘æ§é›†ç¾¤, k8s é¦–æ¨çš„æ˜¯ metric-server;
åœ¨å…¶ä»–ä¹¦ç±ä¸­æˆ‘çœ‹åˆ°çš„ä½¿ç”¨ prometheus(æ™®ç½—ç±³ä¿®æ–¯),æ‰€ä»¥æˆ‘ä»¬å¯¹äºŒè€…éƒ½è¿›è¡Œä¸€ä¸ªæµ‹è¯•."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://LTXWorld.github.io/posts/"},{"@type":"ListItem","position":2,"name":"K3sEP12â€”â€”ç›‘æ§é›†ç¾¤çš„ä¸¤ç§æ–¹å¼","item":"https://LTXWorld.github.io/posts/038k3sep12%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"K3sEP12â€”â€”ç›‘æ§é›†ç¾¤çš„ä¸¤ç§æ–¹å¼","name":"K3sEP12â€”â€”ç›‘æ§é›†ç¾¤çš„ä¸¤ç§æ–¹å¼","description":"å¼•å­ ä¸ºäº†æ›´å¥½åœ°ç®¡ç†é›†ç¾¤,æˆ‘ä»¬æ‰“ç®—ä½¿ç”¨å·¥å…·ç›‘æ§é›†ç¾¤, k8s é¦–æ¨çš„æ˜¯ metric-server; åœ¨å…¶ä»–ä¹¦ç±ä¸­æˆ‘çœ‹åˆ°çš„ä½¿ç”¨ prometheus(æ™®ç½—ç±³ä¿®æ–¯),æ‰€ä»¥æˆ‘ä»¬å¯¹äºŒè€…éƒ½è¿›è¡Œä¸€ä¸ªæµ‹è¯•.\n","keywords":["K3s","RiscV","ç›‘æ§"],"articleBody":"å¼•å­ ä¸ºäº†æ›´å¥½åœ°ç®¡ç†é›†ç¾¤,æˆ‘ä»¬æ‰“ç®—ä½¿ç”¨å·¥å…·ç›‘æ§é›†ç¾¤, k8s é¦–æ¨çš„æ˜¯ metric-server; åœ¨å…¶ä»–ä¹¦ç±ä¸­æˆ‘çœ‹åˆ°çš„ä½¿ç”¨ prometheus(æ™®ç½—ç±³ä¿®æ–¯),æ‰€ä»¥æˆ‘ä»¬å¯¹äºŒè€…éƒ½è¿›è¡Œä¸€ä¸ªæµ‹è¯•.\nmetric-server ä»€ä¹ˆæ˜¯ metric-server Metrics Server collects resource metrics from Kubelets and exposes them in Kubernetes apiserver through Metrics API for use by Horizontal Pod Autoscaler and Vertical Pod Autoscaler. Metrics API can also be accessed by kubectl top, making it easier to debug autoscaling pipelines.\nå®ƒä¼šå»ä¸ kubelet äº¤äº’,ä½œä¸º apiserver çš„å¤–éƒ¨ api,å‘ kubelet çš„ /metrics/resource å‘èµ· HTTPS è¯·æ±‚;åŒæ—¶å…¶è¿˜æ”¯æŒ HPA è‡ªåŠ¨æ‰©ç¼©å®¹\nå¯ä»¥ä½¿ç”¨ kubectl get apiservices æŸ¥çœ‹å…¶ api çŠ¶æ€\nNAME SERVICE AVAILABLE AGE v1beta1.metrics.k8s.io kube-system/metrics-server False (MissingEndpoints) 3d22h å…·ä½“æ“ä½œ é¦–å…ˆ,metric-server åœ¨å…¶ release ç‰ˆæœ¬ä¸­å¹¶æ²¡æœ‰ riscv çš„ç‰ˆæœ¬,æ‰€ä»¥æˆ‘ä»¬å…ˆè¦è¿›è¡Œé€‚é…å·¥ä½œ. ä¸è¿‡å¥½åœ¨ä¹‹å‰çš„é‚£ä½å¤§ä½¬ä¹Ÿåšäº†ç›¸å…³çš„æ”¯æŒ,æ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä½¿ç”¨å®ƒçš„é•œåƒä½œä¸ºæˆ‘ä»¬çš„ç§æœ‰ä»“åº“é•œåƒ.\nä¹‹åå†™ä¸€ä¸ª yamlæ–‡ä»¶ ç”¨æ¥éƒ¨ç½² metric-server åˆ° server ä¸Š\n# metrics-server.yaml apiVersion: v1 kind: Namespace metadata: name: kube-system --- apiVersion: apps/v1 kind: Deployment metadata: name: metrics-server namespace: kube-system labels: k8s-app: metrics-server spec: replicas: 1 selector: matchLabels: k8s-app: metrics-server template: metadata: labels: k8s-app: metrics-server spec: containers: - name: metrics-server image: jimlt.bfsmlt.top/metrics-server:v0.7.2 # ç§æœ‰é•œåƒ imagePullPolicy: IfNotPresent args: - --cert-dir=/tmp - --secure-port=4443 - --kubelet-insecure-tls - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname ports: - containerPort: 4443 protocol: TCP --- apiVersion: v1 kind: Service metadata: name: metrics-server namespace: kube-system labels: k8s-app: metrics-server spec: selector: k8s-app: metrics-server ports: - port: 443 targetPort: 4443 è¿™é‡ŒåŒ…æ‹¬äº† Deployment å’Œå¯¹åº”çš„ Service,å¹¶ä¸”æˆ‘ä»¬ä½œä¸ºæµ‹è¯•æ²¡æœ‰ç”¨åˆ° tls --kubelet-insecure-tls\nå†™å¥½ä¹‹åè¿›è¡Œéƒ¨ç½² kubectl apply -f xxx.yaml\néƒ¨ç½²ç»“æŸå,æˆ‘ä»¬è¿›è¡Œæµ‹è¯• kubectl top nodes,å‘ç°æ­¤æœåŠ¡å¹¶æ²¡æœ‰å¯åŠ¨æˆåŠŸ.\næ’æŸ¥é—®é¢˜ æˆ‘ä»¬è‡ªç„¶åœ°å»æŸ¥çœ‹å®¹å™¨çš„çŠ¶æ€,å³ kubectl describe,å‘ç°é—®é¢˜æ‰€åœ¨\nReadiness probe failed: Get \"https://10.42.0.58:10250/readyz\": dial tcp 10.42.0.58:10250: connect: connection refused è¿™æ˜¯ä¸ªä»€ä¹ˆåœ°å€å‘¢?æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¹‹å‰ yaml æ–‡ä»¶ä¸­çš„è¿™æ®µä»£ç  --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname\nInternalIP: èŠ‚ç‚¹ Node åœ¨é›†ç¾¤å†…éƒ¨ç½‘ç»œä¸­çš„åœ°å€ ExternalIP: å…¬ç½‘ IP,ä¾›é›†ç¾¤å¤–éƒ¨è®¿é—® Hostname: èŠ‚ç‚¹çš„è®¡ç®—æœºåç§° è¿™äº›ä¸ PodIP ä¸åŒ,PodIP æ˜¯é›†ç¾¤ä½¿ç”¨ CNI åˆ†é…çš„,å…³äº CNI åœ¨ k3s ä¸­çš„çŸ¥è¯†,è¯·çœ‹è¿™ç¯‡æ–‡ç« .\næ‰€ä»¥,è¿™ä¸ªè¯·æ±‚å…¶å®æ˜¯å‘å¾€äº†æˆ‘çš„ server èŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ª Pod,æ‰€ä»¥è¿™ä¸ªå°±å¾ˆå¥‡æ€ªäº†,æŒ‰é“ç†æ¥è¯´åº”è¯¥å‘å¾€ InternalIP å³192.168.1.198 æ‰å¯¹\næ‰§è¡Œ kubectl get apiservices å¯ä»¥å‘ç° MissingEndpoints\nv1beta1.metrics.k8s.io kube-system/metrics-server False (MissingEndpoints) 3d22h ç›¸å…³çš„ issue å¯ä»¥æ‰¾åˆ°äº›è§£å†³åŠæ³•,æœ€å¤šçš„è¿˜æ˜¯æ·»åŠ  - --kubelet-insecure-tls,ä½†æ˜¯æˆ‘ä»¬å·²ç»æœ‰äº†ä¸æ˜¯å—?\nå¦‚æœç°åœ¨é‡åˆ°åŒæ ·é—®é¢˜çš„ä½ æ‰¾åˆ°äº†å…¶ä»–æ›´å¥½çš„ç›¸å…³é—®é¢˜æˆ–è€…è§£å†³æ–¹æ³•,è¯·åœ¨è¯„è®ºåŒºå‘ŠçŸ¥.\nå®˜æ–¹æ–‡æ¡£ä¸­çš„é—®é¢˜ stackoverflowä¸Šæœ‰å…³é—®é¢˜ æˆ‘ä»¬åœ¨ yaml é…ç½®ä¸­æ·»åŠ  HostNetwork\nspec: hostNetwork: true # âœ… æ·»åŠ  hostNetworkï¼Œé¿å… CNI ä¸­ 10250 è®¿é—®å¤±è´¥ dnsPolicy: ClusterFirstWithHostNet # âœ… æ­é… hostNetwork ä½¿ç”¨ ä¹‹åå†æ¬¡æŸ¥çœ‹å®¹å™¨çš„è¿è¡ŒçŠ¶æ€:\nReadiness probe failed: HTTP probe failed with statuscode: 404 é€šè¿‡æŸ¥çœ‹æ—¥å¿—å‘ç°:\nsudo kubectl logs -n kube-system metrics-server-6b8f575f5d-56jm8 I0518 11:31:43.086131 1 serving.go:374] Generated self-signed cert (/tmp/apiserver.crt, /tmp/apiserver.key) I0518 11:31:45.510186 1 handler.go:275] Adding GroupVersion metrics.k8s.io v1beta1 to ResourceManager I0518 11:31:45.658709 1 requestheader_controller.go:169] Starting RequestHeaderAuthRequestController I0518 11:31:45.658803 1 shared_informer.go:311] Waiting for caches to sync for RequestHeaderAuthRequestController I0518 11:31:45.659011 1 configmap_cafile_content.go:202] \"Starting controller\" name=\"client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file\" I0518 11:31:45.659138 1 shared_informer.go:311] Waiting for caches to sync for client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file I0518 11:31:45.659169 1 configmap_cafile_content.go:202] \"Starting controller\" name=\"client-ca::kube-system::extension-apiserver-authentication::client-ca-file\" I0518 11:31:45.659247 1 shared_informer.go:311] Waiting for caches to sync for client-ca::kube-system::extension-apiserver-authentication::client-ca-file I0518 11:31:45.660929 1 dynamic_serving_content.go:132] \"Starting controller\" name=\"serving-cert::/tmp/apiserver.crt::/tmp/apiserver.key\" I0518 11:31:45.662143 1 secure_serving.go:213] Serving securely on [::]:4443 I0518 11:31:45.662329 1 tlsconfig.go:240] \"Starting DynamicServingCertificateController\" I0518 11:31:45.759559 1 shared_informer.go:318] Caches are synced for client-ca::kube-system::extension-apiserver-authentication::client-ca-file I0518 11:31:45.759641 1 shared_informer.go:318] Caches are synced for client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file I0518 11:31:45.759584 1 shared_informer.go:318] Caches are synced for RequestHeaderAuthRequestController å…¶å¹¶æ²¡æœ‰ç›´æ¥æ˜¾ç¤ºä¸€äº›è®¿é—®åœ°å€å¤±è´¥çš„ä¿¡æ¯.\næ¥ç€æˆ‘ä»¬å°è¯• kubectl edit deployment -n kube-system metrics-serverä¿®æ”¹é…ç½® å°† livenessProbe å’Œ readinessProbe åŠå…¶æœ‰å…³é…ç½®åˆ é™¤ ç›¸å…³è§£å†³æ–¹æ¡ˆæ¥è‡ª CSDN\nreadinessProbe: httpGet: path: /readyz port: 4443 scheme: HTTPS initialDelaySeconds: 20 periodSeconds: 10 å†æ¥çœ‹çœ‹ Pod ç»“æœå¦‚ä½•\nkube-system metrics-server-6c8f74f4c4-fktpw 1/1 Running å±…ç„¶æˆåŠŸäº†,æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯:\nsudo kubectl top no NAME CPU(cores) CPU% MEMORY(bytes) MEMORY% agent197 40m 1% 774Mi 9% revyos-lpi4a 136m 3% 1502Mi 9% æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬åªéœ€è¦å»æ‰ readinessProbeå³å¯,ä¸ç”¨æ·»åŠ  NetWork ç­‰å­—æ®µåœ¨é…ç½®æ–‡ä»¶ä¸­. è¿™å¯¹æ•´ä½“çš„è¿è¡Œæ—¶æ²¡æœ‰å½±å“çš„,åªæ˜¯å»æ‰äº†å­˜æ´»æ¢é’ˆæ£€æµ‹æœºåˆ¶.\nProbeåŠå¯èƒ½åŸå›  è¿™äº› Probe æ˜¯æ¥è‡ªäº k3s çš„ç³»ç»Ÿæ¢é’ˆ\nReadiness Probe:æ£€æµ‹æŸä¸ªå®¹å™¨æ˜¯å¦å°±ç»ª(å°±æ˜¯æˆ‘ä»¬å¸¸è§çš„ Ready å­—æ®µ),æ˜¯å¦å¯ä»¥æ¥å—æµé‡,å¦‚æœæ²¡æœ‰å°±ä¸èƒ½åŠ å…¥åˆ° Service Liveness Probe:åˆ¤æ–­å®¹å™¨æ˜¯å¦â€œå¥åº·â€ï¼Œæœªé€šè¿‡æ¢é’ˆ â†’ è¢«é‡å¯å®¹å™¨ã€‚ Startup Probe:åˆ¤æ–­å®¹å™¨å¯åŠ¨æ˜¯å¦å®Œæˆï¼Œé…åˆå‰ä¸¤è€…é¿å…â€œå¯åŠ¨æœªå®Œæˆå°±è¢«æ¢æµ‹å¤±è´¥â€ã€‚ æ‰€ä»¥ç»“åˆä¹‹å‰çš„ä¸¤ç§å¤±è´¥æŠ¥é”™, https://10.42.0.58:10250/readyz,æ˜¯ metric-server è®¿é—® kubelet å®¹å™¨,å› ä¸º metrics-server é»˜è®¤ä¼šé€šè¿‡ kubelet API è·å–èŠ‚ç‚¹ã€å®¹å™¨ã€Pod çš„èµ„æºæŒ‡æ ‡æ•°æ®\nåæ¥è¿”å›404:\nå¯èƒ½metrics-server é•œåƒä¸­å¹¶æ²¡æœ‰æš´éœ² /readyz è¿™ä¸ª HTTP è·¯å¾„ æŸäº›ç‰ˆæœ¬åªæ”¯æŒ /healthz æˆ– / è·¯å¾„ prometheus prometheus åœ¨ k8s çš„é›†ç¾¤ç›‘æ§ä¸­ä¹Ÿæ˜¯ååˆ†å¸¸è§çš„å·¥å…·,å¯æŠ“å– æ‰€æœ‰ç»„ä»¶ã€åº”ç”¨ã€Exporter çš„ç»†ç²’åº¦æŒ‡æ ‡,å¹¶ä¸”å¯ä»¥åšåˆ°æŠ¥è­¦,å¯è§†åŒ–,é•¿æœŸæŒä¹…åŒ–ç­‰åŠŸèƒ½.\næ‰€ä»¥æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹åœ¨æˆ‘ä»¬çš„é›†ç¾¤ä¸­ä½¿ç”¨æƒ…å†µ.\næ“ä½œæµç¨‹ ä¸ metric-server ä¸åŒçš„æ˜¯,prometheus æ”¯æŒ riscv æ¶æ„,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨.\nåœ¨å®˜ç½‘ä¸‹è½½å¥½å®‰è£…åŒ…ä¼ åˆ°å¼€å‘æ¿ server èŠ‚ç‚¹ä¸Š,è¿›è¡Œè§£å‹,å¹¶å°†å¯æ‰§è¡Œæ–‡ä»¶å’Œé…ç½®æ–‡ä»¶éƒ½æ”¾åˆ°å¯¹åº”ç›®å½•ä¸­\nsudo cp ~/prometheus-2.53.4.linux-riscv64/prometheus /usr/local/bin/prometheus sudo cp ~/prometheus-2.53.4.linux-riscv64/prometheus.yml /etc/prometheus/prometheus.yml ä¸ºå…¶ç¼–å†™ service æ–‡ä»¶,äº¤ç”± systemd ç®¡ç†\n[Unit] Description=Prometheus Monitoring Wants=network-online.target After=network-online.target [Service] User=debian ExecStart=/usr/local/bin/prometheus \\ --config.file=/etc/prometheus/prometheus.yml \\ --storage.tsdb.path=/var/lib/prometheus \\ --web.listen-address=0.0.0.0:9090 \\ --web.enable-lifecycle Restart=on-failure [Install] WantedBy=multi-user.target è¿™é‡Œçš„ User å¯ä»¥é€‰æ‹©ä¸º prometheus ç‹¬ç«‹åˆ›å»ºä¸€ä¸ªç”¨æˆ·;æ•°æ®å­˜å‚¨åœ¨ /var/lib/prometheus ä¸‹\nåŒæ—¶åˆ›å»ºå¯¹åº”çš„ç›®å½•å¹¶ä¸ºå…¶èµ‹äºˆå¯¹åº”æƒé™.\nsudo mkdir -p /etc/prometheus /var/lib/prometheus sudo chown -R jimlt:jimlt /etc/prometheus /var/lib/prometheus é‡æ–°åŠ è½½ systemd å¹¶å¯åŠ¨\nsudo systemctl daemon-reexec sudo systemctl daemon-reload sudo systemctl enable prometheus sudo systemctl start prometheus éªŒè¯å…¶çŠ¶æ€:\nsudo systemctl status prometheus # prometheus.service - Prometheus Monitoring Loaded: loaded (/etc/systemd/system/prometheus.service; enabled; preset: enabled) Active: active (running) since Sun 2025-05-18 20:59:08 CST; 12min ago Invocation: a99f1274a13a4ae89ecb9726ece102a4 Main PID: 5337 (prometheus) Tasks: 10 (limit: 18020) Memory: 41.2M (peak: 41.9M) CPU: 5.667s CGroup: /system.slice/prometheus.service â””â”€5337 /usr/local/bin/prometheus --config.file=/etc/prometheus/prometheus.yml --storage.tsdb.path=/var/lib/prometheus --web.listen-address=0.0.0.0:9090 --web.enable-\u003e æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å»æµè§ˆå™¨ä¸­è¾“å…¥ localhost:9000 è®¿é—®å…¶ç›‘æ§é¡µé¢.\nå…³äºå…¶å®‰è£…éƒ¨ç½²æµç¨‹å°±å‘Šä¸€æ®µè½äº†,åç»­æˆ‘ä»¬å¯ä»¥åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  job,è®©å…¶ç›‘æ§é›†ç¾¤ä¸­çš„æ•°æ®,å…³äºå…¶åç»­çš„æ›´æ·±å…¥æ“ä½œ,è§ä»¥åçš„æ–‡ç« å§!\næ€»ç»“ æœ¬æ–‡å°è¯•äº† k3s é›†ç¾¤ä¸­ä¸¤ç§ç›‘æ§æ–¹æ¡ˆçš„å®ç°,å¹¶è§£å†³äº† metric-server è¿è¡Œè¿‡ç¨‹ä¸­çš„æ¢é’ˆé—®é¢˜.ä¸ºåç»­é›†ç¾¤çš„ç›‘æ§å¥ å®šäº†åŸºç¡€.\nè¿™é‡Œæ˜¯LTXï¼Œæ„Ÿè°¢æ‚¨é˜…è¯»è¿™ç¯‡åšå®¢ï¼Œäººç”Ÿæµ·æµ·ï¼Œå’Œè‡ªå·±å¯¹è¯ï¼Œåƒåªè´è¶çºµæ¨ªå››æµ·ã€‚\n","wordCount":"2008","inLanguage":"zh","image":"https://LTXWorld.github.io/images/papermod-cover.png","datePublished":"2025-05-18T18:29:58+08:00","dateModified":"2025-05-18T18:29:58+08:00","author":{"@type":"Person","name":"LTX"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://LTXWorld.github.io/posts/038k3sep12%E7%9B%91%E6%8E%A7%E9%9B%86%E7%BE%A4/"},"publisher":{"@type":"Organization","name":"LTX's Blog","logo":{"@type":"ImageObject","url":"https://LTXWorld.github.io/favicon.png"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://LTXWorld.github.io/ accesskey=h title="LTX's Blog (Alt + H)">LTX's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://LTXWorld.github.io/ title="LTX's Blog"><span>é¦–é¡µ</span></a></li><li><a href=https://LTXWorld.github.io/archives/ title=å½’æ¡£><span>å½’æ¡£</span></a></li><li><a href=https://LTXWorld.github.io/categories/ title=Categories><span>åˆ†ç±»</span></a></li><li><a href=https://LTXWorld.github.io/tags/ title=Tags><span>æ ‡ç­¾</span></a></li><li><a href=https://LTXWorld.github.io/search/ title=æœç´¢><span>æœç´¢</span></a></li><li><a href=https://LTXWorld.github.io/about/ title=åèŠ±å›­><span>å…³äº</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">K3sEP12â€”â€”ç›‘æ§é›†ç¾¤çš„ä¸¤ç§æ–¹å¼</h1><div class=post-meta><span title='2025-05-18 18:29:58 +0800 CST'>äº”æœˆ 18, 2025</span>&nbsp;Â·&nbsp;5 åˆ†é’Ÿ&nbsp;Â·&nbsp;LTX</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#%e5%bc%95%e5%ad%90 aria-label=å¼•å­>å¼•å­</a></li><li><a href=#metric-server aria-label=metric-server>metric-server</a><ul><li><a href=#%e4%bb%80%e4%b9%88%e6%98%af-metric-server aria-label="ä»€ä¹ˆæ˜¯ metric-server">ä»€ä¹ˆæ˜¯ metric-server</a></li><li><a href=#%e5%85%b7%e4%bd%93%e6%93%8d%e4%bd%9c aria-label=å…·ä½“æ“ä½œ>å…·ä½“æ“ä½œ</a></li><li><a href=#%e6%8e%92%e6%9f%a5%e9%97%ae%e9%a2%98 aria-label=æ’æŸ¥é—®é¢˜>æ’æŸ¥é—®é¢˜</a></li><li><a href=#probe%e5%8f%8a%e5%8f%af%e8%83%bd%e5%8e%9f%e5%9b%a0 aria-label=ProbeåŠå¯èƒ½åŸå› >ProbeåŠå¯èƒ½åŸå› </a></li></ul></li><li><a href=#prometheus aria-label=prometheus>prometheus</a><ul><li><a href=#%e6%93%8d%e4%bd%9c%e6%b5%81%e7%a8%8b aria-label=æ“ä½œæµç¨‹>æ“ä½œæµç¨‹</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=æ€»ç»“>æ€»ç»“</a></li></ul></div></details></div><div class=post-content><h2 id=å¼•å­>å¼•å­<a hidden class=anchor aria-hidden=true href=#å¼•å­>#</a></h2><p>ä¸ºäº†æ›´å¥½åœ°ç®¡ç†é›†ç¾¤,æˆ‘ä»¬æ‰“ç®—ä½¿ç”¨å·¥å…·ç›‘æ§é›†ç¾¤, k8s é¦–æ¨çš„æ˜¯ <a href=https://github.com/kubernetes-sigs/metrics-server>metric-server</a>;
åœ¨å…¶ä»–ä¹¦ç±ä¸­æˆ‘çœ‹åˆ°çš„ä½¿ç”¨ prometheus(æ™®ç½—ç±³ä¿®æ–¯),æ‰€ä»¥æˆ‘ä»¬å¯¹äºŒè€…éƒ½è¿›è¡Œä¸€ä¸ªæµ‹è¯•.</p><h2 id=metric-server>metric-server<a hidden class=anchor aria-hidden=true href=#metric-server>#</a></h2><h3 id=ä»€ä¹ˆæ˜¯-metric-server>ä»€ä¹ˆæ˜¯ metric-server<a hidden class=anchor aria-hidden=true href=#ä»€ä¹ˆæ˜¯-metric-server>#</a></h3><blockquote><p>Metrics Server collects resource metrics from Kubelets and exposes them in Kubernetes apiserver through Metrics API for use by Horizontal Pod Autoscaler and Vertical Pod Autoscaler. Metrics API can also be accessed by kubectl top, making it easier to debug autoscaling pipelines.</p></blockquote><p>å®ƒä¼šå»ä¸ kubelet äº¤äº’,ä½œä¸º apiserver çš„å¤–éƒ¨ api,å‘ kubelet çš„ /metrics/resource å‘èµ· HTTPS è¯·æ±‚;åŒæ—¶å…¶è¿˜æ”¯æŒ HPA è‡ªåŠ¨æ‰©ç¼©å®¹</p><p>å¯ä»¥ä½¿ç”¨ <code>kubectl get apiservices</code> æŸ¥çœ‹å…¶ api çŠ¶æ€</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>NAME                                   SERVICE                      AVAILABLE                  AGE
</span></span><span class=line><span class=cl>v1beta1.metrics.k8s.io                 kube-system/metrics-server   False <span class=o>(</span>MissingEndpoints<span class=o>)</span>   3d22h
</span></span></code></pre></div><h3 id=å…·ä½“æ“ä½œ>å…·ä½“æ“ä½œ<a hidden class=anchor aria-hidden=true href=#å…·ä½“æ“ä½œ>#</a></h3><p>é¦–å…ˆ,metric-server åœ¨å…¶ release ç‰ˆæœ¬ä¸­å¹¶æ²¡æœ‰ riscv çš„ç‰ˆæœ¬,æ‰€ä»¥æˆ‘ä»¬å…ˆè¦è¿›è¡Œé€‚é…å·¥ä½œ.
ä¸è¿‡å¥½åœ¨ä¹‹å‰çš„é‚£ä½å¤§ä½¬ä¹Ÿåšäº†ç›¸å…³çš„æ”¯æŒ,æ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä½¿ç”¨å®ƒçš„é•œåƒä½œä¸ºæˆ‘ä»¬çš„ç§æœ‰ä»“åº“é•œåƒ.</p><p>ä¹‹åå†™ä¸€ä¸ª yamlæ–‡ä»¶ ç”¨æ¥éƒ¨ç½² metric-server åˆ° server ä¸Š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=c># metrics-server.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>metrics-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>metrics-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>metrics-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>metrics-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>metrics-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>jimlt.bfsmlt.top/metrics-server:v0.7.2 </span><span class=w> </span><span class=c>#  ç§æœ‰é•œåƒ</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- --<span class=l>cert-dir=/tmp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- --<span class=l>secure-port=4443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- --<span class=l>kubelet-insecure-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- --<span class=l>kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>4443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>metrics-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>metrics-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>metrics-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>4443</span><span class=w>
</span></span></span></code></pre></div><p>è¿™é‡ŒåŒ…æ‹¬äº† Deployment å’Œå¯¹åº”çš„ Service,å¹¶ä¸”æˆ‘ä»¬ä½œä¸ºæµ‹è¯•æ²¡æœ‰ç”¨åˆ° tls <code>--kubelet-insecure-tls</code></p><p>å†™å¥½ä¹‹åè¿›è¡Œéƒ¨ç½² <code>kubectl apply -f xxx.yaml</code></p><p>éƒ¨ç½²ç»“æŸå,æˆ‘ä»¬è¿›è¡Œæµ‹è¯• <code>kubectl top nodes</code>,å‘ç°æ­¤æœåŠ¡å¹¶æ²¡æœ‰å¯åŠ¨æˆåŠŸ.</p><h3 id=æ’æŸ¥é—®é¢˜>æ’æŸ¥é—®é¢˜<a hidden class=anchor aria-hidden=true href=#æ’æŸ¥é—®é¢˜>#</a></h3><p>æˆ‘ä»¬è‡ªç„¶åœ°å»æŸ¥çœ‹å®¹å™¨çš„çŠ¶æ€,å³ <code>kubectl describe</code>,å‘ç°é—®é¢˜æ‰€åœ¨</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Readiness probe failed: Get <span class=s2>&#34;https://10.42.0.58:10250/readyz&#34;</span>: dial tcp 10.42.0.58:10250: connect: connection refused    
</span></span></code></pre></div><p>è¿™æ˜¯ä¸ªä»€ä¹ˆåœ°å€å‘¢?æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¹‹å‰ yaml æ–‡ä»¶ä¸­çš„è¿™æ®µä»£ç  <code>--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</code></p><ul><li>InternalIP: èŠ‚ç‚¹ Node åœ¨é›†ç¾¤å†…éƒ¨ç½‘ç»œä¸­çš„åœ°å€</li><li>ExternalIP: å…¬ç½‘ IP,ä¾›é›†ç¾¤å¤–éƒ¨è®¿é—®</li><li>Hostname: èŠ‚ç‚¹çš„è®¡ç®—æœºåç§°</li></ul><p>è¿™äº›ä¸ PodIP ä¸åŒ,PodIP æ˜¯é›†ç¾¤ä½¿ç”¨ CNI åˆ†é…çš„,å…³äº CNI åœ¨ k3s ä¸­çš„çŸ¥è¯†,è¯·çœ‹è¿™ç¯‡æ–‡ç« .</p><p>æ‰€ä»¥,è¿™ä¸ªè¯·æ±‚å…¶å®æ˜¯å‘å¾€äº†æˆ‘çš„ server èŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ª Pod,æ‰€ä»¥è¿™ä¸ªå°±å¾ˆå¥‡æ€ªäº†,æŒ‰é“ç†æ¥è¯´åº”è¯¥å‘å¾€ InternalIP å³192.168.1.198 æ‰å¯¹</p><p>æ‰§è¡Œ <code>kubectl get apiservices</code> å¯ä»¥å‘ç° MissingEndpoints</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>v1beta1.metrics.k8s.io                 kube-system/metrics-server   False <span class=o>(</span>MissingEndpoints<span class=o>)</span>   3d22h
</span></span></code></pre></div><p>ç›¸å…³çš„ issue å¯ä»¥æ‰¾åˆ°äº›è§£å†³åŠæ³•,æœ€å¤šçš„è¿˜æ˜¯æ·»åŠ  <code>- --kubelet-insecure-tls</code>,ä½†æ˜¯æˆ‘ä»¬å·²ç»æœ‰äº†ä¸æ˜¯å—?</p><p>å¦‚æœç°åœ¨é‡åˆ°åŒæ ·é—®é¢˜çš„ä½ æ‰¾åˆ°äº†å…¶ä»–æ›´å¥½çš„ç›¸å…³é—®é¢˜æˆ–è€…è§£å†³æ–¹æ³•,è¯·åœ¨è¯„è®ºåŒºå‘ŠçŸ¥.</p><ul><li><a href=https://github.com/kubernetes-sigs/metrics-server/blob/master/KNOWN_ISSUES.md#metrics-server-pod-failed-to-reach-running-status>å®˜æ–¹æ–‡æ¡£ä¸­çš„é—®é¢˜</a></li><li><a href=https://stackoverflow.com/questions/71843068/metrics-server-is-currently-unable-to-handle-the-request>stackoverflowä¸Šæœ‰å…³é—®é¢˜</a></li></ul><p>æˆ‘ä»¬åœ¨ yaml é…ç½®ä¸­æ·»åŠ  HostNetwork</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>      hostNetwork: <span class=nb>true</span>  <span class=c1># âœ… æ·»åŠ  hostNetworkï¼Œé¿å… CNI ä¸­ 10250 è®¿é—®å¤±è´¥</span>
</span></span><span class=line><span class=cl>      dnsPolicy: ClusterFirstWithHostNet  <span class=c1># âœ… æ­é… hostNetwork ä½¿ç”¨</span>
</span></span></code></pre></div><p>ä¹‹åå†æ¬¡æŸ¥çœ‹å®¹å™¨çš„è¿è¡ŒçŠ¶æ€:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Readiness probe failed: HTTP probe failed with statuscode: <span class=m>404</span>
</span></span></code></pre></div><p>é€šè¿‡æŸ¥çœ‹æ—¥å¿—å‘ç°:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo kubectl logs -n kube-system metrics-server-6b8f575f5d-56jm8
</span></span><span class=line><span class=cl>I0518 11:31:43.086131       <span class=m>1</span> serving.go:374<span class=o>]</span> Generated self-signed cert <span class=o>(</span>/tmp/apiserver.crt, /tmp/apiserver.key<span class=o>)</span>
</span></span><span class=line><span class=cl>I0518 11:31:45.510186       <span class=m>1</span> handler.go:275<span class=o>]</span> Adding GroupVersion metrics.k8s.io v1beta1 to ResourceManager
</span></span><span class=line><span class=cl>I0518 11:31:45.658709       <span class=m>1</span> requestheader_controller.go:169<span class=o>]</span> Starting RequestHeaderAuthRequestController
</span></span><span class=line><span class=cl>I0518 11:31:45.658803       <span class=m>1</span> shared_informer.go:311<span class=o>]</span> Waiting <span class=k>for</span> caches to sync <span class=k>for</span> RequestHeaderAuthRequestController
</span></span><span class=line><span class=cl>I0518 11:31:45.659011       <span class=m>1</span> configmap_cafile_content.go:202<span class=o>]</span> <span class=s2>&#34;Starting controller&#34;</span> <span class=nv>name</span><span class=o>=</span><span class=s2>&#34;client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file&#34;</span>
</span></span><span class=line><span class=cl>I0518 11:31:45.659138       <span class=m>1</span> shared_informer.go:311<span class=o>]</span> Waiting <span class=k>for</span> caches to sync <span class=k>for</span> client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file
</span></span><span class=line><span class=cl>I0518 11:31:45.659169       <span class=m>1</span> configmap_cafile_content.go:202<span class=o>]</span> <span class=s2>&#34;Starting controller&#34;</span> <span class=nv>name</span><span class=o>=</span><span class=s2>&#34;client-ca::kube-system::extension-apiserver-authentication::client-ca-file&#34;</span>
</span></span><span class=line><span class=cl>I0518 11:31:45.659247       <span class=m>1</span> shared_informer.go:311<span class=o>]</span> Waiting <span class=k>for</span> caches to sync <span class=k>for</span> client-ca::kube-system::extension-apiserver-authentication::client-ca-file
</span></span><span class=line><span class=cl>I0518 11:31:45.660929       <span class=m>1</span> dynamic_serving_content.go:132<span class=o>]</span> <span class=s2>&#34;Starting controller&#34;</span> <span class=nv>name</span><span class=o>=</span><span class=s2>&#34;serving-cert::/tmp/apiserver.crt::/tmp/apiserver.key&#34;</span>
</span></span><span class=line><span class=cl>I0518 11:31:45.662143       <span class=m>1</span> secure_serving.go:213<span class=o>]</span> Serving securely on <span class=o>[</span>::<span class=o>]</span>:4443
</span></span><span class=line><span class=cl>I0518 11:31:45.662329       <span class=m>1</span> tlsconfig.go:240<span class=o>]</span> <span class=s2>&#34;Starting DynamicServingCertificateController&#34;</span>
</span></span><span class=line><span class=cl>I0518 11:31:45.759559       <span class=m>1</span> shared_informer.go:318<span class=o>]</span> Caches are synced <span class=k>for</span> client-ca::kube-system::extension-apiserver-authentication::client-ca-file
</span></span><span class=line><span class=cl>I0518 11:31:45.759641       <span class=m>1</span> shared_informer.go:318<span class=o>]</span> Caches are synced <span class=k>for</span> client-ca::kube-system::extension-apiserver-authentication::requestheader-client-ca-file
</span></span><span class=line><span class=cl>I0518 11:31:45.759584       <span class=m>1</span> shared_informer.go:318<span class=o>]</span> Caches are synced <span class=k>for</span> RequestHeaderAuthRequestController
</span></span></code></pre></div><p>å…¶å¹¶æ²¡æœ‰ç›´æ¥æ˜¾ç¤ºä¸€äº›è®¿é—®åœ°å€å¤±è´¥çš„ä¿¡æ¯.</p><p>æ¥ç€æˆ‘ä»¬å°è¯• <code>kubectl edit deployment -n kube-system metrics-server</code>ä¿®æ”¹é…ç½®
å°† livenessProbe å’Œ readinessProbe åŠå…¶æœ‰å…³é…ç½®åˆ é™¤
ç›¸å…³è§£å†³æ–¹æ¡ˆæ¥è‡ª <a href=https://blog.csdn.net/qq_14997473/article/details/113521950>CSDN</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>readinessProbe:
</span></span><span class=line><span class=cl>  httpGet:
</span></span><span class=line><span class=cl>    path: /readyz
</span></span><span class=line><span class=cl>    port: <span class=m>4443</span>
</span></span><span class=line><span class=cl>    scheme: HTTPS
</span></span><span class=line><span class=cl>  initialDelaySeconds: <span class=m>20</span>
</span></span><span class=line><span class=cl>  periodSeconds: <span class=m>10</span>
</span></span></code></pre></div><p>å†æ¥çœ‹çœ‹ Pod ç»“æœå¦‚ä½•</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kube-system   metrics-server-6c8f74f4c4-fktpw           1/1     Running
</span></span></code></pre></div><p>å±…ç„¶æˆåŠŸäº†,æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo kubectl top no
</span></span><span class=line><span class=cl>NAME           CPU<span class=o>(</span>cores<span class=o>)</span>   CPU%   MEMORY<span class=o>(</span>bytes<span class=o>)</span>   MEMORY%   
</span></span><span class=line><span class=cl>agent197       40m          1%     774Mi           9%        
</span></span><span class=line><span class=cl>revyos-lpi4a   136m         3%     1502Mi          9%       
</span></span></code></pre></div><p>æ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬åªéœ€è¦å»æ‰ readinessProbeå³å¯,ä¸ç”¨æ·»åŠ  NetWork ç­‰å­—æ®µåœ¨é…ç½®æ–‡ä»¶ä¸­.
è¿™å¯¹æ•´ä½“çš„è¿è¡Œæ—¶æ²¡æœ‰å½±å“çš„,åªæ˜¯å»æ‰äº†å­˜æ´»æ¢é’ˆæ£€æµ‹æœºåˆ¶.</p><h3 id=probeåŠå¯èƒ½åŸå› >ProbeåŠå¯èƒ½åŸå› <a hidden class=anchor aria-hidden=true href=#probeåŠå¯èƒ½åŸå› >#</a></h3><p>è¿™äº› Probe æ˜¯æ¥è‡ªäº k3s çš„ç³»ç»Ÿæ¢é’ˆ</p><ul><li>Readiness Probe:æ£€æµ‹æŸä¸ªå®¹å™¨æ˜¯å¦å°±ç»ª(å°±æ˜¯æˆ‘ä»¬å¸¸è§çš„ Ready å­—æ®µ),æ˜¯å¦å¯ä»¥æ¥å—æµé‡,å¦‚æœæ²¡æœ‰å°±ä¸èƒ½åŠ å…¥åˆ° Service</li><li>Liveness Probe:åˆ¤æ–­å®¹å™¨æ˜¯å¦â€œå¥åº·â€ï¼Œæœªé€šè¿‡æ¢é’ˆ â†’ è¢«é‡å¯å®¹å™¨ã€‚</li><li>Startup Probe:åˆ¤æ–­å®¹å™¨å¯åŠ¨æ˜¯å¦å®Œæˆï¼Œé…åˆå‰ä¸¤è€…é¿å…â€œå¯åŠ¨æœªå®Œæˆå°±è¢«æ¢æµ‹å¤±è´¥â€ã€‚</li></ul><p>æ‰€ä»¥ç»“åˆä¹‹å‰çš„ä¸¤ç§å¤±è´¥æŠ¥é”™, <code>https://10.42.0.58:10250/readyz</code>,æ˜¯ metric-server è®¿é—® kubelet å®¹å™¨,å› ä¸º metrics-server é»˜è®¤ä¼šé€šè¿‡ kubelet API è·å–èŠ‚ç‚¹ã€å®¹å™¨ã€Pod çš„èµ„æºæŒ‡æ ‡æ•°æ®</p><p>åæ¥è¿”å›404:</p><ul><li>å¯èƒ½metrics-server é•œåƒä¸­å¹¶æ²¡æœ‰æš´éœ² /readyz è¿™ä¸ª HTTP è·¯å¾„</li><li>æŸäº›ç‰ˆæœ¬åªæ”¯æŒ /healthz æˆ– / è·¯å¾„</li></ul><h2 id=prometheus>prometheus<a hidden class=anchor aria-hidden=true href=#prometheus>#</a></h2><p>prometheus åœ¨ k8s çš„é›†ç¾¤ç›‘æ§ä¸­ä¹Ÿæ˜¯ååˆ†å¸¸è§çš„å·¥å…·,å¯æŠ“å– æ‰€æœ‰ç»„ä»¶ã€åº”ç”¨ã€Exporter çš„ç»†ç²’åº¦æŒ‡æ ‡,å¹¶ä¸”å¯ä»¥åšåˆ°æŠ¥è­¦,å¯è§†åŒ–,é•¿æœŸæŒä¹…åŒ–ç­‰åŠŸèƒ½.</p><p>æ‰€ä»¥æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹åœ¨æˆ‘ä»¬çš„é›†ç¾¤ä¸­ä½¿ç”¨æƒ…å†µ.</p><h3 id=æ“ä½œæµç¨‹>æ“ä½œæµç¨‹<a hidden class=anchor aria-hidden=true href=#æ“ä½œæµç¨‹>#</a></h3><p>ä¸ metric-server ä¸åŒçš„æ˜¯,prometheus æ”¯æŒ riscv æ¶æ„,æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨.</p><p>åœ¨<a href=https://prometheus.io/download>å®˜ç½‘</a>ä¸‹è½½å¥½å®‰è£…åŒ…ä¼ åˆ°å¼€å‘æ¿ server èŠ‚ç‚¹ä¸Š,è¿›è¡Œè§£å‹,å¹¶å°†å¯æ‰§è¡Œæ–‡ä»¶å’Œé…ç½®æ–‡ä»¶éƒ½æ”¾åˆ°å¯¹åº”ç›®å½•ä¸­</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo cp ~/prometheus-2.53.4.linux-riscv64/prometheus /usr/local/bin/prometheus
</span></span><span class=line><span class=cl>sudo cp ~/prometheus-2.53.4.linux-riscv64/prometheus.yml /etc/prometheus/prometheus.yml
</span></span></code></pre></div><p>ä¸ºå…¶ç¼–å†™ service æ–‡ä»¶,äº¤ç”± systemd ç®¡ç†</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>Description</span><span class=o>=</span>Prometheus Monitoring
</span></span><span class=line><span class=cl><span class=nv>Wants</span><span class=o>=</span>network-online.target
</span></span><span class=line><span class=cl><span class=nv>After</span><span class=o>=</span>network-online.target
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>User</span><span class=o>=</span>debian 
</span></span><span class=line><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>/usr/local/bin/prometheus <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --config.file<span class=o>=</span>/etc/prometheus/prometheus.yml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --storage.tsdb.path<span class=o>=</span>/var/lib/prometheus <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --web.listen-address<span class=o>=</span>0.0.0.0:9090 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --web.enable-lifecycle
</span></span><span class=line><span class=cl><span class=nv>Restart</span><span class=o>=</span>on-failure
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>multi-user.target
</span></span></code></pre></div><p>è¿™é‡Œçš„ User å¯ä»¥é€‰æ‹©ä¸º prometheus ç‹¬ç«‹åˆ›å»ºä¸€ä¸ªç”¨æˆ·;æ•°æ®å­˜å‚¨åœ¨ <code>/var/lib/prometheus</code> ä¸‹</p><p>åŒæ—¶åˆ›å»ºå¯¹åº”çš„ç›®å½•å¹¶ä¸ºå…¶èµ‹äºˆå¯¹åº”æƒé™.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo mkdir -p /etc/prometheus /var/lib/prometheus
</span></span><span class=line><span class=cl>sudo chown -R jimlt:jimlt /etc/prometheus /var/lib/prometheus
</span></span></code></pre></div><p>é‡æ–°åŠ è½½ systemd å¹¶å¯åŠ¨</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl daemon-reexec
</span></span><span class=line><span class=cl>sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> prometheus
</span></span><span class=line><span class=cl>sudo systemctl start prometheus
</span></span></code></pre></div><p>éªŒè¯å…¶çŠ¶æ€:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl status prometheus
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl>prometheus.service - Prometheus Monitoring
</span></span><span class=line><span class=cl>     Loaded: loaded <span class=o>(</span>/etc/systemd/system/prometheus.service<span class=p>;</span> enabled<span class=p>;</span> preset: enabled<span class=o>)</span>
</span></span><span class=line><span class=cl>     Active: active <span class=o>(</span>running<span class=o>)</span> since Sun 2025-05-18 20:59:08 CST<span class=p>;</span> 12min ago
</span></span><span class=line><span class=cl> Invocation: a99f1274a13a4ae89ecb9726ece102a4
</span></span><span class=line><span class=cl>   Main PID: <span class=m>5337</span> <span class=o>(</span>prometheus<span class=o>)</span>
</span></span><span class=line><span class=cl>      Tasks: <span class=m>10</span> <span class=o>(</span>limit: 18020<span class=o>)</span>
</span></span><span class=line><span class=cl>     Memory: 41.2M <span class=o>(</span>peak: 41.9M<span class=o>)</span>
</span></span><span class=line><span class=cl>        CPU: 5.667s
</span></span><span class=line><span class=cl>     CGroup: /system.slice/prometheus.service
</span></span><span class=line><span class=cl>             â””â”€5337 /usr/local/bin/prometheus --config.file<span class=o>=</span>/etc/prometheus/prometheus.yml --storage.tsdb.path<span class=o>=</span>/var/lib/prometheus --web.listen-address<span class=o>=</span>0.0.0.0:9090 --web.enable-&gt;
</span></span></code></pre></div><p>æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥å»æµè§ˆå™¨ä¸­è¾“å…¥ <code>localhost:9000</code> è®¿é—®å…¶ç›‘æ§é¡µé¢.</p><p>å…³äºå…¶å®‰è£…éƒ¨ç½²æµç¨‹å°±å‘Šä¸€æ®µè½äº†,åç»­æˆ‘ä»¬å¯ä»¥åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  job,è®©å…¶ç›‘æ§é›†ç¾¤ä¸­çš„æ•°æ®,å…³äºå…¶åç»­çš„æ›´æ·±å…¥æ“ä½œ,è§ä»¥åçš„æ–‡ç« å§!</p><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2><p>æœ¬æ–‡å°è¯•äº† k3s é›†ç¾¤ä¸­ä¸¤ç§ç›‘æ§æ–¹æ¡ˆçš„å®ç°,å¹¶è§£å†³äº† metric-server è¿è¡Œè¿‡ç¨‹ä¸­çš„æ¢é’ˆé—®é¢˜.ä¸ºåç»­é›†ç¾¤çš„ç›‘æ§å¥ å®šäº†åŸºç¡€.</p><p><strong>è¿™é‡Œæ˜¯LTXï¼Œæ„Ÿè°¢æ‚¨é˜…è¯»è¿™ç¯‡åšå®¢ï¼Œäººç”Ÿæµ·æµ·ï¼Œå’Œè‡ªå·±å¯¹è¯ï¼Œåƒåªè´è¶çºµæ¨ªå››æµ·ã€‚</strong></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://LTXWorld.github.io/tags/k3s/>K3s</a></li><li><a href=https://LTXWorld.github.io/tags/riscv/>RiscV</a></li><li><a href=https://LTXWorld.github.io/tags/%E7%9B%91%E6%8E%A7/>ç›‘æ§</a></li></ul><nav class=paginav><a class=prev href=https://LTXWorld.github.io/posts/039mit6.824lab1/><span class=title>Â« ä¸Šä¸€é¡µ</span><br><span>Mit6.824Lab1æµç¨‹æ¢³ç†</span>
</a><a class=next href=https://LTXWorld.github.io/posts/037%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9Cping%E5%91%BD%E4%BB%A4/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span>å…´è¶£å…«è‚¡ä¹‹è®¡ç®—æœºç½‘ç»œEP03â€”â€”Pingå‘½ä»¤</span></a></nav></footer><div id=tw-comment></div><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="light"?"light":"dark",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"LTXWorld/LTXWorld.github.io","data-repo-id":"R_kgDONODUuA","data-category":"Announcements","data-category-id":"DIC_kwDONODUuM4CkMUw","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":getStoredTheme(),"data-lang":"zh-CN","data-loading":"lazy",crossorigin:"anonymous"},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#tw-comment").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span><a href=https://LTXWorld.github.io/>Â©2025 LTX&rsquo;s Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><div class=ltx-music-player id=ltx-music-player role=group aria-label=èƒŒæ™¯éŸ³ä¹æ’­æ”¾å™¨><audio id=ltx-music-audio preload=metadata></audio><div class=ltx-drag-handle data-role=drag-handle title=ä¸Šä¸‹æ‹–åŠ¨è°ƒæ•´ä½ç½®></div><div class=ltx-music-header><div class=ltx-music-visual><div class=ltx-disc data-role=disc aria-hidden=true><img data-role=cover alt loading=lazy decoding=async><div class=ltx-disc-center></div></div></div><div class=ltx-music-meta><span class=ltx-music-title data-role=title></span>
<span class=ltx-music-artist data-role=artist></span></div><button type=button class=ltx-music-hide data-action=collapse aria-label=éšè—æ’­æ”¾å™¨>&#215;</button></div><div class=ltx-music-progress data-role=progress aria-label=è¿›åº¦æ¡ role=slider><div class=ltx-music-progress-fill data-role=progress-fill></div></div><div class=ltx-music-time><span data-role=current>0:00</span>
<span data-role=total>--:--</span></div><div class=ltx-music-controls><button type=button data-action=prev aria-label=ä¸Šä¸€é¦–>â®</button>
<button type=button data-action=toggle aria-label=æ’­æ”¾æˆ–æš‚åœ>
<span data-icon=play>â–¶</span>
<span data-icon=pause>â¸</span>
</button>
<button type=button data-action=next aria-label=ä¸‹ä¸€é¦–>â­</button>
<button type=button data-action=mute aria-label=é™éŸ³æˆ–å–æ¶ˆé™éŸ³>
<span data-icon=unmuted>ğŸ”Š</span>
<span data-icon=muted>ğŸ”‡</span></button></div><div class=ltx-autoplay-tip data-role=tip aria-live=polite></div></div><button type=button class=ltx-music-fab id=ltx-music-fab aria-label=æ˜¾ç¤ºéŸ³ä¹æ’­æ”¾å™¨>&#9835;</button>
<script>window.LTX_MUSIC_CONFIG={autoplay:!0,defaultCover:"",loopPlaylist:!0,startVolume:.6,tracks:[{artist:"ç‹åŠ›å®",file:"/audio/02 - ä¾ç„¶çˆ±ä½ .mp3",title:"ä¾ç„¶çˆ±ä½ "},{artist:"ç‹åŠ›å®",file:"/audio/05 - æ”¹å˜è‡ªå·±.mp3",title:"æ”¹å˜è‡ªå·±"},{artist:"ç‹åŠ›å®",file:"/audio/11 - çˆ±é”™.mp3",title:"çˆ±é”™"}]},function(){const a=window.LTX_MUSIC_CONFIG||{};if(!a.tracks||!a.tracks.length)return;const e=document.getElementById("ltx-music-player"),t=e.querySelector("audio"),x=e.querySelector('[data-role="title"]'),O=e.querySelector('[data-role="artist"]'),b=e.querySelector('[data-role="progress"]'),A=e.querySelector('[data-role="progress-fill"]'),F=e.querySelector('[data-role="current"]'),M=e.querySelector('[data-role="total"]'),c=e.querySelector('[data-role="tip"]'),r=e.querySelector('[data-role="cover"]'),S=e.querySelector('[data-action="toggle"]'),y=e.querySelector('[data-action="prev"]'),k=e.querySelector('[data-action="next"]'),E=e.querySelector('[data-action="mute"]'),g=e.querySelector('[data-action="collapse"]'),i=e.querySelector('[data-role="drag-handle"]'),o=document.getElementById("ltx-music-fab"),f=(e,t,n)=>Math.min(Math.max(e,t),n),j=e=>{if(!Number.isFinite(e))return"--:--";const t=Math.floor(e/60),n=Math.floor(e%60);return`${String(t).padStart(1,"0")}:${String(n).padStart(2,"0")}`},C=-120,_=220,w=180,s={active:!1,startY:0,startOffset:0,pointerId:null},n={index:0,tracks:a.tracks,autoplay:a.autoplay!==!1,loopPlaylist:a.loopPlaylist!==!1,offset:0,collapsed:!1},h=t=>{n.offset=f(t,C,_),e.style.setProperty("--ltx-offset",`${n.offset}px`)},l=t=>{const s=Boolean(t);n.collapsed=s,e.classList.toggle("ltx-collapsed",s),s?(e.classList.remove("ltx-dragging"),n.offset=0,e.style.removeProperty("--ltx-offset"),o&&(o.classList.add("ltx-visible"),o.setAttribute("aria-hidden","false"),o.tabIndex=0)):(h(0),o&&(o.classList.remove("ltx-visible"),o.setAttribute("aria-hidden","true"),o.tabIndex=-1))},m=()=>{const n=t.muted||t.volume===0;e.classList.toggle("ltx-muted",n)};t.volume=f(a.startVolume??.6,0,1),m(),l(!1);const d=()=>{const e=t.duration||0,n=t.currentTime||0,s=e?n/e*100:0;A.style.width=`${s}%`,F.textContent=j(n),M.textContent=j(e)},u=(s,o={})=>{const l=n.tracks.length;n.index=(s%l+l)%l;const i=n.tracks[n.index];if(!i||!i.file){console.warn("LTX music player: éŸ³é¢‘æ–‡ä»¶ç¼ºå¤±",i),c.textContent="éŸ³é¢‘æ–‡ä»¶ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥é…ç½®";return}const u=i.cover||a.defaultCover||"";r&&(u?(r.src=u,r.alt=i.title?`${i.title} å°é¢`:"éŸ³ä¹å°é¢",e.classList.add("ltx-has-cover")):(r.removeAttribute("src"),r.alt="",e.classList.remove("ltx-has-cover"))),x.textContent=i.title||`Track ${n.index+1}`,O.textContent=i.artist||"",t.src=i.file,e.dataset.trackIndex=n.index,c.textContent="",e.classList.remove("ltx-autoplay-blocked"),d(),o.play&&p()},p=()=>{t.play().then(()=>{e.classList.remove("ltx-autoplay-blocked"),c.textContent=""}).catch(()=>{e.classList.add("ltx-autoplay-blocked"),c.textContent="æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨æ’­æ”¾ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®"})},v=(e=!1)=>{const o=!t.paused||e,s=n.index+1;if(s>=n.tracks.length&&!n.loopPlaylist){t.currentTime=t.duration||0,t.pause();return}u(s,{play:o})},T=()=>{const e=!t.paused;u(n.index-1,{play:e})};if(g&&g.addEventListener("click",()=>l(!0)),o&&(o.addEventListener("click",()=>l(!1)),o.setAttribute("aria-hidden","true"),o.tabIndex=-1),i){i.style.touchAction="none",i.addEventListener("pointerdown",t=>{if(n.collapsed)return;if(s.active=!0,s.pointerId=t.pointerId,s.startY=t.clientY,s.startOffset=n.offset,i.setPointerCapture)try{i.setPointerCapture(t.pointerId)}catch{}e.classList.add("ltx-dragging")}),i.addEventListener("pointermove",e=>{if(!s.active)return;const t=e.clientY-s.startY;h(s.startOffset+t)});const t=()=>{if(!s.active)return;if(s.pointerId!==null&&i.releasePointerCapture)try{i.releasePointerCapture(s.pointerId)}catch{}s.active=!1,s.pointerId=null,e.classList.remove("ltx-dragging"),n.offset>w?l(!0):h(n.offset)};["pointerup","pointercancel"].forEach(e=>{i.addEventListener(e,t)}),i.addEventListener("pointerleave",()=>{if(!s.active)return;t()})}S.addEventListener("click",()=>{t.paused?p():t.pause()}),y.addEventListener("click",T),k.addEventListener("click",()=>v(!1)),E.addEventListener("click",()=>{t.muted=!t.muted,m()}),b.addEventListener("click",e=>{const n=b.getBoundingClientRect(),s=f((e.clientX-n.left)/n.width,0,1);Number.isFinite(t.duration)&&(t.currentTime=s*t.duration)}),t.addEventListener("timeupdate",d),t.addEventListener("loadedmetadata",d),t.addEventListener("play",()=>{e.classList.add("ltx-playing"),e.classList.remove("ltx-autoplay-blocked"),c.textContent=""}),t.addEventListener("pause",()=>{e.classList.remove("ltx-playing")}),t.addEventListener("ended",()=>{v(!0)}),t.addEventListener("volumechange",m),u(0,{play:n.autoplay})}()</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>